@model GameCore.Core.ViewModels.ChatViewModel
@{
    ViewData["Title"] = "èŠå¤©";
    ViewData["ActivePage"] = "Chat";
}

<div class="container-fluid">
    <!-- é é¢æ¨™é¡Œ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="fas fa-comments text-primary"></i>
                        èŠå¤©
                    </h1>
                    <p class="text-muted mb-0">èˆ‡å…¶ä»–ç©å®¶èŠå¤©äº¤æµ</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" onclick="createChatRoom()">
                        <i class="fas fa-plus"></i> å‰µå»ºèŠå¤©å®¤
                    </button>
                    <button class="btn btn-outline-primary" onclick="startPrivateChat()">
                        <i class="fas fa-user-plus"></i> é–‹å§‹ç§èŠ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- å·¦å´ï¼šèŠå¤©å®¤åˆ—è¡¨å’Œç§èŠåˆ—è¡¨ -->
        <div class="col-lg-4 mb-4">
            <!-- èŠå¤©å®¤åˆ—è¡¨ -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-users"></i>
                        èŠå¤©å®¤
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="chat-rooms-list">
                        @if (Model?.ChatRooms != null && Model.ChatRooms.Any())
                        {
                            @foreach (var room in Model.ChatRooms)
                            {
                                <div class="chat-room-item p-3 border-bottom" 
                                     onclick="selectChatRoom(@room.Id, '@room.Name', '@room.Type')"
                                     data-room-id="@room.Id">
                                    <div class="d-flex align-items-center">
                                        <div class="room-avatar me-3">
                                            @if (room.Type == "Public")
                                            {
                                                <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                    <i class="fas fa-users text-white"></i>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="rounded-circle bg-success d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                    <i class="fas fa-lock text-white"></i>
                                                </div>
                                            }
                                        </div>
                                        <div class="room-info flex-grow-1">
                                            <h6 class="mb-1">@room.Name</h6>
                                            <small class="text-muted">
                                                @room.MemberCount ä½æˆå“¡
                                                @if (room.LastMessageTime.HasValue)
                                                {
                                                    <span class="ms-2">â€¢ @room.LastMessageTime.Value.ToString("MM/dd HH:mm")</span>
                                                }
                                            </small>
                                        </div>
                                        @if (room.UnreadCount > 0)
                                        {
                                            <div class="unread-badge">
                                                <span class="badge bg-danger">@room.UnreadCount</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center py-4">
                                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted">ç›®å‰æ²’æœ‰èŠå¤©å®¤</h6>
                                <p class="text-muted">å‰µå»ºä¸€å€‹èŠå¤©å®¤é–‹å§‹èŠå¤©å§ï¼</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- ç§èŠåˆ—è¡¨ -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user-friends"></i>
                        ç§èŠ
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="private-chats-list">
                        @if (Model?.PrivateChats != null && Model.PrivateChats.Any())
                        {
                            @foreach (var chat in Model.PrivateChats)
                            {
                                <div class="private-chat-item p-3 border-bottom" 
                                     onclick="selectPrivateChat(@chat.Id, '@chat.OtherUser?.Username', @chat.OtherUser?.Id)"
                                     data-chat-id="@chat.Id">
                                    <div class="d-flex align-items-center">
                                        <div class="user-avatar me-3">
                                            @if (!string.IsNullOrEmpty(chat.OtherUser?.Avatar))
                                            {
                                                <img src="@chat.OtherUser.Avatar" class="rounded-circle" width="40" height="40" alt="é ­åƒ">
                                            }
                                            else
                                            {
                                                <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                    <i class="fas fa-user text-white"></i>
                                                </div>
                                            }
                                        </div>
                                        <div class="user-info flex-grow-1">
                                            <h6 class="mb-1">@chat.OtherUser?.Username</h6>
                                            <small class="text-muted">
                                                @if (chat.LastMessageTime.HasValue)
                                                {
                                                    <span>@chat.LastMessageTime.Value.ToString("MM/dd HH:mm")</span>
                                                }
                                                else
                                                {
                                                    <span>å°šæœªé–‹å§‹èŠå¤©</span>
                                                }
                                            </small>
                                        </div>
                                        @if (chat.UnreadCount > 0)
                                        {
                                            <div class="unread-badge">
                                                <span class="badge bg-danger">@chat.UnreadCount</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center py-4">
                                <i class="fas fa-user-friends fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted">ç›®å‰æ²’æœ‰ç§èŠ</h6>
                                <p class="text-muted">é–‹å§‹èˆ‡å…¶ä»–ç©å®¶ç§èŠå§ï¼</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- å³å´ï¼šèŠå¤©ä»‹é¢ -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0" id="chatTitle">
                                <i class="fas fa-comments"></i>
                                é¸æ“‡èŠå¤©å®¤æˆ–ç§èŠé–‹å§‹èŠå¤©
                            </h5>
                            <small class="text-muted" id="chatSubtitle"></small>
                        </div>
                        <div class="chat-actions" id="chatActions" style="display: none;">
                            <button class="btn btn-sm btn-outline-secondary me-2" onclick="showChatInfo()">
                                <i class="fas fa-info-circle"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="leaveChat()">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- èŠå¤©å€åŸŸ -->
                    <div class="chat-area" id="chatArea">
                        <div class="text-center py-5">
                            <i class="fas fa-comments fa-4x text-muted mb-3"></i>
                            <h5 class="text-muted">æ­¡è¿ä¾†åˆ°èŠå¤©ç³»çµ±</h5>
                            <p class="text-muted">é¸æ“‡å·¦å´çš„èŠå¤©å®¤æˆ–ç§èŠé–‹å§‹èŠå¤©</p>
                        </div>
                    </div>

                    <!-- è¼¸å…¥å€åŸŸ -->
                    <div class="chat-input-area" id="chatInputArea" style="display: none;">
                        <div class="p-3 border-top">
                            <div class="d-flex align-items-end">
                                <div class="flex-grow-1 me-2">
                                    <textarea class="form-control" id="messageInput" rows="2" 
                                              placeholder="è¼¸å…¥è¨Šæ¯..." maxlength="1000"></textarea>
                                    <div class="form-text text-end">
                                        <span id="charCount">0</span>/1000
                                    </div>
                                </div>
                                <div class="d-flex flex-column">
                                    <button class="btn btn-primary mb-2" onclick="sendMessage()">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="insertEmoji('ğŸ˜Š')">
                                        ğŸ˜Š
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å‰µå»ºèŠå¤©å®¤ Modal -->
<div class="modal fade" id="createChatRoomModal" tabindex="-1" aria-labelledby="createChatRoomModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createChatRoomModalLabel">
                    <i class="fas fa-plus"></i> å‰µå»ºèŠå¤©å®¤
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createChatRoomForm">
                    <div class="mb-3">
                        <label for="roomName" class="form-label">èŠå¤©å®¤åç¨± <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="roomName" name="Name" required maxlength="50">
                    </div>
                    <div class="mb-3">
                        <label for="roomDescription" class="form-label">æè¿°</label>
                        <textarea class="form-control" id="roomDescription" name="Description" rows="3" maxlength="200"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="roomType" class="form-label">é¡å‹</label>
                        <select class="form-select" id="roomType" name="Type">
                            <option value="Public">å…¬é–‹</option>
                            <option value="Private">ç§å¯†</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="roomMembers" class="form-label">é‚€è«‹æˆå“¡</label>
                        <input type="text" class="form-control" id="roomMembers" name="MemberIds" 
                               placeholder="è¼¸å…¥ç”¨æˆ¶åï¼Œç”¨é€—è™Ÿåˆ†éš”">
                        <div class="form-text">ç•™ç©ºå‰‡åªé‚€è«‹è‡ªå·±</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="submitCreateChatRoom()">å‰µå»º</button>
            </div>
        </div>
    </div>
</div>

<!-- é–‹å§‹ç§èŠ Modal -->
<div class="modal fade" id="startPrivateChatModal" tabindex="-1" aria-labelledby="startPrivateChatModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="startPrivateChatModalLabel">
                    <i class="fas fa-user-plus"></i> é–‹å§‹ç§èŠ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="startPrivateChatForm">
                    <div class="mb-3">
                        <label for="targetUsername" class="form-label">ç›®æ¨™ç”¨æˆ¶å <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="targetUsername" name="Username" required>
                        <div class="form-text">è¼¸å…¥è¦é–‹å§‹ç§èŠçš„ç”¨æˆ¶å</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="submitStartPrivateChat()">é–‹å§‹èŠå¤©</button>
            </div>
        </div>
    </div>
</div>

<!-- èŠå¤©å®¤è³‡è¨Š Modal -->
<div class="modal fade" id="chatInfoModal" tabindex="-1" aria-labelledby="chatInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chatInfoModalLabel">
                    <i class="fas fa-info-circle"></i> èŠå¤©å®¤è³‡è¨Š
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="chatInfoContent">
                <!-- å‹•æ…‹å…§å®¹ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .chat-room-item, .private-chat-item {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .chat-room-item:hover, .private-chat-item:hover {
            background-color: #f8f9fc;
        }

        .chat-room-item.active, .private-chat-item.active {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .chat-area {
            height: 400px;
            overflow-y: auto;
            padding: 1rem;
        }

        .chat-input-area {
            border-top: 1px solid #e3e6f0;
        }

        .message-item {
            margin-bottom: 1rem;
        }

        .message-content {
            max-width: 70%;
            padding: 0.75rem;
            border-radius: 1rem;
            word-wrap: break-word;
        }

        .message-own {
            background-color: #007bff;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }

        .message-other {
            background-color: #f8f9fc;
            color: #495057;
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
        }

        .message-time {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        .unread-badge {
            position: relative;
        }

        .unread-badge .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 0.7rem;
        }

        .card-header {
            background-color: #f8f9fc;
            border-bottom: 1px solid #e3e6f0;
        }

        .btn-sm {
            font-size: 0.8rem;
            padding: 0.375rem 0.5rem;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 991.98px) {
            .chat-area {
                height: 300px;
            }
        }
    </style>
}

@section Scripts {
    <script>
        let currentChatId = null;
        let currentChatType = null; // 'room' æˆ– 'private'
        let messagePolling = null;

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è¨Šæ¯è¼¸å…¥æ¡†å­—å…ƒè¨ˆæ•¸
            document.getElementById('messageInput').addEventListener('input', function() {
                const charCount = this.value.length;
                document.getElementById('charCount').textContent = charCount;
            });

            // è¨Šæ¯è¼¸å…¥æ¡† Enter éµç™¼é€
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });

        // é¸æ“‡èŠå¤©å®¤
        function selectChatRoom(roomId, roomName, roomType) {
            // ç§»é™¤å…¶ä»–é …ç›®çš„ active ç‹€æ…‹
            document.querySelectorAll('.chat-room-item, .private-chat-item').forEach(item => {
                item.classList.remove('active');
            });

            // æ·»åŠ ç•¶å‰é …ç›®çš„ active ç‹€æ…‹
            event.currentTarget.classList.add('active');

            currentChatId = roomId;
            currentChatType = 'room';

            // æ›´æ–°æ¨™é¡Œ
            document.getElementById('chatTitle').innerHTML = `<i class="fas fa-users"></i> ${roomName}`;
            document.getElementById('chatSubtitle').textContent = `${roomType} èŠå¤©å®¤`;
            document.getElementById('chatActions').style.display = 'block';
            document.getElementById('chatInputArea').style.display = 'block';

            // è¼‰å…¥èŠå¤©è¨˜éŒ„
            loadChatHistory(roomId, 'room');

            // é–‹å§‹è¼ªè©¢æ–°è¨Šæ¯
            startMessagePolling(roomId, 'room');
        }

        // é¸æ“‡ç§èŠ
        function selectPrivateChat(chatId, username, userId) {
            // ç§»é™¤å…¶ä»–é …ç›®çš„ active ç‹€æ…‹
            document.querySelectorAll('.chat-room-item, .private-chat-item').forEach(item => {
                item.classList.remove('active');
            });

            // æ·»åŠ ç•¶å‰é …ç›®çš„ active ç‹€æ…‹
            event.currentTarget.classList.add('active');

            currentChatId = chatId;
            currentChatType = 'private';

            // æ›´æ–°æ¨™é¡Œ
            document.getElementById('chatTitle').innerHTML = `<i class="fas fa-user-friends"></i> ${username}`;
            document.getElementById('chatSubtitle').textContent = 'ç§èŠ';
            document.getElementById('chatActions').style.display = 'block';
            document.getElementById('chatInputArea').style.display = 'block';

            // è¼‰å…¥èŠå¤©è¨˜éŒ„
            loadChatHistory(chatId, 'private');

            // é–‹å§‹è¼ªè©¢æ–°è¨Šæ¯
            startMessagePolling(chatId, 'private');
        }

        // è¼‰å…¥èŠå¤©è¨˜éŒ„
        function loadChatHistory(chatId, type) {
            const endpoint = type === 'room' ? `/api/chat/room/${chatId}/messages` : `/api/chat/private/${chatId}/messages`;
            
            fetch(endpoint)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayMessages(data.data);
                } else {
                    showToast(`è¼‰å…¥èŠå¤©è¨˜éŒ„å¤±æ•—ï¼š${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('è¼‰å…¥èŠå¤©è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            });
        }

        // é¡¯ç¤ºè¨Šæ¯
        function displayMessages(messages) {
            const chatArea = document.getElementById('chatArea');
            let html = '';

            if (messages && messages.length > 0) {
                messages.forEach(message => {
                    const isOwn = message.senderId === @(User.Identity?.IsAuthenticated == true ? "true" : "false");
                    const messageClass = isOwn ? 'message-own' : 'message-other';
                    const timeStr = new Date(message.createTime).toLocaleString('zh-TW', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    html += `
                        <div class="message-item d-flex flex-column ${isOwn ? 'align-items-end' : 'align-items-start'}">
                            <div class="message-content ${messageClass}">
                                ${message.content.replace(/\n/g, '<br>')}
                            </div>
                            <div class="message-time">
                                ${message.senderName} â€¢ ${timeStr}
                            </div>
                        </div>
                    `;
                });
            } else {
                html = `
                    <div class="text-center py-4">
                        <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">é–‹å§‹èŠå¤©</h6>
                        <p class="text-muted">ç™¼é€ç¬¬ä¸€æ¢è¨Šæ¯é–‹å§‹å°è©±</p>
                    </div>
                `;
            }

            chatArea.innerHTML = html;
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // ç™¼é€è¨Šæ¯
        function sendMessage() {
            if (!currentChatId) {
                showToast('è«‹å…ˆé¸æ“‡èŠå¤©å®¤æˆ–ç§èŠ', 'warning');
                return;
            }

            const content = document.getElementById('messageInput').value.trim();
            if (!content) {
                showToast('è«‹è¼¸å…¥è¨Šæ¯å…§å®¹', 'warning');
                return;
            }

            const endpoint = currentChatType === 'room' ? `/api/chat/room/${currentChatId}/message` : `/api/chat/private/${currentChatId}/message`;
            
            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    content: content
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ¸…ç©ºè¼¸å…¥æ¡†
                    document.getElementById('messageInput').value = '';
                    document.getElementById('charCount').textContent = '0';
                    
                    // é‡æ–°è¼‰å…¥èŠå¤©è¨˜éŒ„
                    loadChatHistory(currentChatId, currentChatType);
                } else {
                    showToast(`ç™¼é€å¤±æ•—ï¼š${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('ç™¼é€è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            });
        }

        // é–‹å§‹è¨Šæ¯è¼ªè©¢
        function startMessagePolling(chatId, type) {
            // åœæ­¢ä¹‹å‰çš„è¼ªè©¢
            if (messagePolling) {
                clearInterval(messagePolling);
            }

            // é–‹å§‹æ–°çš„è¼ªè©¢
            messagePolling = setInterval(() => {
                if (currentChatId === chatId) {
                    loadChatHistory(chatId, type);
                }
            }, 5000); // æ¯5ç§’æª¢æŸ¥ä¸€æ¬¡
        }

        // å‰µå»ºèŠå¤©å®¤
        function createChatRoom() {
            const modal = new bootstrap.Modal(document.getElementById('createChatRoomModal'));
            modal.show();
        }

        // æäº¤å‰µå»ºèŠå¤©å®¤
        function submitCreateChatRoom() {
            const name = document.getElementById('roomName').value.trim();
            const description = document.getElementById('roomDescription').value.trim();
            const type = document.getElementById('roomType').value;
            const memberIds = document.getElementById('roomMembers').value.trim();

            if (!name) {
                showToast('è«‹è¼¸å…¥èŠå¤©å®¤åç¨±', 'warning');
                return;
            }

            const data = {
                name: name,
                description: description,
                type: type
            };

            if (memberIds) {
                data.memberIds = memberIds.split(',').map(id => id.trim()).filter(id => id);
            }

            fetch('/api/chat/room/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('èŠå¤©å®¤å‰µå»ºæˆåŠŸ', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('createChatRoomModal')).hide();
                    // é‡æ–°æ•´ç†é é¢
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(`å‰µå»ºå¤±æ•—ï¼š${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('å‰µå»ºèŠå¤©å®¤æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            });
        }

        // é–‹å§‹ç§èŠ
        function startPrivateChat() {
            const modal = new bootstrap.Modal(document.getElementById('startPrivateChatModal'));
            modal.show();
        }

        // æäº¤é–‹å§‹ç§èŠ
        function submitStartPrivateChat() {
            const username = document.getElementById('targetUsername').value.trim();

            if (!username) {
                showToast('è«‹è¼¸å…¥ç›®æ¨™ç”¨æˆ¶å', 'warning');
                return;
            }

            fetch('/api/chat/private/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    targetUsername: username
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('ç§èŠé–‹å§‹æˆåŠŸ', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('startPrivateChatModal')).hide();
                    // é‡æ–°æ•´ç†é é¢
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(`é–‹å§‹å¤±æ•—ï¼š${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('é–‹å§‹ç§èŠæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            });
        }

        // é¡¯ç¤ºèŠå¤©è³‡è¨Š
        function showChatInfo() {
            if (!currentChatId) return;

            const endpoint = currentChatType === 'room' ? `/api/chat/room/${currentChatId}` : `/api/chat/private/${currentChatId}`;
            
            fetch(endpoint)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const chatInfo = data.data;
                    let html = '';

                    if (currentChatType === 'room') {
                        html = `
                            <h6>${chatInfo.name}</h6>
                            <p class="text-muted">${chatInfo.description || 'ç„¡æè¿°'}</p>
                            <div class="mb-3">
                                <strong>é¡å‹ï¼š</strong> ${chatInfo.type === 'Public' ? 'å…¬é–‹' : 'ç§å¯†'}
                            </div>
                            <div class="mb-3">
                                <strong>æˆå“¡æ•¸é‡ï¼š</strong> ${chatInfo.memberCount}
                            </div>
                            <div class="mb-3">
                                <strong>å‰µå»ºæ™‚é–“ï¼š</strong> ${new Date(chatInfo.createTime).toLocaleString('zh-TW')}
                            </div>
                        `;
                    } else {
                        html = `
                            <h6>ç§èŠ</h6>
                            <div class="mb-3">
                                <strong>å°æ–¹ç”¨æˆ¶ï¼š</strong> ${chatInfo.otherUser?.username}
                            </div>
                            <div class="mb-3">
                                <strong>é–‹å§‹æ™‚é–“ï¼š</strong> ${new Date(chatInfo.createTime).toLocaleString('zh-TW')}
                            </div>
                        `;
                    }

                    document.getElementById('chatInfoContent').innerHTML = html;
                    const modal = new bootstrap.Modal(document.getElementById('chatInfoModal'));
                    modal.show();
                } else {
                    showToast(`è¼‰å…¥èŠå¤©è³‡è¨Šå¤±æ•—ï¼š${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('è¼‰å…¥èŠå¤©è³‡è¨Šæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            });
        }

        // é›¢é–‹èŠå¤©
        function leaveChat() {
            if (!currentChatId) return;

            if (confirm('ç¢ºå®šè¦é›¢é–‹é€™å€‹èŠå¤©å—ï¼Ÿ')) {
                const endpoint = currentChatType === 'room' ? `/api/chat/room/${currentChatId}/leave` : `/api/chat/private/${currentChatId}/leave`;
                
                fetch(endpoint, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('å·²é›¢é–‹èŠå¤©', 'success');
                        // é‡æ–°æ•´ç†é é¢
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast(`é›¢é–‹å¤±æ•—ï¼š${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('é›¢é–‹èŠå¤©æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
                });
            }
        }

        // æ’å…¥è¡¨æƒ…
        function insertEmoji(emoji) {
            const textarea = document.getElementById('messageInput');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            textarea.value = text.substring(0, start) + emoji + text.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + emoji.length, start + emoji.length);
            
            // æ›´æ–°å­—å…ƒè¨ˆæ•¸
            document.getElementById('charCount').textContent = textarea.value.length;
        }

        // é¡¯ç¤ºæç¤ºè¨Šæ¯
        function showToast(message, type = 'info') {
            if (type === 'success') {
                alert('âœ… ' + message);
            } else if (type === 'error') {
                alert('âŒ ' + message);
            } else if (type === 'warning') {
                alert('âš ï¸ ' + message);
            } else {
                alert(message);
            }
        }

        // é é¢é›¢é–‹å‰åœæ­¢è¼ªè©¢
        window.addEventListener('beforeunload', function() {
            if (messagePolling) {
                clearInterval(messagePolling);
            }
        });
    </script>
}