@model GameCore.Core.Entities.StoreProduct
@{
    ViewData["Title"] = Model?.Name ?? "商品詳情";
    ViewData["ActivePage"] = "Store";
}

<div class="container-fluid">
    <!-- 麵包屑導航 -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/Store"><i class="fas fa-home"></i> 商城首頁</a></li>
            <li class="breadcrumb-item"><a href="/Store?category=@Model?.Category">@Model?.Category</a></li>
            <li class="breadcrumb-item active" aria-current="page">@Model?.Name</li>
        </ol>
    </nav>

    @if (Model != null)
    {
        <div class="row">
            <!-- 商品圖片區域 -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow-sm">
                    <div class="card-body p-0">
                        <div class="product-gallery">
                            <!-- 主圖片 -->
                            <div class="main-image-container mb-3">
                                <img id="mainImage" src="@(string.IsNullOrEmpty(Model.ImageUrl) ? "/images/product-placeholder.jpg" : Model.ImageUrl)" 
                                     class="img-fluid rounded" alt="@Model.Name">
                                
                                <!-- 圖片放大鏡效果 -->
                                <div class="image-zoom-overlay" id="zoomOverlay"></div>
                            </div>

                            <!-- 縮圖列表 -->
                            <div class="thumbnail-list">
                                <div class="row">
                                    <div class="col-3">
                                        <img src="@(string.IsNullOrEmpty(Model.ImageUrl) ? "/images/product-placeholder.jpg" : Model.ImageUrl)" 
                                             class="img-thumbnail thumbnail-item active" 
                                             onclick="changeMainImage(this.src)" 
                                             alt="@Model.Name">
                                    </div>
                                    <!-- 這裡可以添加更多縮圖 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 商品資訊區域 -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <!-- 商品標題 -->
                        <h1 class="h2 mb-3 text-gray-800">@Model.Name</h1>
                        
                        <!-- 商品分類和狀態 -->
                        <div class="mb-3">
                            <span class="badge badge-info me-2">@Model.Category</span>
                            @if (Model.Stock <= 10 && Model.Stock > 0)
                            {
                                <span class="badge badge-warning">庫存不足</span>
                            }
                            else if (Model.Stock == 0)
                            {
                                <span class="badge badge-danger">缺貨</span>
                            }
                            else
                            {
                                <span class="badge badge-success">有庫存</span>
                            }
                        </div>

                        <!-- 價格區域 -->
                        <div class="price-section mb-4">
                            @if (Model.OriginalPrice.HasValue && Model.OriginalPrice > Model.Price)
                            {
                                <div class="original-price text-muted text-decoration-line-through mb-2">
                                    NT$ @Model.OriginalPrice.Value.ToString("N0")
                                </div>
                                <div class="current-price">
                                    <span class="h1 text-danger">NT$ @Model.Price.ToString("N0")</span>
                                    @{
                                        var discount = Math.Round((1 - Model.Price / Model.OriginalPrice.Value) * 100);
                                    }
                                    <span class="badge badge-danger ms-2">-@discount%</span>
                                </div>
                            }
                            else
                            {
                                <div class="current-price">
                                    <span class="h1 text-primary">NT$ @Model.Price.ToString("N0")</span>
                                </div>
                            }
                        </div>

                        <!-- 商品描述 -->
                        <div class="product-description mb-4">
                            <h5 class="mb-2">商品描述</h5>
                            <p class="text-muted">@Model.Description</p>
                        </div>

                        <!-- 庫存資訊 -->
                        <div class="stock-info mb-4">
                            <h5 class="mb-2">庫存資訊</h5>
                            <div class="d-flex align-items-center">
                                <div class="stock-bar me-3" style="width: 200px;">
                                    <div class="progress">
                                        @{
                                            var stockPercentage = Model.Stock > 0 ? Math.Min(100, (Model.Stock / 100.0) * 100) : 0;
                                            var stockColor = Model.Stock > 50 ? "success" : Model.Stock > 20 ? "warning" : "danger";
                                        }
                                        <div class="progress-bar bg-@stockColor" role="progressbar" 
                                             style="width: @stockPercentage%" 
                                             aria-valuenow="@stockPercentage" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>
                                <span class="stock-text">
                                    @if (Model.Stock > 0)
                                    {
                                        <span class="text-success">庫存 @Model.Stock 件</span>
                                    }
                                    else
                                    {
                                        <span class="text-danger">缺貨中</span>
                                    }
                                </span>
                            </div>
                        </div>

                        <!-- 購買選項 -->
                        <div class="purchase-options mb-4">
                            <h5 class="mb-3">購買選項</h5>
                            
                            <!-- 數量選擇 -->
                            <div class="quantity-selector mb-3">
                                <label for="quantity" class="form-label">購買數量</label>
                                <div class="input-group" style="width: 150px;">
                                    <button class="btn btn-outline-secondary" type="button" onclick="decreaseQuantity()">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="number" class="form-control text-center" id="quantity" value="1" min="1" max="@Model.Stock">
                                    <button class="btn btn-outline-secondary" type="button" onclick="increaseQuantity()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <small class="form-text text-muted">最多可購買 @Model.Stock 件</small>
                            </div>

                            <!-- 總價計算 -->
                            <div class="total-price mb-3">
                                <h6>總價：<span id="totalPrice" class="text-primary">NT$ @Model.Price.ToString("N0")</span></h6>
                            </div>

                            <!-- 操作按鈕 -->
                            <div class="action-buttons">
                                <div class="row">
                                    <div class="col-6 mb-2">
                                        <button class="btn btn-outline-primary w-100" 
                                                onclick="addToCart(@Model.Id, '@Model.Name')"
                                                @(Model.Stock == 0 ? "disabled" : "")>
                                            <i class="fas fa-cart-plus"></i> 加入購物車
                                        </button>
                                    </div>
                                    <div class="col-6 mb-2">
                                        <button class="btn btn-primary w-100" 
                                                onclick="buyNow(@Model.Id, '@Model.Name')"
                                                @(Model.Stock == 0 ? "disabled" : "")>
                                            <i class="fas fa-shopping-bag"></i> 立即購買
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 商品標籤 -->
                        @if (!string.IsNullOrEmpty(Model.Tags))
                        {
                            <div class="product-tags mb-4">
                                <h5 class="mb-2">商品標籤</h5>
                                <div class="tags-container">
                                    @foreach (var tag in Model.Tags.Split(','))
                                    {
                                        <span class="badge badge-light me-1 mb-1">@tag.Trim()</span>
                                    }
                                </div>
                            </div>
                        }

                        <!-- 商品統計 -->
                        <div class="product-stats">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="stat-item">
                                        <div class="stat-number text-primary">@Model.ViewCount</div>
                                        <div class="stat-label text-muted">瀏覽次數</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-item">
                                        <div class="stat-number text-success">@Model.Stock</div>
                                        <div class="stat-label text-muted">庫存數量</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-item">
                                        <div class="stat-number text-info">@Model.CreateTime.ToString("MM/dd")</div>
                                        <div class="stat-label text-muted">上架日期</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 商品詳細資訊 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="productTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">
                                    <i class="fas fa-info-circle"></i> 商品詳情
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab">
                                    <i class="fas fa-star"></i> 用戶評價
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="related-tab" data-bs-toggle="tab" data-bs-target="#related" type="button" role="tab">
                                    <i class="fas fa-thumbs-up"></i> 相關推薦
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="productTabsContent">
                            <!-- 商品詳情 -->
                            <div class="tab-pane fade show active" id="details" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5>基本資訊</h5>
                                        <table class="table table-borderless">
                                            <tr>
                                                <td class="text-muted">商品名稱</td>
                                                <td>@Model.Name</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">商品分類</td>
                                                <td>@Model.Category</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">商品價格</td>
                                                <td>NT$ @Model.Price.ToString("N0")</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">庫存數量</td>
                                                <td>@Model.Stock 件</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">上架時間</td>
                                                <td>@Model.CreateTime.ToString("yyyy/MM/dd HH:mm")</td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>商品特色</h5>
                                        <ul class="list-unstyled">
                                            <li><i class="fas fa-check text-success me-2"></i>正版授權商品</li>
                                            <li><i class="fas fa-check text-success me-2"></i>快速發貨</li>
                                            <li><i class="fas fa-check text-success me-2"></i>7天退換貨</li>
                                            <li><i class="fas fa-check text-success me-2"></i>客服支援</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- 用戶評價 -->
                            <div class="tab-pane fade" id="reviews" role="tabpanel">
                                <div class="text-center py-4">
                                    <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">暫無用戶評價</h5>
                                    <p class="text-muted">成為第一個評價此商品的用戶吧！</p>
                                    <button class="btn btn-primary" onclick="writeReview()">
                                        <i class="fas fa-edit"></i> 寫評價
                                    </button>
                                </div>
                            </div>

                            <!-- 相關推薦 -->
                            <div class="tab-pane fade" id="related" role="tabpanel">
                                <div class="text-center py-4">
                                    <i class="fas fa-thumbs-up fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">相關推薦功能開發中</h5>
                                    <p class="text-muted">我們正在為您準備更多相關商品推薦。</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- 商品不存在 -->
        <div class="row">
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-4x text-warning mb-3"></i>
                    <h4 class="text-warning">商品不存在</h4>
                    <p class="text-muted">您要查看的商品可能已被下架或不存在。</p>
                    <a href="/Store" class="btn btn-primary">
                        <i class="fas fa-arrow-left"></i> 返回商城
                    </a>
                </div>
            </div>
        </div>
    }
</div>

<!-- 寫評價 Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reviewModalLabel">
                    <i class="fas fa-star text-warning"></i> 寫商品評價
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="reviewForm">
                    <div class="mb-3">
                        <label for="rating" class="form-label">評分</label>
                        <div class="rating-stars">
                            <i class="fas fa-star fa-2x text-muted star-rating" data-rating="1"></i>
                            <i class="fas fa-star fa-2x text-muted star-rating" data-rating="2"></i>
                            <i class="fas fa-star fa-2x text-muted star-rating" data-rating="3"></i>
                            <i class="fas fa-star fa-2x text-muted star-rating" data-rating="4"></i>
                            <i class="fas fa-star fa-2x text-muted star-rating" data-rating="5"></i>
                        </div>
                        <input type="hidden" id="selectedRating" value="0">
                    </div>
                    <div class="mb-3">
                        <label for="reviewContent" class="form-label">評價內容</label>
                        <textarea class="form-control" id="reviewContent" rows="4" placeholder="請分享您對這個商品的使用體驗..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitReview()">提交評價</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .product-gallery {
            position: relative;
        }

        .main-image-container {
            position: relative;
            overflow: hidden;
            border-radius: 0.375rem;
        }

        .main-image-container img {
            width: 100%;
            height: auto;
            transition: transform 0.3s ease;
        }

        .image-zoom-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease;
            cursor: zoom-in;
        }

        .main-image-container:hover .image-zoom-overlay {
            opacity: 1;
        }

        .thumbnail-list {
            margin-top: 1rem;
        }

        .thumbnail-item {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .thumbnail-item:hover {
            border-color: #007bff;
        }

        .thumbnail-item.active {
            border-color: #007bff;
            transform: scale(1.05);
        }

        .price-section {
            border-bottom: 1px solid #e3e6f0;
            padding-bottom: 1rem;
        }

        .original-price {
            font-size: 1.1rem;
        }

        .current-price {
            display: flex;
            align-items: center;
        }

        .stock-bar {
            flex-shrink: 0;
        }

        .stock-text {
            font-weight: 500;
        }

        .quantity-selector .input-group {
            max-width: 150px;
        }

        .quantity-selector input[type="number"] {
            text-align: center;
        }

        .total-price {
            background-color: #f8f9fc;
            padding: 1rem;
            border-radius: 0.375rem;
            border: 1px solid #e3e6f0;
        }

        .action-buttons .btn {
            padding: 0.75rem 1rem;
            font-weight: 500;
        }

        .product-tags .badge {
            font-size: 0.8rem;
            padding: 0.5rem 0.75rem;
        }

        .product-stats {
            border-top: 1px solid #e3e6f0;
            padding-top: 1rem;
        }

        .stat-item {
            padding: 0.5rem;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.8rem;
        }

        .nav-tabs .nav-link {
            color: #6c757d;
            border: none;
            padding: 0.75rem 1rem;
        }

        .nav-tabs .nav-link.active {
            color: #007bff;
            background-color: transparent;
            border-bottom: 2px solid #007bff;
        }

        .rating-stars {
            text-align: center;
        }

        .star-rating {
            cursor: pointer;
            margin: 0 0.25rem;
            transition: color 0.2s ease;
        }

        .star-rating:hover,
        .star-rating.active {
            color: #ffc107 !important;
        }

        .breadcrumb {
            background-color: transparent;
            padding: 0;
            margin-bottom: 1rem;
        }

        .breadcrumb-item a {
            color: #007bff;
            text-decoration: none;
        }

        .breadcrumb-item.active {
            color: #6c757d;
        }

        .card {
            border: 1px solid #e3e6f0;
        }

        .card-header {
            background-color: #f8f9fc;
            border-bottom: 1px solid #e3e6f0;
        }

        .table td {
            padding: 0.5rem 0;
            border: none;
        }

        .table td:first-child {
            width: 30%;
            color: #6c757d;
        }

        .list-unstyled li {
            padding: 0.25rem 0;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
}

@section Scripts {
    <script>
        let currentQuantity = 1;
        let currentPrice = @Model?.Price ?? 0;

        // 改變主圖片
        function changeMainImage(src) {
            document.getElementById('mainImage').src = src;
            
            // 更新縮圖狀態
            document.querySelectorAll('.thumbnail-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // 減少數量
        function decreaseQuantity() {
            if (currentQuantity > 1) {
                currentQuantity--;
                document.getElementById('quantity').value = currentQuantity;
                updateTotalPrice();
            }
        }

        // 增加數量
        function increaseQuantity() {
            const maxStock = @Model?.Stock ?? 0;
            if (currentQuantity < maxStock) {
                currentQuantity++;
                document.getElementById('quantity').value = currentQuantity;
                updateTotalPrice();
            }
        }

        // 更新總價
        function updateTotalPrice() {
            const total = currentQuantity * currentPrice;
            document.getElementById('totalPrice').textContent = `NT$ ${total.toLocaleString()}`;
        }

        // 數量輸入框變化
        document.getElementById('quantity').addEventListener('input', function() {
            const value = parseInt(this.value) || 1;
            const maxStock = @Model?.Stock ?? 0;
            
            if (value < 1) {
                this.value = 1;
                currentQuantity = 1;
            } else if (value > maxStock) {
                this.value = maxStock;
                currentQuantity = maxStock;
            } else {
                currentQuantity = value;
            }
            
            updateTotalPrice();
        });

        // 加入購物車
        function addToCart(productId, productName) {
            const quantity = parseInt(document.getElementById('quantity').value);
            
            fetch('/api/store/cart/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    productId: productId,
                    quantity: quantity
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(`${productName} x${quantity} 已成功加入購物車！`, 'success');
                    updateCartCount();
                } else {
                    showToast(`加入購物車失敗：${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('加入購物車時發生錯誤，請稍後再試。', 'error');
            });
        }

        // 立即購買
        function buyNow(productId, productName) {
            const quantity = parseInt(document.getElementById('quantity').value);
            const totalPrice = quantity * currentPrice;
            
            // 這裡應該跳轉到結帳頁面
            window.location.href = `/Store/Checkout?productId=${productId}&quantity=${quantity}`;
        }

        // 寫評價
        function writeReview() {
            const modal = new bootstrap.Modal(document.getElementById('reviewModal'));
            modal.show();
        }

        // 評分選擇
        document.querySelectorAll('.star-rating').forEach(star => {
            star.addEventListener('click', function() {
                const rating = parseInt(this.dataset.rating);
                document.getElementById('selectedRating').value = rating;
                
                // 更新星星顯示
                document.querySelectorAll('.star-rating').forEach((s, index) => {
                    if (index < rating) {
                        s.classList.add('active');
                        s.style.color = '#ffc107';
                    } else {
                        s.classList.remove('active');
                        s.style.color = '#6c757d';
                    }
                });
            });
        });

        // 提交評價
        function submitReview() {
            const rating = document.getElementById('selectedRating').value;
            const content = document.getElementById('reviewContent').value;
            
            if (rating == 0) {
                showToast('請選擇評分', 'warning');
                return;
            }
            
            if (!content.trim()) {
                showToast('請填寫評價內容', 'warning');
                return;
            }
            
            // 這裡應該調用評價 API
            showToast('評價提交成功！', 'success');
            bootstrap.Modal.getInstance(document.getElementById('reviewModal')).hide();
            
            // 重置表單
            document.getElementById('reviewForm').reset();
            document.getElementById('selectedRating').value = 0;
            document.querySelectorAll('.star-rating').forEach(star => {
                star.classList.remove('active');
                star.style.color = '#6c757d';
            });
        }

        // 顯示提示訊息
        function showToast(message, type = 'info') {
            // 這裡可以使用 Toast 組件或 alert
            if (type === 'success') {
                alert('✅ ' + message);
            } else if (type === 'error') {
                alert('❌ ' + message);
            } else if (type === 'warning') {
                alert('⚠️ ' + message);
            } else {
                alert(message);
            }
        }

        // 更新購物車數量
        function updateCartCount() {
            // 這裡應該更新頁面上的購物車數量顯示
            console.log('購物車數量已更新');
        }

        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateTotalPrice();
            
            // 圖片放大鏡效果
            const mainImage = document.getElementById('mainImage');
            const zoomOverlay = document.getElementById('zoomOverlay');
            
            if (mainImage && zoomOverlay) {
                mainImage.addEventListener('mousemove', function(e) {
                    const rect = this.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    
                    const scaleX = (x - centerX) / centerX;
                    const scaleY = (y - centerY) / centerY;
                    
                    this.style.transform = `scale(1.1) translate(${scaleX * 10}px, ${scaleY * 10}px)`;
                });
                
                mainImage.addEventListener('mouseleave', function() {
                    this.style.transform = 'scale(1) translate(0, 0)';
                });
            }
        });
    </script>
}