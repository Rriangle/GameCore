# 架構修復計劃

## 當前問題分析

### 1. 實體層問題
- **屬性不匹配**：服務層期望的屬性與實體定義不符
- **缺少實體**：ChatMemberRole, UserSignInStats 等
- **命名不一致**：User.User_name vs User.Username

### 2. Repository 層問題
- **方法缺失**：多個 Repository 介面缺少必要的方法
- **介面不完整**：IPlayerMarketOrderInfoRepository 等介面未定義
- **方法簽名不匹配**：AddAsync vs Add, UpdateAsync vs Update

### 3. 服務層問題
- **方法簽名不匹配**：介面與實作之間的方法簽名不一致
- **類型轉換錯誤**：實體與 DTO 之間的轉換問題
- **依賴注入問題**：缺少必要的 Repository 介面

### 4. DTO 層問題
- **類型衝突**：DTO 和 Entities 之間有重複的類型定義
- **屬性缺失**：多個 DTO 缺少必要的屬性

## 修復策略

### 階段 1：統一實體層設計
1. **修復實體屬性**：確保所有實體都有服務層需要的屬性
2. **添加兼容性屬性**：使用 [NotMapped] 添加服務層兼容性屬性
3. **統一命名規範**：確保實體屬性命名一致

### 階段 2：完善 Repository 層
1. **創建缺少的 Repository 介面**
2. **統一方法簽名**：AddAsync, UpdateAsync, DeleteAsync
3. **添加必要的方法**：GetByUserIdAsync, GetActiveItemsAsync 等

### 階段 3：修復服務層一致性
1. **修復方法簽名**：確保介面與實作一致
2. **修復類型轉換**：解決實體與 DTO 之間的轉換問題
3. **修復依賴注入**：確保所有 Repository 都能正確注入

### 階段 4：解決類型衝突
1. **重命名衝突的類型**：避免 DTO 和 Entities 之間的命名衝突
2. **統一類型定義**：確保類型定義一致

## 優先級順序

### 高優先級（立即修復）
1. 創建缺少的實體類別
2. 修復實體屬性不匹配問題
3. 創建缺少的 Repository 介面

### 中優先級（第二階段）
1. 修復服務層方法簽名
2. 解決類型轉換問題
3. 修復依賴注入問題

### 低優先級（最後階段）
1. 解決類型衝突
2. 優化代碼結構
3. 添加單元測試

## 預期結果

修復完成後，專案應該能夠：
1. 成功編譯（0 個錯誤）
2. 所有服務層方法簽名一致
3. 所有 Repository 介面完整
4. 所有實體屬性匹配
5. 依賴注入正常工作

## 時間估計

- 階段 1：2-3 小時
- 階段 2：1-2 小時
- 階段 3：2-3 小時
- 階段 4：1-2 小時

總計：6-10 小時 