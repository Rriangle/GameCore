name: GameCore CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  DOTNET_VERSION: '8.0.x'
  AZURE_WEBAPP_NAME: 'gamecore-webapp'
  AZURE_WEBAPP_PACKAGE_PATH: './publish'

jobs:
  # ===== å»ºç½®å’Œæ¸¬è©¦éšæ®µ =====
  build-and-test:
    name: ğŸ”¨ å»ºç½®å’Œæ¸¬è©¦
    runs-on: ubuntu-latest
    
    steps:
    # æª¢å‡ºç¨‹å¼ç¢¼
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    # è¨­å®š .NET
    - name: ğŸ”§ è¨­å®š .NET ${{ env.DOTNET_VERSION }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    # å¿«å– NuGet å¥—ä»¶
    - name: ğŸ“¦ å¿«å– NuGet å¥—ä»¶
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
          
    # é‚„åŸå¥—ä»¶
    - name: ğŸ”„ é‚„åŸ NuGet å¥—ä»¶
      run: dotnet restore GameCore.sln
      
    # å»ºç½®å°ˆæ¡ˆ
    - name: ğŸ”¨ å»ºç½®å°ˆæ¡ˆ
      run: dotnet build GameCore.sln --configuration Release --no-restore
      
    # åŸ·è¡Œå–®å…ƒæ¸¬è©¦
    - name: ğŸ§ª åŸ·è¡Œå–®å…ƒæ¸¬è©¦
      run: |
        dotnet test GameCore.Tests/GameCore.Tests.csproj \
          --configuration Release \
          --no-build \
          --verbosity normal \
          --collect:"XPlat Code Coverage" \
          --results-directory ./TestResults/
          
    # ä¸Šå‚³æ¸¬è©¦çµæœ
    - name: ğŸ“Š ä¸Šå‚³æ¸¬è©¦è¦†è“‹ç‡å ±å‘Š
      uses: codecov/codecov-action@v3
      with:
        directory: ./TestResults/
        flags: unittests
        name: GameCore-Coverage
        
    # ç™¼ä½ˆå°ˆæ¡ˆ
    - name: ğŸ“¦ ç™¼ä½ˆå°ˆæ¡ˆ
      run: |
        dotnet publish GameCore.Web/GameCore.Web.csproj \
          --configuration Release \
          --no-build \
          --output ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
          
    # ä¸Šå‚³å»ºç½®ç”¢ç‰©
    - name: ğŸ“¤ ä¸Šå‚³å»ºç½®ç”¢ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: webapp-package
        path: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

  # ===== å®‰å…¨æ€§æƒæéšæ®µ =====
  security-scan:
    name: ğŸ”’ å®‰å…¨æ€§æƒæ
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    # .NET å®‰å…¨æ€§æƒæ
    - name: ğŸ” .NET å®‰å…¨æ€§æƒæ
      run: |
        dotnet list package --vulnerable --include-transitive
        
    # ä¾è³´å¥—ä»¶å®‰å…¨æƒæ
    - name: ğŸ›¡ï¸ ä¾è³´å¥—ä»¶å®‰å…¨æƒæ
      uses: securecodewarrior/github-action-add-sarif@v1
      with:
        sarif-file: 'security-scan-results.sarif'
        
    # CodeQL åˆ†æ
    - name: ğŸ” CodeQL åˆ†æ
      uses: github/codeql-action/init@v2
      with:
        languages: csharp
        
    - name: ğŸ” åŸ·è¡Œ CodeQL åˆ†æ
      uses: github/codeql-action/analyze@v2

  # ===== éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ =====
  deploy-staging:
    name: ğŸš€ éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan]
    if: github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
    - name: ğŸ“¥ ä¸‹è¼‰å»ºç½®ç”¢ç‰©
      uses: actions/download-artifact@v3
      with:
        name: webapp-package
        path: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
        
    # éƒ¨ç½²åˆ° Azure App Service (æ¸¬è©¦ç’°å¢ƒ)
    - name: ğŸŒ éƒ¨ç½²åˆ° Azure App Service (Staging)
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}-staging
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_STAGING }}
        package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
        
    # åŸ·è¡Œå¥åº·æª¢æŸ¥
    - name: ğŸ¥ å¥åº·æª¢æŸ¥
      run: |
        sleep 30
        curl -f https://${{ env.AZURE_WEBAPP_NAME }}-staging.azurewebsites.net/health

  # ===== æ•´åˆæ¸¬è©¦éšæ®µ =====
  integration-tests:
    name: ğŸ”— æ•´åˆæ¸¬è©¦
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ”§ è¨­å®š .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    # åŸ·è¡Œæ•´åˆæ¸¬è©¦
    - name: ğŸ§ª åŸ·è¡Œæ•´åˆæ¸¬è©¦
      run: |
        dotnet test GameCore.Tests/GameCore.Tests.csproj \
          --filter "Category=Integration" \
          --configuration Release \
          --verbosity normal
      env:
        GAMECORE_TEST_URL: https://${{ env.AZURE_WEBAPP_NAME }}-staging.azurewebsites.net
        
    # åŸ·è¡Œç«¯å°ç«¯æ¸¬è©¦
    - name: ğŸ­ åŸ·è¡Œç«¯å°ç«¯æ¸¬è©¦
      run: |
        dotnet test GameCore.Tests/GameCore.Tests.csproj \
          --filter "Category=E2E" \
          --configuration Release \
          --verbosity normal
      env:
        GAMECORE_TEST_URL: https://${{ env.AZURE_WEBAPP_NAME }}-staging.azurewebsites.net

  # ===== éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ =====
  deploy-production:
    name: ğŸš€ éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan, integration-tests]
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: ğŸ“¥ ä¸‹è¼‰å»ºç½®ç”¢ç‰©
      uses: actions/download-artifact@v3
      with:
        name: webapp-package
        path: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
        
    # éƒ¨ç½²åˆ° Azure App Service (ç”Ÿç”¢ç’°å¢ƒ)
    - name: ğŸŒ éƒ¨ç½²åˆ° Azure App Service (Production)
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
        
    # åŸ·è¡Œç”Ÿç”¢ç’°å¢ƒå¥åº·æª¢æŸ¥
    - name: ğŸ¥ ç”Ÿç”¢ç’°å¢ƒå¥åº·æª¢æŸ¥
      run: |
        sleep 60
        for i in {1..5}; do
          if curl -f https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/health; then
            echo "âœ… å¥åº·æª¢æŸ¥é€šé"
            break
          else
            echo "âŒ å¥åº·æª¢æŸ¥å¤±æ•—ï¼Œé‡è©¦ä¸­... ($i/5)"
            sleep 10
          fi
        done
        
    # ç™¼é€éƒ¨ç½²é€šçŸ¥
    - name: ğŸ“§ ç™¼é€éƒ¨ç½²é€šçŸ¥
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: |
          ğŸš€ GameCore éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒå®Œæˆï¼
          ğŸ“Š ç‹€æ…‹: ${{ job.status }}
          ğŸ”— ç¶²å€: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net
          ğŸ“ æäº¤: ${{ github.sha }}
          ğŸ‘¤ ä½œè€…: ${{ github.actor }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ===== æ•ˆèƒ½æ¸¬è©¦éšæ®µ =====
  performance-test:
    name: âš¡ æ•ˆèƒ½æ¸¬è©¦
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    # å®‰è£ k6 æ•ˆèƒ½æ¸¬è©¦å·¥å…·
    - name: ğŸ”§ å®‰è£ k6
      run: |
        sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6
        
    # åŸ·è¡Œè² è¼‰æ¸¬è©¦
    - name: ğŸ“ˆ åŸ·è¡Œè² è¼‰æ¸¬è©¦
      run: |
        k6 run --vus 100 --duration 5m ./Scripts/performance-test.js
      env:
        TARGET_URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net

  # ===== è³‡æ–™åº«é·ç§»éšæ®µ =====
  database-migration:
    name: ğŸ—„ï¸ è³‡æ–™åº«é·ç§»
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ”§ è¨­å®š .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    # å®‰è£ EF Core å·¥å…·
    - name: ğŸ”§ å®‰è£ EF Core å·¥å…·
      run: dotnet tool install --global dotnet-ef
      
    # åŸ·è¡Œè³‡æ–™åº«é·ç§»
    - name: ğŸ—„ï¸ åŸ·è¡Œè³‡æ–™åº«é·ç§»
      run: |
        dotnet ef database update \
          --project GameCore.Infrastructure \
          --startup-project GameCore.Web \
          --connection "${{ secrets.AZURE_SQL_CONNECTION_STRING }}"

  # ===== é€šçŸ¥éšæ®µ =====
  notify:
    name: ğŸ“¢ ç™¼é€é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [deploy-production, performance-test]
    if: always()
    
    steps:
    # ç™¼é€ Teams é€šçŸ¥
    - name: ğŸ“¢ ç™¼é€ Microsoft Teams é€šçŸ¥
      uses: skitionek/notify-microsoft-teams@master
      if: always()
      with:
        webhook_url: ${{ secrets.TEAMS_WEBHOOK_URL }}
        overwrite: |
          {
            "text": "ğŸ® GameCore éƒ¨ç½²å®Œæˆé€šçŸ¥",
            "sections": [
              {
                "activityTitle": "éƒ¨ç½²çµæœ",
                "activitySubtitle": "${{ github.workflow }} - ${{ github.ref_name }}",
                "facts": [
                  {
                    "name": "ç‹€æ…‹",
                    "value": "${{ needs.deploy-production.result }}"
                  },
                  {
                    "name": "æäº¤è€…",
                    "value": "${{ github.actor }}"
                  },
                  {
                    "name": "æäº¤è¨Šæ¯",
                    "value": "${{ github.event.head_commit.message }}"
                  },
                  {
                    "name": "ç¶²å€",
                    "value": "https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
                  }
                ]
              }
            ]
          }