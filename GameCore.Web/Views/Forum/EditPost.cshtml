@model GameCore.Core.ViewModels.EditPostViewModel
@{
    ViewData["Title"] = "ç·¨è¼¯è²¼æ–‡";
    ViewData["ActivePage"] = "Forum";
}

<div class="container-fluid">
    <!-- é é¢æ¨™é¡Œå’Œå°èˆª -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="/Forum" class="text-decoration-none">
                            <i class="fas fa-comments"></i> è«–å£‡
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="/Forum/Posts/@Model?.Post?.ForumId" class="text-decoration-none">
                            @Model?.Forum?.Name ?? "ç‰ˆé¢"
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="/Forum/Post/@Model?.Post?.Id" class="text-decoration-none">
                            @Model?.Post?.Title ?? "è²¼æ–‡"
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        ç·¨è¼¯
                    </li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="fas fa-edit text-primary"></i>
                        ç·¨è¼¯è²¼æ–‡
                    </h1>
                    <p class="text-muted mb-0">ç·¨è¼¯è²¼æ–‡å…§å®¹å’Œè¨­å®š</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="/Forum/Post/@Model?.Post?.Id" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> è¿”å›è²¼æ–‡
                    </a>
                    <button type="button" class="btn btn-outline-info" onclick="previewPost()">
                        <i class="fas fa-eye"></i> é è¦½
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (Model?.Post != null)
    {
        <form id="editPostForm" method="post">
            <div class="row">
                <!-- å·¦å´ï¼šç·¨è¼¯è¡¨å–® -->
                <div class="col-lg-8 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-edit"></i>
                                ç·¨è¼¯è²¼æ–‡
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- æ¨™é¡Œ -->
                            <div class="mb-3">
                                <label for="title" class="form-label">æ¨™é¡Œ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="title" name="Title" 
                                       value="@Model.Post.Title" required maxlength="200">
                                <div class="form-text">æ¨™é¡Œé•·åº¦ä¸èƒ½è¶…é 200 å­—å…ƒ</div>
                            </div>

                            <!-- å…§å®¹ -->
                            <div class="mb-3">
                                <label for="content" class="form-label">å…§å®¹ <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="content" name="Content" rows="12" 
                                          placeholder="è¼¸å…¥è²¼æ–‡å…§å®¹..." required>@Model.Post.Content</textarea>
                                <div class="form-text">æ”¯æ´ Markdown èªæ³•</div>
                            </div>

                            <!-- æ¨™ç±¤ -->
                            <div class="mb-3">
                                <label for="tags" class="form-label">æ¨™ç±¤</label>
                                <input type="text" class="form-control" id="tags" name="Tags" 
                                       value="@(Model.Post.Tags != null ? string.Join(", ", Model.Post.Tags) : "")" 
                                       placeholder="ç”¨é€—è™Ÿåˆ†éš”å¤šå€‹æ¨™ç±¤">
                                <div class="form-text">ä¾‹å¦‚ï¼šæ”»ç•¥, å¿ƒå¾—, å•é¡Œ</div>
                            </div>

                            <!-- è²¼æ–‡é¡å‹ -->
                            <div class="mb-3">
                                <label for="type" class="form-label">è²¼æ–‡é¡å‹</label>
                                <select class="form-select" id="type" name="Type">
                                    <option value="discussion" @(Model.Post.Type == "discussion" ? "selected" : "")>è¨è«–</option>
                                    <option value="question" @(Model.Post.Type == "question" ? "selected" : "")>å•é¡Œ</option>
                                    <option value="guide" @(Model.Post.Type == "guide" ? "selected" : "")>æ”»ç•¥</option>
                                    <option value="share" @(Model.Post.Type == "share" ? "selected" : "")>åˆ†äº«</option>
                                    <option value="announcement" @(Model.Post.Type == "announcement" ? "selected" : "")>å…¬å‘Š</option>
                                </select>
                            </div>

                            <!-- ç·¨è¼¯åŸå›  -->
                            <div class="mb-3">
                                <label for="editReason" class="form-label">ç·¨è¼¯åŸå› </label>
                                <input type="text" class="form-control" id="editReason" name="EditReason" 
                                       placeholder="è«‹èªªæ˜æ­¤æ¬¡ç·¨è¼¯çš„åŸå› ï¼ˆé¸å¡«ï¼‰">
                                <div class="form-text">ç·¨è¼¯åŸå› æœƒé¡¯ç¤ºåœ¨è²¼æ–‡æ­·å²ä¸­</div>
                            </div>

                            <!-- ç·¨è¼¯å·¥å…· -->
                            <div class="mb-3">
                                <div class="d-flex flex-wrap gap-2">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertMarkdown('**ç²—é«”**')">
                                        <strong>B</strong>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertMarkdown('*æ–œé«”*')">
                                        <em>I</em>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertMarkdown('[é€£çµ](URL)')">
                                        ğŸ”—
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertMarkdown('![åœ–ç‰‡](URL)')">
                                        ğŸ–¼ï¸
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertMarkdown('`ç¨‹å¼ç¢¼`')">
                                        <code>Code</code>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertMarkdown('```\nç¨‹å¼ç¢¼å€å¡Š\n```')">
                                        ğŸ“
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertMarkdown('- åˆ—è¡¨é …ç›®')">
                                        ğŸ“‹
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertMarkdown('> å¼•ç”¨æ–‡å­—')">
                                        ğŸ’¬
                                    </button>
                                </div>
                            </div>

                            <!-- æäº¤æŒ‰éˆ• -->
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="notifyFollowers" name="NotifyFollowers" checked>
                                    <label class="form-check-label" for="notifyFollowers">
                                        é€šçŸ¥é—œæ³¨è€…
                                    </label>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                        <i class="fas fa-undo"></i> é‡ç½®
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> å„²å­˜è®Šæ›´
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å³å´ï¼šé è¦½å’Œè³‡è¨Š -->
                <div class="col-lg-4 mb-4">
                    <!-- é è¦½å€åŸŸ -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-eye"></i>
                                é è¦½
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="previewContent" class="preview-content">
                                <p class="text-muted text-center">é»æ“Šé è¦½æŒ‰éˆ•æŸ¥çœ‹æ•ˆæœ</p>
                            </div>
                        </div>
                    </div>

                    <!-- è²¼æ–‡è³‡è¨Š -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle"></i>
                                è²¼æ–‡è³‡è¨Š
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="post-info">
                                <div class="mb-2">
                                    <strong>ä½œè€…ï¼š</strong>
                                    <span>@Model.Post.Author?.Username</span>
                                </div>
                                <div class="mb-2">
                                    <strong>å»ºç«‹æ™‚é–“ï¼š</strong>
                                    <span>@Model.Post.CreateTime.ToString("yyyy/MM/dd HH:mm")</span>
                                </div>
                                @if (Model.Post.UpdateTime.HasValue)
                                {
                                    <div class="mb-2">
                                        <strong>æœ€å¾Œç·¨è¼¯ï¼š</strong>
                                        <span>@Model.Post.UpdateTime.Value.ToString("yyyy/MM/dd HH:mm")</span>
                                    </div>
                                }
                                <div class="mb-2">
                                    <strong>ç€è¦½æ¬¡æ•¸ï¼š</strong>
                                    <span>@(Model.Post.ViewCount ?? 0)</span>
                                </div>
                                <div class="mb-2">
                                    <strong>å›è¦†æ¬¡æ•¸ï¼š</strong>
                                    <span>@(Model.Post.ReplyCount ?? 0)</span>
                                </div>
                                <div class="mb-2">
                                    <strong>è®šæ•¸ï¼š</strong>
                                    <span>@(Model.Post.LikeCount ?? 0)</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç·¨è¼¯æ­·å² -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-history"></i>
                                ç·¨è¼¯æ­·å²
                            </h5>
                        </div>
                        <div class="card-body">
                            @if (Model.EditHistory != null && Model.EditHistory.Any())
                            {
                                <div class="edit-history">
                                    @foreach (var history in Model.EditHistory.Take(5))
                                    {
                                        <div class="history-item mb-2">
                                            <small class="text-muted">
                                                @history.EditTime.ToString("MM/dd HH:mm")
                                            </small>
                                            @if (!string.IsNullOrEmpty(history.EditReason))
                                            {
                                                <div class="text-muted small">
                                                    åŸå› ï¼š@history.EditReason
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <p class="text-muted small">æš«ç„¡ç·¨è¼¯è¨˜éŒ„</p>
                            }
                        </div>
                    </div>

                    <!-- å¿«é€Ÿæ“ä½œ -->
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-tools"></i>
                                å¿«é€Ÿæ“ä½œ
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-warning btn-sm" onclick="saveAsDraft()">
                                    <i class="fas fa-save"></i> å„²å­˜è‰ç¨¿
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="loadDraft()">
                                    <i class="fas fa-folder-open"></i> è¼‰å…¥è‰ç¨¿
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="showOriginal()">
                                    <i class="fas fa-eye"></i> æŸ¥çœ‹åŸç‰ˆ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    }
    else
    {
        <!-- è²¼æ–‡ä¸å­˜åœ¨ -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-exclamation-triangle text-warning fa-4x mb-3"></i>
                        <h4 class="text-warning">è²¼æ–‡ä¸å­˜åœ¨</h4>
                        <p class="text-muted">æŒ‡å®šçš„è²¼æ–‡ä¸å­˜åœ¨æˆ–å·²è¢«åˆªé™¤ã€‚</p>
                        <a href="/Forum" class="btn btn-primary">
                            <i class="fas fa-arrow-left"></i> è¿”å›è«–å£‡
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- é è¦½ Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">
                    <i class="fas fa-eye"></i> è²¼æ–‡é è¦½
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="modalPreviewContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .preview-content {
            min-height: 200px;
            border: 1px dashed #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            background-color: #f8f9fc;
        }

        .preview-content.preview-loaded {
            border: 1px solid #dee2e6;
            background-color: white;
        }

        .edit-history .history-item {
            padding: 0.5rem;
            border-radius: 0.375rem;
            background-color: #f8f9fc;
        }

        .post-info div {
            font-size: 0.9rem;
        }

        .card-header {
            background-color: #f8f9fc;
            border-bottom: 1px solid #e3e6f0;
        }

        .breadcrumb {
            background-color: transparent;
            padding: 0;
            margin-bottom: 1rem;
        }

        .breadcrumb-item a {
            color: #007bff;
        }

        .breadcrumb-item.active {
            color: #6c757d;
        }

        .btn-sm {
            font-size: 0.8rem;
            padding: 0.375rem 0.5rem;
        }

        /* Markdown é è¦½æ¨£å¼ */
        .markdown-preview h1, .markdown-preview h2, .markdown-preview h3,
        .markdown-preview h4, .markdown-preview h5, .markdown-preview h6 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .markdown-preview p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .markdown-preview code {
            background-color: #f8f9fc;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
        }

        .markdown-preview pre {
            background-color: #f8f9fc;
            padding: 1rem;
            border-radius: 0.375rem;
            overflow-x: auto;
        }

        .markdown-preview blockquote {
            border-left: 4px solid #dee2e6;
            padding-left: 1rem;
            margin-left: 0;
            color: #6c757d;
        }

        .markdown-preview ul, .markdown-preview ol {
            margin-bottom: 1rem;
            padding-left: 2rem;
        }

        .markdown-preview img {
            max-width: 100%;
            height: auto;
            border-radius: 0.375rem;
        }

        .markdown-preview a {
            color: #007bff;
            text-decoration: none;
        }

        .markdown-preview a:hover {
            text-decoration: underline;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 767.98px) {
            .d-flex.flex-wrap {
                flex-direction: column;
            }
            
            .d-flex.flex-wrap .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }
    </style>
}

@section Scripts {
    <script>
        let originalContent = '@Html.Raw(Model?.Post?.Content?.Replace("'", "\\'") ?? "")';
        let originalTitle = '@Html.Raw(Model?.Post?.Title?.Replace("'", "\\'") ?? "")';
        let originalTags = '@Html.Raw(Model?.Post?.Tags != null ? string.Join(", ", Model.Post.Tags).Replace("'", "\\'") : "")';

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è¡¨å–®æäº¤
            document.getElementById('editPostForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitEdit();
            });

            // è‡ªå‹•å„²å­˜è‰ç¨¿
            setInterval(autoSaveDraft, 30000); // æ¯30ç§’è‡ªå‹•å„²å­˜
        });

        // é è¦½è²¼æ–‡
        function previewPost() {
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const tags = document.getElementById('tags').value;
            const type = document.getElementById('type').value;

            if (!title.trim() || !content.trim()) {
                showToast('è«‹å…ˆå¡«å¯«æ¨™é¡Œå’Œå…§å®¹', 'warning');
                return;
            }

            // æ›´æ–°é è¦½å€åŸŸ
            updatePreview(title, content, tags, type);

            // é¡¯ç¤ºé è¦½ Modal
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            modal.show();
        }

        // æ›´æ–°é è¦½å…§å®¹
        function updatePreview(title, content, tags, type) {
            const previewContent = document.getElementById('previewContent');
            const modalPreviewContent = document.getElementById('modalPreviewContent');

            const previewHtml = generatePreviewHtml(title, content, tags, type);

            previewContent.innerHTML = previewHtml;
            previewContent.classList.add('preview-loaded');
            modalPreviewContent.innerHTML = previewHtml;
        }

        // ç”Ÿæˆé è¦½ HTML
        function generatePreviewHtml(title, content, tags, type) {
            let html = `
                <div class="markdown-preview">
                    <h1>${title}</h1>
                    <div class="mb-3">
                        <span class="badge bg-primary me-2">${type}</span>
                        ${tags ? tags.split(',').map(tag => `<span class="badge bg-light text-dark me-1">${tag.trim()}</span>`).join('') : ''}
                    </div>
                    <div class="content-preview">
                        ${content.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `;
            return html;
        }

        // æ’å…¥ Markdown
        function insertMarkdown(markdown) {
            const textarea = document.getElementById('content');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const selectedText = text.substring(start, end);
            
            let newText;
            if (markdown.includes('**') && selectedText) {
                newText = `**${selectedText}**`;
            } else if (markdown.includes('*') && selectedText) {
                newText = `*${selectedText}**`;
            } else if (markdown.includes('[') && selectedText) {
                newText = `[${selectedText}](URL)`;
            } else if (markdown.includes('![') && selectedText) {
                newText = `![${selectedText}](URL)`;
            } else if (markdown.includes('`') && selectedText) {
                newText = `\`${selectedText}\``;
            } else if (markdown.includes('```')) {
                newText = '```\nç¨‹å¼ç¢¼å€å¡Š\n```';
            } else if (markdown.includes('- ')) {
                newText = '- åˆ—è¡¨é …ç›®';
            } else if (markdown.includes('> ')) {
                newText = '> å¼•ç”¨æ–‡å­—';
            } else {
                newText = markdown;
            }
            
            textarea.value = text.substring(0, start) + newText + text.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + newText.length, start + newText.length);
        }

        // é‡ç½®è¡¨å–®
        function resetForm() {
            if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è®Šæ›´å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                document.getElementById('title').value = originalTitle;
                document.getElementById('content').value = originalContent;
                document.getElementById('tags').value = originalTags;
                document.getElementById('editReason').value = '';
                
                // é‡ç½®é è¦½
                const previewContent = document.getElementById('previewContent');
                previewContent.innerHTML = '<p class="text-muted text-center">é»æ“Šé è¦½æŒ‰éˆ•æŸ¥çœ‹æ•ˆæœ</p>';
                previewContent.classList.remove('preview-loaded');
                
                showToast('è¡¨å–®å·²é‡ç½®', 'info');
            }
        }

        // è‡ªå‹•å„²å­˜è‰ç¨¿
        function autoSaveDraft() {
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const tags = document.getElementById('tags').value;
            const type = document.getElementById('type').value;

            if (title.trim() || content.trim()) {
                const draft = {
                    title: title,
                    content: content,
                    tags: tags,
                    type: type,
                    timestamp: new Date().toISOString()
                };

                localStorage.setItem('forumPostDraft', JSON.stringify(draft));
            }
        }

        // å„²å­˜è‰ç¨¿
        function saveAsDraft() {
            autoSaveDraft();
            showToast('è‰ç¨¿å·²å„²å­˜', 'success');
        }

        // è¼‰å…¥è‰ç¨¿
        function loadDraft() {
            const draft = localStorage.getItem('forumPostDraft');
            if (draft) {
                try {
                    const draftData = JSON.parse(draft);
                    document.getElementById('title').value = draftData.title || '';
                    document.getElementById('content').value = draftData.content || '';
                    document.getElementById('tags').value = draftData.tags || '';
                    document.getElementById('type').value = draftData.type || 'discussion';
                    
                    showToast('è‰ç¨¿å·²è¼‰å…¥', 'success');
                } catch (error) {
                    showToast('è¼‰å…¥è‰ç¨¿å¤±æ•—', 'error');
                }
            } else {
                showToast('æ²’æœ‰æ‰¾åˆ°è‰ç¨¿', 'info');
            }
        }

        // æŸ¥çœ‹åŸç‰ˆ
        function showOriginal() {
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            const modalPreviewContent = document.getElementById('modalPreviewContent');
            
            const originalHtml = generatePreviewHtml(originalTitle, originalContent, originalTags, '@Model?.Post?.Type');
            modalPreviewContent.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>åŸå§‹ç‰ˆæœ¬</strong>
                </div>
                ${originalHtml}
            `;
            
            modal.show();
        }

        // æäº¤ç·¨è¼¯
        function submitEdit() {
            const title = document.getElementById('title').value.trim();
            const content = document.getElementById('content').value.trim();
            const tags = document.getElementById('tags').value.trim();
            const type = document.getElementById('type').value;
            const editReason = document.getElementById('editReason').value.trim();
            const notifyFollowers = document.getElementById('notifyFollowers').checked;

            if (!title) {
                showToast('è«‹è¼¸å…¥æ¨™é¡Œ', 'warning');
                document.getElementById('title').focus();
                return;
            }

            if (!content) {
                showToast('è«‹è¼¸å…¥å…§å®¹', 'warning');
                document.getElementById('content').focus();
                return;
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
            if (title === originalTitle && content === originalContent && tags === originalTags && type === '@Model?.Post?.Type') {
                showToast('æ²’æœ‰ç™¼ç¾ä»»ä½•è®Šæ›´', 'warning');
                return;
            }

            // æäº¤è¡¨å–®
            const formData = new FormData(document.getElementById('editPostForm'));
            formData.append('PostId', @(Model?.Post?.Id ?? 0));

            fetch('/api/forum/post/update', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    postId: @(Model?.Post?.Id ?? 0),
                    title: title,
                    content: content,
                    tags: tags ? tags.split(',').map(t => t.trim()).filter(t => t) : [],
                    type: type,
                    editReason: editReason,
                    notifyFollowers: notifyFollowers
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('è²¼æ–‡æ›´æ–°æˆåŠŸ', 'success');
                    // æ¸…é™¤è‰ç¨¿
                    localStorage.removeItem('forumPostDraft');
                    // è·³è½‰åˆ°è²¼æ–‡é é¢
                    setTimeout(() => {
                        window.location.href = `/Forum/Post/@Model?.Post?.Id`;
                    }, 1500);
                } else {
                    showToast(`æ›´æ–°å¤±æ•—ï¼š${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('æ›´æ–°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
            });
        }

        // é¡¯ç¤ºæç¤ºè¨Šæ¯
        function showToast(message, type = 'info') {
            if (type === 'success') {
                alert('âœ… ' + message);
            } else if (type === 'error') {
                alert('âŒ ' + message);
            } else if (type === 'warning') {
                alert('âš ï¸ ' + message);
            } else {
                alert(message);
            }
        }

        // é é¢é›¢é–‹å‰æé†’å„²å­˜
        window.addEventListener('beforeunload', function(e) {
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            
            if ((title !== originalTitle || content !== originalContent) && (title.trim() || content.trim())) {
                e.preventDefault();
                e.returnValue = 'æ‚¨æœ‰æœªå„²å­˜çš„è®Šæ›´ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ';
                return 'æ‚¨æœ‰æœªå„²å­˜çš„è®Šæ›´ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ';
            }
        });
    </script>
}