@model GameCore.Core.ViewModels.PostDetailViewModel
@{
    ViewData["Title"] = Model?.Post?.Title ?? "Ë≤ºÊñáË©≥ÊÉÖ";
    ViewData["ActivePage"] = "Forum";
}

<div class="container-fluid">
    <!-- È†ÅÈù¢Ê®ôÈ°åÂíåÂ∞éËà™ -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="/Forum" class="text-decoration-none">
                            <i class="fas fa-comments"></i> Ë´ñÂ£á
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="/Forum/Posts/@Model?.Post?.ForumId" class="text-decoration-none">
                            @Model?.Forum?.Name ?? "ÁâàÈù¢"
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        @Model?.Post?.Title ?? "Ë≤ºÊñá"
                    </li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="fas fa-file-alt text-primary"></i>
                        @Model?.Post?.Title ?? "Ë≤ºÊñáË©≥ÊÉÖ"
                    </h1>
                </div>
                <div class="d-flex gap-2">
                    <a href="/Forum/Posts/@Model?.Post?.ForumId" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> ËøîÂõûÁâàÈù¢
                    </a>
                    @if (User.Identity?.Name == Model?.Post?.Author?.Username || User.IsInRole("Admin") || User.IsInRole("Moderator"))
                    {
                        <a href="/Forum/Post/Edit/@Model?.Post?.Id" class="btn btn-outline-primary">
                            <i class="fas fa-edit"></i> Á∑®ËºØË≤ºÊñá
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>

    @if (Model?.Post != null)
    {
        <div class="row">
            <!-- Â∑¶ÂÅ¥ÔºöË≤ºÊñáÂÖßÂÆπÂíåÂõûË¶Ü -->
            <div class="col-lg-8 mb-4">
                <!-- Ë≤ºÊñáÂÖßÂÆπ -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="post-header">
                                <h2 class="h4 mb-2">@Model.Post.Title</h2>
                                <div class="post-meta">
                                    <span class="badge bg-primary me-2">@Model.Post.Type</span>
                                    @if (Model.Post.IsSticky)
                                    {
                                        <span class="badge bg-warning me-2">ÁΩÆÈ†Ç</span>
                                    }
                                    @if (Model.Post.IsLocked)
                                    {
                                        <span class="badge bg-secondary me-2">Â∑≤ÈéñÂÆö</span>
                                    }
                                    @if (Model.Post.IsPinned)
                                    {
                                        <span class="badge bg-info me-2">Á≤æËèØ</span>
                                    }
                                </div>
                            </div>
                            <div class="post-actions">
                                <button class="btn btn-sm btn-outline-primary me-2" onclick="likePost(@Model.Post.Id)">
                                    <i class="fas fa-thumbs-up"></i> ËÆö <span id="likeCount">@(Model.Post.LikeCount ?? 0)</span>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary me-2" onclick="bookmarkPost(@Model.Post.Id)">
                                    <i class="fas fa-bookmark"></i> Êî∂Ëóè
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="sharePost()">
                                    <i class="fas fa-share"></i> ÂàÜ‰∫´
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="post-author mb-3">
                            <div class="d-flex align-items-center">
                                <div class="author-avatar me-3">
                                    @if (!string.IsNullOrEmpty(Model.Post.Author?.Avatar))
                                    {
                                        <img src="@Model.Post.Author.Avatar" class="rounded-circle" width="50" height="50" alt="È†≠ÂÉè">
                                    }
                                    else
                                    {
                                        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                            <i class="fas fa-user text-white"></i>
                                        </div>
                                    }
                                </div>
                                <div class="author-info">
                                    <h6 class="mb-1">@Model.Post.Author?.Username</h6>
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> @Model.Post.CreateTime.ToString("yyyy/MM/dd HH:mm")
                                        @if (Model.Post.UpdateTime.HasValue && Model.Post.UpdateTime != Model.Post.CreateTime)
                                        {
                                            <span class="ms-2">(Á∑®ËºØÊñº @Model.Post.UpdateTime.Value.ToString("MM/dd HH:mm"))</span>
                                        }
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="post-content mb-3">
                            @if (!string.IsNullOrEmpty(Model.Post.Content))
                            {
                                <div class="content-text">
                                    @Html.Raw(Model.Post.Content.Replace("\n", "<br>"))
                                </div>
                            }
                            else
                            {
                                <p class="text-muted">Ê≠§Ë≤ºÊñáÊ≤íÊúâÂÖßÂÆπ</p>
                            }
                        </div>
                        
                        @if (Model.Post.Tags != null && Model.Post.Tags.Any())
                        {
                            <div class="post-tags mb-3">
                                <strong>Ê®ôÁ±§Ôºö</strong>
                                @foreach (var tag in Model.Post.Tags)
                                {
                                    <span class="badge bg-light text-dark me-1">@tag</span>
                                }
                            </div>
                        }
                        
                        <div class="post-stats">
                            <div class="row text-center">
                                <div class="col-3">
                                    <div class="stat-item">
                                        <h6 class="text-primary mb-1">@(Model.Post.ViewCount ?? 0)</h6>
                                        <small class="text-muted">ÁÄèË¶Ω</small>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="stat-item">
                                        <h6 class="text-success mb-1">@(Model.Post.ReplyCount ?? 0)</h6>
                                        <small class="text-muted">ÂõûË¶Ü</small>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="stat-item">
                                        <h6 class="text-info mb-1">@(Model.Post.LikeCount ?? 0)</h6>
                                        <small class="text-muted">ËÆö</small>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="stat-item">
                                        <h6 class="text-warning mb-1">@(Model.Post.ShareCount ?? 0)</h6>
                                        <small class="text-muted">ÂàÜ‰∫´</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÂõûË¶ÜÂàóË°® -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-comments"></i>
                            ÂõûË¶Ü (@(Model.Post.ReplyCount ?? 0))
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        @if (Model.Replies != null && Model.Replies.Any())
                        {
                            <div class="replies-list">
                                @foreach (var reply in Model.Replies)
                                {
                                    <div class="reply-item p-3 border-bottom" id="reply-@reply.Id">
                                        <div class="d-flex">
                                            <div class="reply-author me-3">
                                                @if (!string.IsNullOrEmpty(reply.Author?.Avatar))
                                                {
                                                    <img src="@reply.Author.Avatar" class="rounded-circle" width="40" height="40" alt="È†≠ÂÉè">
                                                }
                                                else
                                                {
                                                    <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                        <i class="fas fa-user text-white"></i>
                                                    </div>
                                                }
                                            </div>
                                            <div class="reply-content flex-grow-1">
                                                <div class="reply-header mb-2">
                                                    <h6 class="mb-1">@reply.Author?.Username</h6>
                                                    <small class="text-muted">
                                                        <i class="fas fa-clock"></i> @reply.CreateTime.ToString("yyyy/MM/dd HH:mm")
                                                        @if (reply.UpdateTime.HasValue && reply.UpdateTime != reply.CreateTime)
                                                        {
                                                            <span class="ms-2">(Á∑®ËºØÊñº @reply.UpdateTime.Value.ToString("MM/dd HH:mm"))</span>
                                                        }
                                                    </small>
                                                </div>
                                                <div class="reply-text mb-2">
                                                    @if (!string.IsNullOrEmpty(reply.Content))
                                                    {
                                                        @Html.Raw(reply.Content.Replace("\n", "<br>"))
                                                    }
                                                </div>
                                                <div class="reply-actions">
                                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="likeReply(@reply.Id)">
                                                        <i class="fas fa-thumbs-up"></i> ËÆö <span id="replyLikeCount-@reply.Id">@(reply.LikeCount ?? 0)</span>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="quoteReply(@reply.Id, '@reply.Author?.Username')">
                                                        <i class="fas fa-quote-left"></i> ÂºïÁî®
                                                    </button>
                                                    @if (User.Identity?.Name == reply.Author?.Username || User.IsInRole("Admin") || User.IsInRole("Moderator"))
                                                    {
                                                        <button class="btn btn-sm btn-outline-warning me-2" onclick="editReply(@reply.Id)">
                                                            <i class="fas fa-edit"></i> Á∑®ËºØ
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteReply(@reply.Id)">
                                                            <i class="fas fa-trash"></i> Âà™Èô§
                                                        </button>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-4">
                                <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted">ÁõÆÂâçÊ≤íÊúâÂõûË¶Ü</h6>
                                <p class="text-muted">ÊàêÁÇ∫Á¨¨‰∏ÄÂÄãÂõûË¶ÜÁöÑ‰∫∫ÂêßÔºÅ</p>
                            </div>
                        }
                    </div>
                </div>

                <!-- ÂõûË¶ÜË°®ÂñÆ -->
                @if (!Model.Post.IsLocked)
                {
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-reply"></i>
                                ÁôºË°®ÂõûË¶Ü
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="replyForm">
                                <div class="mb-3">
                                    <label for="replyContent" class="form-label">ÂõûË¶ÜÂÖßÂÆπ <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="replyContent" name="Content" rows="5" 
                                              placeholder="Ëº∏ÂÖ•ÊÇ®ÁöÑÂõûË¶ÜÂÖßÂÆπ..." required></textarea>
                                    <div class="form-text">ÊîØÊè¥ Markdown Ë™ûÊ≥ï</div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="notifyAuthor" name="NotifyAuthor">
                                        <label class="form-check-label" for="notifyAuthor">
                                            ÈÄöÁü•Ë≤ºÊñá‰ΩúËÄÖ
                                        </label>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="reply-tools">
                                        <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="insertEmoji('üòä')">
                                            üòä Ë°®ÊÉÖ
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="insertMarkdown('**Á≤óÈ´î**')">
                                            <strong>B</strong>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="insertMarkdown('*ÊñúÈ´î*')">
                                            <em>I</em>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertMarkdown('[ÈÄ£Áµê](URL)')">
                                            üîó
                                        </button>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-paper-plane"></i> ÁôºË°®ÂõûË¶Ü
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                }
                else
                {
                    <div class="card shadow-sm">
                        <div class="card-body text-center py-4">
                            <i class="fas fa-lock fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">Ê≠§Ë≤ºÊñáÂ∑≤Ë¢´ÈéñÂÆö</h6>
                            <p class="text-muted">ÁÑ°Ê≥ïÁôºË°®Êñ∞ÁöÑÂõûË¶Ü</p>
                        </div>
                    </div>
                }
            </div>

            <!-- Âè≥ÂÅ¥ÔºöÁõ∏ÈóúË≥áË®ä -->
            <div class="col-lg-4 mb-4">
                <!-- ÁâàÈù¢Ë≥áË®ä -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-folder"></i>
                            ÁâàÈù¢Ë≥áË®ä
                        </h5>
                    </div>
                    <div class="card-body">
                        <h6 class="mb-2">@Model.Forum?.Name</h6>
                        <p class="text-muted small mb-3">@Model.Forum?.Description</p>
                        <div class="forum-stats">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="stat-item">
                                        <h6 class="text-primary mb-1">@(Model.Forum?.PostCount ?? 0)</h6>
                                        <small class="text-muted">Ë≤ºÊñá</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-item">
                                        <h6 class="text-success mb-1">@(Model.Forum?.ReplyCount ?? 0)</h6>
                                        <small class="text-muted">ÂõûË¶Ü</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-item">
                                        <h6 class="text-info mb-1">@(Model.Forum?.SubscriberCount ?? 0)</h6>
                                        <small class="text-muted">Ë®ÇÈñ±</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <a href="/Forum/Posts/@Model.Forum?.Id" class="btn btn-outline-primary btn-sm w-100">
                                <i class="fas fa-list"></i> Êü•ÁúãÁâàÈù¢
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Áõ∏ÈóúË≤ºÊñá -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-link"></i>
                            Áõ∏ÈóúË≤ºÊñá
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (Model.RelatedPosts != null && Model.RelatedPosts.Any())
                        {
                            <div class="related-posts">
                                @foreach (var relatedPost in Model.RelatedPosts.Take(5))
                                {
                                    <div class="related-post mb-2">
                                        <a href="/Forum/Post/@relatedPost.Id" class="text-decoration-none">
                                            <h6 class="mb-1 text-dark">@relatedPost.Title</h6>
                                            <small class="text-muted">
                                                @relatedPost.Author?.Username ‚Ä¢ @relatedPost.CreateTime.ToString("MM/dd")
                                            </small>
                                        </a>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted small">Êö´ÁÑ°Áõ∏ÈóúË≤ºÊñá</p>
                        }
                    </div>
                </div>

                <!-- Âø´ÈÄüÊìç‰Ωú -->
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-tools"></i>
                            Âø´ÈÄüÊìç‰Ωú
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="reportPost(@Model.Post.Id)">
                                <i class="fas fa-flag"></i> Ê™¢ËàâË≤ºÊñá
                            </button>
                            @if (User.IsInRole("Admin") || User.IsInRole("Moderator"))
                            {
                                <button class="btn btn-outline-warning btn-sm" onclick="toggleSticky(@Model.Post.Id)">
                                    <i class="fas fa-thumbtack"></i> @(Model.Post.IsSticky ? "ÂèñÊ∂àÁΩÆÈ†Ç" : "ÁΩÆÈ†Ç")
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="togglePinned(@Model.Post.Id)">
                                    <i class="fas fa-star"></i> @(Model.Post.IsPinned ? "ÂèñÊ∂àÁ≤æËèØ" : "Ë®≠ÁÇ∫Á≤æËèØ")
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="toggleLocked(@Model.Post.Id)">
                                    <i class="fas fa-lock"></i> @(Model.Post.IsLocked ? "Ëß£Èéñ" : "ÈéñÂÆö")
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Ë≤ºÊñá‰∏çÂ≠òÂú® -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-exclamation-triangle text-warning fa-4x mb-3"></i>
                        <h4 class="text-warning">Ë≤ºÊñá‰∏çÂ≠òÂú®</h4>
                        <p class="text-muted">ÊåáÂÆöÁöÑË≤ºÊñá‰∏çÂ≠òÂú®ÊàñÂ∑≤Ë¢´Âà™Èô§„ÄÇ</p>
                        <a href="/Forum" class="btn btn-primary">
                            <i class="fas fa-arrow-left"></i> ËøîÂõûË´ñÂ£á
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Âà™Èô§ÂõûË¶ÜÁ¢∫Ë™ç Modal -->
<div class="modal fade" id="deleteReplyModal" tabindex="-1" aria-labelledby="deleteReplyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteReplyModalLabel">
                    <i class="fas fa-exclamation-triangle text-danger"></i> Á¢∫Ë™çÂà™Èô§ÂõûË¶Ü
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>ÊÇ®Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂâáÂõûË¶ÜÂóéÔºü</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Ë≠¶ÂëäÔºö</strong> Ê≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÂèñÊ∂à</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteReply()">Á¢∫Ë™çÂà™Èô§</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .post-content .content-text {
            line-height: 1.6;
            font-size: 1rem;
        }

        .reply-item {
            transition: background-color 0.2s ease;
        }

        .reply-item:hover {
            background-color: #f8f9fc;
        }

        .reply-item:last-child {
            border-bottom: none !important;
        }

        .stat-item h6 {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .stat-item small {
            font-size: 0.75rem;
        }

        .related-post {
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease;
        }

        .related-post:hover {
            background-color: #f8f9fc;
        }

        .reply-tools .btn {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }

        .post-actions .btn {
            font-size: 0.8rem;
        }

        .badge {
            font-size: 0.7rem;
        }

        .card-header {
            background-color: #f8f9fc;
            border-bottom: 1px solid #e3e6f0;
        }

        .breadcrumb {
            background-color: transparent;
            padding: 0;
            margin-bottom: 1rem;
        }

        .breadcrumb-item a {
            color: #007bff;
        }

        .breadcrumb-item.active {
            color: #6c757d;
        }

        .author-avatar img {
            object-fit: cover;
        }

        .reply-author img {
            object-fit: cover;
        }

        /* ÈüøÊáâÂºèË®≠Ë®à */
        @media (max-width: 767.98px) {
            .post-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .post-actions .btn {
                width: 100%;
            }
            
            .reply-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .reply-actions .btn {
                width: 100%;
            }
        }
    </style>
}

@section Scripts {
    <script>
        let currentPostId = @(Model?.Post?.Id ?? 0);
        let replyToDelete = null;
        let quotedReply = null;

        // È†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÂæåÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // ÂõûË¶ÜË°®ÂñÆÊèê‰∫§
            document.getElementById('replyForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitReply();
            });

            // Â¢ûÂä†ÁÄèË¶ΩÊ¨°Êï∏
            incrementViewCount();
        });

        // Â¢ûÂä†ÁÄèË¶ΩÊ¨°Êï∏
        function incrementViewCount() {
            fetch(`/api/forum/post/view/${currentPostId}`, {
                method: 'POST'
            }).catch(error => console.error('Error incrementing view count:', error));
        }

        // ËÆöË≤ºÊñá
        function likePost(postId) {
            fetch('/api/forum/post/like', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    postId: postId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('ËÆöÊàêÂäü', 'success');
                    // Êõ¥Êñ∞ËÆöÊï∏È°ØÁ§∫
                    const likeCountElement = document.getElementById('likeCount');
                    if (likeCountElement) {
                        const currentCount = parseInt(likeCountElement.textContent);
                        likeCountElement.textContent = currentCount + 1;
                    }
                } else {
                    showToast(`ËÆöÂ§±ÊïóÔºö${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('ËÆöÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ', 'error');
            });
        }

        // Êî∂ËóèË≤ºÊñá
        function bookmarkPost(postId) {
            fetch('/api/forum/post/bookmark', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    postId: postId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Êî∂ËóèÊàêÂäü', 'success');
                } else {
                    showToast(`Êî∂ËóèÂ§±ÊïóÔºö${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Êî∂ËóèÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ', 'error');
            });
        }

        // ÂàÜ‰∫´Ë≤ºÊñá
        function sharePost() {
            const url = window.location.href;
            const title = '@Model?.Post?.Title';
            
            if (navigator.share) {
                navigator.share({
                    title: title,
                    url: url
                });
            } else {
                // Ë§áË£ΩÈÄ£ÁµêÂà∞Ââ™Ë≤ºÁ∞ø
                navigator.clipboard.writeText(url).then(() => {
                    showToast('ÈÄ£ÁµêÂ∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø', 'success');
                }).catch(() => {
                    // ÈôçÁ¥öÊñπÊ°à
                    const textArea = document.createElement('textarea');
                    textArea.value = url;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast('ÈÄ£ÁµêÂ∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø', 'success');
                });
            }
        }

        // ËÆöÂõûË¶Ü
        function likeReply(replyId) {
            fetch('/api/forum/reply/like', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    replyId: replyId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('ËÆöÊàêÂäü', 'success');
                    // Êõ¥Êñ∞ËÆöÊï∏È°ØÁ§∫
                    const likeCountElement = document.getElementById(`replyLikeCount-${replyId}`);
                    if (likeCountElement) {
                        const currentCount = parseInt(likeCountElement.textContent);
                        likeCountElement.textContent = currentCount + 1;
                    }
                } else {
                    showToast(`ËÆöÂ§±ÊïóÔºö${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('ËÆöÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ', 'error');
            });
        }

        // ÂºïÁî®ÂõûË¶Ü
        function quoteReply(replyId, authorName) {
            quotedReply = { id: replyId, author: authorName };
            const replyContent = document.querySelector(`#reply-${replyId} .reply-text`).textContent;
            const quoteText = `> @${authorName} Ë™™Ôºö\n${replyContent}\n\n`;
            
            const textarea = document.getElementById('replyContent');
            textarea.value = quoteText + textarea.value;
            textarea.focus();
            textarea.scrollTop = textarea.scrollHeight;
            
            showToast('Â∑≤ÂºïÁî®ÂõûË¶Ü', 'info');
        }

        // Á∑®ËºØÂõûË¶Ü
        function editReply(replyId) {
            // ÈÄôË£°ÂèØ‰ª•ÂØ¶ÁèæÂÖßÂµåÁ∑®ËºØÂäüËÉΩ
            showToast('Á∑®ËºØÂäüËÉΩÈñãÁôº‰∏≠', 'info');
        }

        // Âà™Èô§ÂõûË¶Ü
        function deleteReply(replyId) {
            replyToDelete = replyId;
            const modal = new bootstrap.Modal(document.getElementById('deleteReplyModal'));
            modal.show();
        }

        // Á¢∫Ë™çÂà™Èô§ÂõûË¶Ü
        function confirmDeleteReply() {
            if (!replyToDelete) return;
            
            fetch(`/api/forum/reply/delete/${replyToDelete}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('ÂõûË¶ÜÂà™Èô§ÊàêÂäü', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('deleteReplyModal')).hide();
                    // ÂæûÈ†ÅÈù¢ÁßªÈô§ÂõûË¶Ü
                    const replyElement = document.getElementById(`reply-${replyToDelete}`);
                    if (replyElement) {
                        replyElement.remove();
                    }
                    // Êõ¥Êñ∞ÂõûË¶ÜÊï∏Èáè
                    const replyCount = document.querySelector('.card-header h5');
                    if (replyCount) {
                        const currentText = replyCount.textContent;
                        const newCount = parseInt(currentText.match(/\d+/)[0]) - 1;
                        replyCount.innerHTML = `<i class="fas fa-comments"></i> ÂõûË¶Ü (${newCount})`;
                    }
                } else {
                    showToast(`Âà™Èô§Â§±ÊïóÔºö${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Âà™Èô§ÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ', 'error');
            })
            .finally(() => {
                replyToDelete = null;
            });
        }

        // Êèê‰∫§ÂõûË¶Ü
        function submitReply() {
            const content = document.getElementById('replyContent').value.trim();
            if (!content) {
                showToast('Ë´ãËº∏ÂÖ•ÂõûË¶ÜÂÖßÂÆπ', 'warning');
                return;
            }
            
            const notifyAuthor = document.getElementById('notifyAuthor').checked;
            
            fetch('/api/forum/reply/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    postId: currentPostId,
                    content: content,
                    notifyAuthor: notifyAuthor
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('ÂõûË¶ÜÁôºË°®ÊàêÂäü', 'success');
                    // Ê∏ÖÁ©∫Ë°®ÂñÆ
                    document.getElementById('replyContent').value = '';
                    // ÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢‰ª•È°ØÁ§∫Êñ∞ÂõûË¶Ü
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(`ÂõûË¶ÜÁôºË°®Â§±ÊïóÔºö${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('ÁôºË°®ÂõûË¶ÜÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ', 'error');
            });
        }

        // ÊèíÂÖ•Ë°®ÊÉÖ
        function insertEmoji(emoji) {
            const textarea = document.getElementById('replyContent');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            textarea.value = text.substring(0, start) + emoji + text.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + emoji.length, start + emoji.length);
        }

        // ÊèíÂÖ• Markdown
        function insertMarkdown(markdown) {
            const textarea = document.getElementById('replyContent');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const selectedText = text.substring(start, end);
            
            let newText;
            if (markdown.includes('**') && selectedText) {
                newText = `**${selectedText}**`;
            } else if (markdown.includes('*') && selectedText) {
                newText = `*${selectedText}*`;
            } else if (markdown.includes('[') && selectedText) {
                newText = `[${selectedText}](URL)`;
            } else {
                newText = markdown;
            }
            
            textarea.value = text.substring(0, start) + newText + text.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + newText.length, start + newText.length);
        }

        // Ê™¢ËàâË≤ºÊñá
        function reportPost(postId) {
            const reason = prompt('Ë´ãËº∏ÂÖ•Ê™¢ËàâÂéüÂõ†Ôºö');
            if (reason && reason.trim()) {
                fetch('/api/forum/post/report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        postId: postId,
                        reason: reason.trim()
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Ê™¢ËàâÊàêÂäüÔºåÊÑüË¨ùÊÇ®ÁöÑÂõûÂ†±', 'success');
                    } else {
                        showToast(`Ê™¢ËàâÂ§±ÊïóÔºö${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Ê™¢ËàâÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ', 'error');
                });
            }
        }

        // ÂàáÊèõÁΩÆÈ†ÇÁãÄÊÖã
        function toggleSticky(postId) {
            fetch(`/api/forum/post/toggle-sticky/${postId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('ÁΩÆÈ†ÇÁãÄÊÖãÂ∑≤Êõ¥Êñ∞', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(`Êìç‰ΩúÂ§±ÊïóÔºö${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Êìç‰ΩúÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ', 'error');
            });
        }

        // ÂàáÊèõÁ≤æËèØÁãÄÊÖã
        function togglePinned(postId) {
            fetch(`/api/forum/post/toggle-pinned/${postId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Á≤æËèØÁãÄÊÖãÂ∑≤Êõ¥Êñ∞', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(`Êìç‰ΩúÂ§±ÊïóÔºö${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Êìç‰ΩúÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ', 'error');
            });
        }

        // ÂàáÊèõÈéñÂÆöÁãÄÊÖã
        function toggleLocked(postId) {
            fetch(`/api/forum/post/toggle-locked/${postId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('ÈéñÂÆöÁãÄÊÖãÂ∑≤Êõ¥Êñ∞', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(`Êìç‰ΩúÂ§±ÊïóÔºö${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Êìç‰ΩúÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ', 'error');
            });
        }

        // È°ØÁ§∫ÊèêÁ§∫Ë®äÊÅØ
        function showToast(message, type = 'info') {
            if (type === 'success') {
                alert('‚úÖ ' + message);
            } else if (type === 'error') {
                alert('‚ùå ' + message);
            } else if (type === 'warning') {
                alert('‚ö†Ô∏è ' + message);
            } else {
                alert(message);
            }
        }
    </script>
}