# GameCore æ¯æ—¥ç°½åˆ°ç³»çµ±å®Œæ•´æŒ‡å—

## ğŸ“‹ ç³»çµ±æ¦‚è¿°

GameCoreæ¯æ—¥ç°½åˆ°ç³»çµ±æ˜¯ä¸€å€‹å®Œæ•´çš„ä½¿ç”¨è€…æ—¥å¸¸äº’å‹•åŠŸèƒ½ï¼Œåš´æ ¼æŒ‰ç…§Asia/Taipeiæ™‚å€é‹ä½œï¼Œæä¾›é€£çºŒç°½åˆ°çå‹µã€é€±æœ«åŠ æˆã€æœˆåº¦å…¨å‹¤çå‹µç­‰è±å¯ŒåŠŸèƒ½ã€‚ç³»çµ±è¨­è¨ˆæ—¨åœ¨æé«˜ä½¿ç”¨è€…é»æ€§å’Œæ—¥æ´»èºåº¦ã€‚

### ğŸ¯ æ ¸å¿ƒç‰¹è‰²

- **æ™‚å€ç²¾æº–**: åš´æ ¼æŒ‰ç…§Asia/Taipeiæ™‚å€é€²è¡Œæ—¥ç•Œç·šè¨ˆç®—
- **çå‹µè±å¯Œ**: åŸºç¤çå‹µ + é€£çºŒçå‹µ + é€±æœ«åŠ æˆ + æœˆåº¦å…¨å‹¤
- **é˜²ä½œå¼Š**: æ¯æ—¥é™ä¸€æ¬¡ç°½åˆ°ï¼ŒåŸå­æ“ä½œä¿è­‰è³‡æ–™ä¸€è‡´æ€§
- **ä½¿ç”¨è€…å‹å¥½**: ç¾è§€çš„æ—¥æ›†ç•Œé¢å’Œå³æ™‚çµ±è¨ˆ
- **æ“´å±•æ€§å¼·**: æ¨¡çµ„åŒ–è¨­è¨ˆï¼Œæ˜“æ–¼æ“´å±•æ–°åŠŸèƒ½

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹

### ä¸‰å±¤æ¶æ§‹è¨­è¨ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Presentation      â”‚  â† DailySignInController, Index.cshtml
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Business Logic    â”‚  â† DailySignInService, DTOs
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Data Access       â”‚  â† UserSignInStats Entity, DbContext
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒå…ƒä»¶

1. **DailySignInController**: RESTful APIæ§åˆ¶å™¨
2. **DailySignInService**: æ¥­å‹™é‚è¼¯æœå‹™
3. **DailySignInDTOs**: è³‡æ–™å‚³è¼¸ç‰©ä»¶
4. **Index.cshtml**: ä½¿ç”¨è€…ä»‹é¢
5. **UserSignInStats**: è³‡æ–™åº«å¯¦é«”

## ğŸ“Š è³‡æ–™åº«è¨­è¨ˆ

### UserSignInStats è³‡æ–™è¡¨

```sql
CREATE TABLE UserSignInStats (
    LogID int IDENTITY(1,1) PRIMARY KEY,
    SignTime datetime2 NOT NULL DEFAULT SYSUTCDATETIME(),
    UserID int NOT NULL,
    PointsChanged int NOT NULL DEFAULT 0,
    ExpGained int NOT NULL DEFAULT 0,
    PointsChangedTime datetime2 NOT NULL DEFAULT SYSUTCDATETIME(),
    ExpGainedTime datetime2 NOT NULL DEFAULT SYSUTCDATETIME(),
    
    FOREIGN KEY (UserID) REFERENCES Users(User_ID)
);
```

### é‡è¦è¨­è¨ˆåŸå‰‡

- **UTCå„²å­˜**: æ‰€æœ‰æ™‚é–“æ¬„ä½ä½¿ç”¨UTCæ™‚é–“å„²å­˜
- **æ™‚å€è½‰æ›**: æ‡‰ç”¨å±¤è² è²¬Asia/Taipeiæ™‚å€è½‰æ›
- **å¤–éµç´„æŸ**: ç¢ºä¿è³‡æ–™å®Œæ•´æ€§
- **é è¨­å€¼**: åˆç†çš„é è¨­å€¼è¨­å®š

## ğŸ çå‹µç³»çµ±

### åŸºç¤çå‹µè¦å‰‡

| ç°½åˆ°é¡å‹ | é»æ•¸çå‹µ | ç¶“é©—çå‹µ | èªªæ˜ |
|---------|---------|---------|------|
| å¹³æ—¥ (ä¸€~äº”) | +20 | 0 | åŸºç¤å¹³æ—¥çå‹µ |
| é€±æœ« (å…­ã€æ—¥) | +30 | +200 | é€±æœ«åŠ æˆçå‹µ |

### ç‰¹æ®Šçå‹µè¦å‰‡

| çå‹µé¡å‹ | è§¸ç™¼æ¢ä»¶ | é¡å¤–çå‹µ | èªªæ˜ |
|---------|---------|---------|------|
| é€£çºŒ7å¤©çå‹µ | é€£çºŒç°½åˆ°æ»¿7å¤© | +40é»æ•¸, +300ç¶“é©— | ç•¶æ—¥é¡å¤–ç™¼æ”¾ |
| æœˆåº¦å…¨å‹¤çå‹µ | ç•¶æœˆæ¯æ—¥éƒ½ç°½åˆ° | +200é»æ•¸, +2000ç¶“é©— | æœˆæœ«æœ€å¾Œä¸€æ—¥ç™¼æ”¾ |

### çå‹µè¨ˆç®—é‚è¼¯

```csharp
// åŸºç¤çå‹µ
var baseRewards = IsWeekend(date) 
    ? new { Points = 30, Experience = 200 }  // é€±æœ«
    : new { Points = 20, Experience = 0 };   // å¹³æ—¥

// é€£çºŒçå‹µ (ç¬¬7å¤©)
if (currentStreak + 1 == 7) {
    totalPoints += 40;
    totalExperience += 300;
}

// æœˆåº¦å…¨å‹¤çå‹µ (æœˆæœ«ä¸”å…¨å‹¤)
if (IsLastDayOfMonth(date) && IsPerfectAttendance()) {
    totalPoints += 200;
    totalExperience += 2000;
}
```

## ğŸ”§ API æ–‡ä»¶

### æ ¸å¿ƒAPIç«¯é»

#### 1. å–å¾—ç°½åˆ°ç‹€æ…‹
```http
GET /api/signin/status
```

**å›æ‡‰ç¯„ä¾‹:**
```json
{
  "success": true,
  "data": {
    "userId": 123,
    "todaySigned": false,
    "currentStreak": 5,
    "taipeiDate": "2024-08-15",
    "taipeiDateTime": "2024-08-15T14:30:00+08:00",
    "isWeekend": false,
    "canSignToday": true,
    "todayPotentialRewards": {
      "points": 20,
      "experience": 0
    }
  }
}
```

#### 2. åŸ·è¡Œç°½åˆ°
```http
POST /api/signin
```

**å›æ‡‰ç¯„ä¾‹:**
```json
{
  "success": true,
  "data": {
    "success": true,
    "message": "ç°½åˆ°æˆåŠŸï¼",
    "pointsEarned": 60,
    "experienceGained": 300,
    "streakBefore": 6,
    "streakAfter": 7,
    "hasSevenDayBonus": true,
    "hasMonthlyBonus": false,
    "bonusMessages": ["é€£çºŒç°½åˆ°7å¤©çå‹µï¼š+40é»æ•¸ +300ç¶“é©—"]
  }
}
```

#### 3. å–å¾—æœˆåº¦çµ±è¨ˆ
```http
GET /api/signin/monthly?year=2024&month=8
```

**å›æ‡‰ç¯„ä¾‹:**
```json
{
  "success": true,
  "data": {
    "year": 2024,
    "month": 8,
    "totalSignedDays": 20,
    "totalDaysInMonth": 31,
    "attendanceRate": 64.52,
    "totalPointsEarned": 500,
    "totalExperienceGained": 1200,
    "isPerfectAttendance": false
  }
}
```

#### 4. å–å¾—ç°½åˆ°æ­·å²
```http
GET /api/signin/history?page=1&pageSize=20&fromDate=2024-08-01&toDate=2024-08-31
```

#### 5. å–å¾—ç°½åˆ°æ—¥æ›†
```http
GET /api/signin/calendar?year=2024&month=8
```

### ç®¡ç†å“¡API

#### èª¿æ•´ç°½åˆ°è¨˜éŒ„
```http
POST /api/signin/admin/adjust
Authorization: Bearer {admin_token}
```

**è«‹æ±‚ç¯„ä¾‹:**
```json
{
  "userId": 456,
  "adjustmentDate": "2024-08-15",
  "adjustmentType": "add",
  "reason": "ç³»çµ±ç¶­è­·æœŸé–“è£œç°½",
  "sendNotification": true
}
```

## ğŸ–¥ï¸ å‰ç«¯ä»‹é¢

### UIè¨­è¨ˆåŸå‰‡

- **Glass Morphismé¢¨æ ¼**: åŠé€æ˜æ¯›ç»ç’ƒæ•ˆæœ
- **éŸ¿æ‡‰å¼è¨­è¨ˆ**: æ”¯æ´æ¡Œé¢å’Œè¡Œå‹•è£ç½®
- **ç›´è¦ºæ“ä½œ**: ç°¡å–®æ˜ç­çš„äº’å‹•æµç¨‹
- **å³æ™‚å›é¥‹**: å‹•ç•«å’Œç‹€æ…‹é¡¯ç¤º

### ä¸»è¦å…ƒä»¶

1. **ç°½åˆ°æŒ‰éˆ•**: å¤§å‹CTAæŒ‰éˆ•ï¼Œç‹€æ…‹æ˜ç¢º
2. **æ—¥æ›†æª¢è¦–**: æœˆåº¦ç°½åˆ°ç‹€æ³è¦–è¦ºåŒ–
3. **é€²åº¦æ¢**: é€£çºŒç°½åˆ°é€²åº¦é¡¯ç¤º
4. **çµ±è¨ˆå¡ç‰‡**: æœˆåº¦çµ±è¨ˆè³‡è¨Š
5. **æ­·å²è¨˜éŒ„**: æœ€è¿‘ç°½åˆ°è¨˜éŒ„

### äº’å‹•æµç¨‹

```
ä½¿ç”¨è€…é€²å…¥é é¢
     â†“
è¼‰å…¥ç°½åˆ°ç‹€æ…‹
     â†“
é¡¯ç¤ºä»Šæ—¥ç‹€æ…‹å’Œæ½›åœ¨çå‹µ
     â†“
ä½¿ç”¨è€…é»æ“Šç°½åˆ°
     â†“
é¡¯ç¤ºæˆåŠŸå‹•ç•«å’Œç²å¾—çå‹µ
     â†“
æ›´æ–°ç•Œé¢ç‹€æ…‹
```

## âš™ï¸ è¨­å®šèˆ‡éƒ¨ç½²

### ä¾è³´æ³¨å…¥è¨­å®š

```csharp
// Program.cs
builder.Services.AddScoped<IDailySignInService, DailySignInService>();
```

### å¿…è¦ç›¸ä¾æ€§

- `IWalletService`: é»æ•¸ç®¡ç†
- `GameCoreDbContext`: è³‡æ–™åº«å­˜å–
- `ILogger`: æ—¥èªŒè¨˜éŒ„

### ç’°å¢ƒè¦æ±‚

- .NET 8.0+
- SQL Server 2019+
- Asia/Taipeiæ™‚å€æ”¯æ´

## ğŸ§ª æ¸¬è©¦æŒ‡å—

### å–®å…ƒæ¸¬è©¦

```bash
# åŸ·è¡Œæ‰€æœ‰ç°½åˆ°ç³»çµ±æ¸¬è©¦
dotnet test --filter "DailySignInControllerTests"

# åŸ·è¡Œç‰¹å®šæ¸¬è©¦
dotnet test --filter "PerformSignIn_ShouldReturnSuccess_WhenSignInSucceeds"
```

### æ¸¬è©¦è¦†è“‹ç¯„åœ

- âœ… ç°½åˆ°ç‹€æ…‹æŸ¥è©¢
- âœ… ç°½åˆ°åŸ·è¡Œé‚è¼¯
- âœ… çå‹µè¨ˆç®—
- âœ… æœˆåº¦çµ±è¨ˆ
- âœ… æ­·å²è¨˜éŒ„
- âœ… éŒ¯èª¤è™•ç†
- âœ… é‚Šç•Œæ¢ä»¶

### æ¸¬è©¦è³‡æ–™

ä½¿ç”¨ `07-DailySignInSeedData.sql` ç”Ÿæˆå®Œæ•´æ¸¬è©¦è³‡æ–™ï¼ŒåŒ…å«ï¼š

- éå»90å¤©çš„ç°½åˆ°è¨˜éŒ„
- é€£çºŒç°½åˆ°çå‹µç¤ºä¾‹
- æœˆåº¦å…¨å‹¤çå‹µè¨˜éŒ„
- ä¸åŒä½¿ç”¨è€…çš„ç°½åˆ°æ¨¡å¼

## ğŸ” ç–‘é›£æ’è§£

### å¸¸è¦‹å•é¡Œ

#### 1. æ™‚å€å•é¡Œ
**å•é¡Œ**: ç°½åˆ°æ™‚é–“ä¸æ­£ç¢º
**è§£æ±º**: ç¢ºèª `TimeZoneInfo.FindSystemTimeZoneById("Asia/Taipei")` æ­£å¸¸é‹ä½œ

#### 2. é‡è¤‡ç°½åˆ°
**å•é¡Œ**: ä½¿ç”¨è€…å¯ä»¥é‡è¤‡ç°½åˆ°
**è§£æ±º**: æª¢æŸ¥ `HasSignedTodayAsync` æ–¹æ³•çš„UTCæ™‚é–“ç¯„åœè¨ˆç®—

#### 3. çå‹µè¨ˆç®—éŒ¯èª¤
**å•é¡Œ**: é€£çºŒçå‹µæˆ–æœˆåº¦çå‹µä¸æ­£ç¢º
**è§£æ±º**: æª¢æŸ¥ `CalculateCurrentStreakAsync` å’Œæœˆåº¦å…¨å‹¤æª¢æŸ¥é‚è¼¯

#### 4. æ•ˆèƒ½å•é¡Œ
**å•é¡Œ**: æŸ¥è©¢é€Ÿåº¦æ…¢
**è§£æ±º**: 
- å° `UserID` å’Œ `SignTime` å»ºç«‹è¤‡åˆç´¢å¼•
- é™åˆ¶æ­·å²æŸ¥è©¢ç¯„åœ
- ä½¿ç”¨åˆ†é æŸ¥è©¢

### ç›£æ§æŒ‡æ¨™

- æ¯æ—¥ç°½åˆ°ç‡
- é€£çºŒç°½åˆ°å¤©æ•¸åˆ†å¸ƒ
- çå‹µç™¼æ”¾çµ±è¨ˆ
- APIå›æ‡‰æ™‚é–“
- éŒ¯èª¤ç‡

## ğŸ“ˆ æ•ˆèƒ½æœ€ä½³åŒ–

### è³‡æ–™åº«æœ€ä½³åŒ–

```sql
-- å»ºè­°çš„ç´¢å¼•
CREATE INDEX IX_UserSignInStats_UserID_SignTime 
ON UserSignInStats (UserID, SignTime);

CREATE INDEX IX_UserSignInStats_SignTime 
ON UserSignInStats (SignTime) 
INCLUDE (UserID, PointsChanged, ExpGained);
```

### å¿«å–ç­–ç•¥

- ä½¿ç”¨è€…ç•¶æ—¥ç°½åˆ°ç‹€æ…‹å¿«å– (5åˆ†é˜)
- æœˆåº¦çµ±è¨ˆå¿«å– (1å°æ™‚)
- é€£çºŒç°½åˆ°å¤©æ•¸å¿«å– (30åˆ†é˜)

### æ‰¹æ¬¡è™•ç†

- æ¯æ—¥è‡ªå‹•çµ±è¨ˆä½œæ¥­
- æœˆåº¦çå‹µæ‰¹æ¬¡ç™¼æ”¾
- æ­·å²è³‡æ–™æ­¸æª”

## ğŸš€ æœªä¾†æ“´å±•

### è¨ˆåŠƒåŠŸèƒ½

1. **ç°½åˆ°æé†’**: Pushé€šçŸ¥å’ŒEmailæé†’
2. **ç°½åˆ°æŒ‘æˆ°**: ç‰¹æ®Šæ´»å‹•å’Œé™æ™‚æŒ‘æˆ°
3. **ç¤¾äº¤åŠŸèƒ½**: å¥½å‹ç°½åˆ°æ’è¡Œæ¦œ
4. **å€‹æ€§åŒ–**: è‡ªè¨‚ç°½åˆ°ç•Œé¢å’Œçå‹µåå¥½
5. **åˆ†æå ±è¡¨**: è©³ç´°çš„ç°½åˆ°è¡Œç‚ºåˆ†æ

### æ“´å±•å»ºè­°

- ä½¿ç”¨Redisæå‡å¿«å–æ•ˆèƒ½
- å¯¦ä½œåˆ†æ•£å¼é–é˜²æ­¢ä½µç™¼å•é¡Œ
- åŠ å…¥æ©Ÿå™¨å­¸ç¿’é æ¸¬ç°½åˆ°è¡Œç‚º
- æ”¯æ´å¤šæ™‚å€ä½¿ç”¨è€…

## ğŸ“š ç›¸é—œæ–‡ä»¶

- [éŒ¢åŒ…ç³»çµ±æŒ‡å—](./WalletSystemGuide.md)
- [ä½¿ç”¨è€…èªè­‰æŒ‡å—](./AuthenticationGuide.md)
- [APIè¦æ ¼æ–‡ä»¶](./APIReference.md)
- [è³‡æ–™åº«è¨­è¨ˆæ–‡ä»¶](./DatabaseDesign.md)

---

*æœ¬æ–‡ä»¶æœ€å¾Œæ›´æ–°: 2024å¹´8æœˆ15æ—¥*
*ç‰ˆæœ¬: 1.0.0*
*ç¶­è­·è€…: GameCoreé–‹ç™¼åœ˜éšŠ*