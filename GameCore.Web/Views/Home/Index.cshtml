@{
    ViewData["Title"] = "GameCoreï½œéŠæˆ²ç¤¾ç¾¤å¹³å°";
}

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>@ViewData["Title"]</title>
    <style>
        :root{
            --bg:#eef3f8; 
            --bg2:#ffffff; 
            --ink:#1f2937; 
            --muted:#64748b; 
            --line:#e5e7eb; 
            --surface:rgba(255,255,255,.75); 
            --glass:rgba(255,255,255,.45); 
            --accent:#7557ff; 
            --accent-2:#34d2ff; 
            --accent-3:#22c55e; 
            --radius:18px; 
            --radius-sm:12px; 
            --shadow:0 18px 40px rgba(17,24,39,.12); 
            --blur:14px;
            /* æ’è¡Œæ¦œé…è‰² */
            --ok:#22c55e; 
            --down:#ff6b6b; 
            --flat:#9aa8bf; 
            --gold:#FFD700; 
            --silver:#C0C0C0; 
            --bronze:#CD7F32; 
            --goldA:rgba(255,215,0,.18); 
            --silverA:rgba(192,192,192,.18); 
            --bronzeA:rgba(205,127,50,.18);
        }

        body.dark{
            --bg:#0c111b; 
            --bg2:#0a0f18; 
            --ink:#e5edff; 
            --muted:#9fb1c9; 
            --line:#1e2b43; 
            --surface:rgba(22,30,48,.65); 
            --glass:rgba(18,24,39,.50); 
            --shadow:0 18px 42px rgba(0,0,0,.35);
        }

        body.compact{
            --radius:14px; 
            --radius-sm:10px
        }

        *{box-sizing:border-box}
        html,body{height:100%}
        body{
            margin:0; 
            color:var(--ink); 
            font:16px/1.65 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif; 
            background: radial-gradient(900px 500px at -10% -10%, rgba(117,87,255,.10), transparent 60%), radial-gradient(800px 460px at 110% 10%, rgba(52,210,255,.10), transparent 50%), linear-gradient(180deg, var(--bg), var(--bg2));
        }

        a{color:inherit; text-decoration:none}
        .wrap{max-width:1380px; margin:0 auto; padding:0 16px}

        /* AppBar */
        header.appbar{position:sticky; top:0; z-index:50; backdrop-filter:saturate(140%) blur(var(--blur)); background:var(--glass); border-bottom:1px solid var(--line)}
        .bar{display:flex; align-items:center; gap:12px; padding:10px 0}
        .logo{display:flex; align-items:center; gap:10px; font-weight:900}
        .logo-badge{width:36px; height:36px; border-radius:10px; background:linear-gradient(135deg,var(--accent), var(--accent-2)); color:#fff; display:grid; place-items:center; box-shadow:var(--shadow)}
        .search{flex:1; display:flex; gap:8px; background:var(--surface); border:1px solid var(--line); border-radius:12px; padding:8px 10px}
        .search input{flex:1; background:transparent; border:0; outline:0; color:inherit}
        .main-nav{display:flex; gap:8px; flex-wrap:wrap}
        .pill{display:inline-flex; align-items:center; gap:6px; border:1px solid var(--line); background:var(--surface); padding:8px 12px; border-radius:999px; font-weight:700; transition:all 0.2s ease}
        .pill.on{background:linear-gradient(90deg,#3b82f6,#a78bfa); color:#fff; border-color:transparent}
        .pill:hover{background:linear-gradient(90deg,#3b82f6,#a78bfa); color:#fff; border-color:transparent}
        .top-actions{display:flex; gap:8px; align-items:center}
        .btn{border:1px solid var(--line); background:var(--surface); padding:8px 12px; border-radius:12px; cursor:pointer; transition:all 0.2s ease}
        .btn.primary{border:0; background:linear-gradient(135deg,var(--accent),#3b82f6); color:#fff; box-shadow:var(--shadow)}
        .btn.link{background:transparent; border:1px dashed var(--line)}
        .btn:hover{transform:translateY(-2px); box-shadow:var(--shadow)}
        .switch{display:flex; align-items:center; gap:6px; font-size:13px}
        .dot{width:16px; height:16px; border-radius:50%; border:1px solid var(--line); cursor:pointer}
        .dot.c1{background:#7557ff}.dot.c2{background:#34d2ff}.dot.c3{background:#22c55e}

        /* Tilesï¼ˆå½©è‰²çœ‹æ¿ï¼‰ */
        .tiles{padding:16px 0}
        .grid-tiles{display:grid; gap:12px; grid-template-columns:repeat(6, minmax(0,1fr))}
        @@media (max-width:1100px){.grid-tiles{grid-template-columns:repeat(4, minmax(0,1fr))}}
        @@media (max-width:740px){.grid-tiles{grid-template-columns:repeat(2, minmax(0,1fr))}}
        .tile{position:relative; min-height:120px; border-radius:16px; padding:14px; overflow:hidden; display:flex; flex-direction:column; justify-content:space-between; cursor:pointer; background:var(--glass); border:1px solid var(--line); backdrop-filter:blur(var(--blur)); transition:transform .16s ease, box-shadow .16s ease, filter .2s ease; box-shadow:var(--shadow)}
        .tile:hover{transform:translateY(-3px) scale(1.01)}
        .tile .name{font-weight:900}
        .tile .meta{color:var(--muted); font-size:12px}
        .mini{background:rgba(255,255,255,.65); padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line)}
        body.dark .mini{background:rgba(0,0,0,.25); color:#e5edff}

        /* å½©è‰²æ¼¸å±¤ï¼ˆçœ‹æ¿ï¼‰ */
        .tile.colorful:nth-child(1){background:linear-gradient(135deg,#4f46e5,#22d3ee)}
        .tile.colorful:nth-child(2){background:linear-gradient(135deg,#f43f5e,#f59e0b)}
        .tile.colorful:nth-child(3){background:linear-gradient(135deg,#22c55e,#16a34a)}
        .tile.colorful:nth-child(4){background:linear-gradient(135deg,#8b5cf6,#06b6d4)}
        .tile.colorful:nth-child(5){background:linear-gradient(135deg,#f97316,#ef4444)}
        .tile.colorful:nth-child(6){background:linear-gradient(135deg,#06b6d4,#3b82f6)}
        .tile.colorful .name,.tile.colorful .meta,.tile.colorful .mini{color:#fff}
        .tile.colorful .mini{background:rgba(255,255,255,.25); border-color:rgba(255,255,255,.35)}

        /* Hotï¼ˆæ©«å‘ï¼‰ */
        .hot{background:var(--glass); border:1px solid var(--line); border-radius:16px; padding:14px; backdrop-filter:blur(var(--blur)); box-shadow:var(--shadow)}
        .head{display:flex; align-items:center; gap:10px; margin-bottom:10px}
        .kicker{font-size:12px; letter-spacing:.12em; color:#6366f1}
        .scroller{display:flex; gap:12px; overflow:auto; scroll-snap-type:x mandatory; padding-bottom:6px}
        .card{min-width:280px; background:var(--surface); border:1px solid var(--line); border-radius:16px; padding:12px; scroll-snap-align:start; transition:transform .16s ease, box-shadow .16s ease}
        .card:hover{transform:translateY(-3px) scale(1.01); box-shadow:var(--shadow)}

        /* Main layout */
        main{margin:16px 0 28px}
        .layout{display:grid; grid-template-columns:1fr 360px; gap:16px}
        @@media (max-width:980px){.layout{grid-template-columns:1fr}}
        .panel{background:var(--surface); border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow); padding:14px; backdrop-filter:blur(var(--blur))}
        .panel .hd{display:flex; align-items:center; gap:10px; margin-bottom:10px}
        .panel .title{font-weight:900}
        .seg{display:inline-flex; border:1px solid var(--line); border-radius:999px; overflow:hidden; margin-left:auto}
        .seg button{background:transparent; border:0; color:var(--muted); padding:6px 10px; cursor:pointer}
        .seg .on{background:#1f7ae0; color:#fff}
        .feed{display:grid; gap:10px}
        .row{display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center; border:1px solid var(--line); border-radius:14px; padding:10px; background:var(--bg2); transition:transform .16s ease, box-shadow .16s ease}
        .row:hover{transform:translateY(-3px) scale(1.01); box-shadow:var(--shadow)}
        .av{width:40px; height:40px; border-radius:12px; background:linear-gradient(135deg,#bae6fd,#e9d5ff); display:grid; place-items:center; font-weight:900; color:#334155}
        .meta{display:flex; gap:8px; flex-wrap:wrap; color:var(--muted); font-size:13px; margin-top:2px}
        .chip{border:1px solid var(--line); padding:2px 8px; border-radius:999px; background:var(--surface)}
        .ghost{border:1px solid var(--line); background:var(--surface); border-radius:10px; padding:6px 10px}

        /* ç½®é ‚å€ */
        .pinned{border:2px dashed #c4b5fd; background:rgba(196,181,253,.15); padding:10px; border-radius:12px}
        .pinned .row{background:transparent}

        /* å³å´ï¼šåŸæœ‰é»æ€§ã€å€‹åˆ¥å¡ç‰‡å¯å† sticky */
        .right{align-self:start; position:sticky; top:calc(50vh - 320px)}
        .stack{display:flex; flex-direction:column; gap:16px}

        /* è·‘é¦¬ç‡ˆ */
        .ticker{position:relative; overflow:hidden; border:1px solid var(--line); background:var(--surface); border-radius:12px}
        .ticker .track{display:flex; gap:32px; padding:10px 12px; white-space:nowrap; animation:ticker 10s linear infinite}
        @@keyframes ticker{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}

        /* æ’è¡Œæ¦œ */
        .list{display:flex; flex-direction:column; gap:8px}
        .rrow{position:relative; display:grid; grid-template-columns:40px 1fr auto; gap:10px; align-items:center; border:1px solid var(--line); background:var(--bg2); border-radius:12px; padding:10px; overflow:hidden}
        .rank{font-weight:900; text-align:center}
        .delta{text-align:right; min-width:64px; font-weight:800}
        .up{color:var(--ok)} .down{color:var(--down)} .flat{color:var(--flat)}
        .rrow.top::before{content:""; position:absolute; inset:0; pointer-events:none; z-index:0; opacity:.9; filter:blur(14px)}
        .rrow.top1::before{background:linear-gradient(90deg,var(--goldA),transparent 60%)}
        .rrow.top2::before{background:linear-gradient(90deg,var(--silverA),transparent 60%)}
        .rrow.top3::before{background:linear-gradient(90deg,var(--bronzeA),transparent 60%)}
        .rrow.top1 .rank, .rrow.top1 .title-2{color:var(--gold)}
        .rrow.top2 .rank, .rrow.top2 .title-2{color:var(--silver)}
        .rrow.top3 .rank, .rrow.top3 .title-2{color:var(--bronze)}
        .rrow > *{position:relative; z-index:1}

        /* æˆ‘çš„å²èŠå§†å¡ç‰‡ */
        .gc-right-sticky{position: sticky; top:16px;}
        .gc-pet-card{
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            background:#1f2430;
            color:#e9ecf1;
            border:1px solid #0006;
            border-radius:12px;
            box-shadow:0 8px 24px #0004, inset 0 1px 0 #fff1;
            padding:12px;
            width:100%;
        }
        .gc-pet-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;}
        .gc-pet-title{font-weight:700; letter-spacing:.5px;}
        .gc-sub{color:#aeb6d9;}
        .gc-coins{background:#262d3d; border:1px solid #0006; padding:4px 8px; border-radius:999px;}
        .gc-pet-canvas-wrap{display:flex; justify-content:center; margin:6px 0 10px;}
        #gc-pet-canvas{image-rendering: pixelated; width:160px; height:160px; background:#9ee37d; border:1px solid #0006; border-radius:8px;}
        .gc-stats{display:grid; grid-template-columns:1fr; gap:6px; margin-bottom:8px;}
        .gc-stat{display:grid; grid-template-columns:auto 1fr auto; gap:8px; align-items:center;}
        .gc-bar{height:10px; background:#2b3142; border:1px solid #0008; border-radius:6px; overflow:hidden;}
        .gc-bar i{display:block; height:100%; width:0%; background:linear-gradient(90deg,#6de38d,#35c47e); transition:width .25s;}
        .gc-bar.warn i{background:linear-gradient(90deg,#ffd159,#ffba4b);}
        .gc-bar.bad i{background:linear-gradient(90deg,#ff7b72,#ff5d6a);}
        .gc-actions{display:grid; grid-template-columns:repeat(5,1fr); gap:6px; margin-bottom:8px;}
        .gc-actions button{background:#2e3440; color:#fff; border:1px solid #0006; border-radius:10px; padding:8px 6px; cursor:pointer; transition:all 0.2s ease;}
        .gc-actions button:hover{background:#3b4252; transform:translateY(-1px);}
        .gc-actions .gc-accent{background:#5661ff; grid-column:span 5;}
        .gc-log{list-style:none; padding:8px; margin:0; max-height:120px; overflow:auto; background:#262d3d; border:1px solid #0006; border-radius:10px; font-size:12px; color:#c7d0ff;}
        .gc-log li{margin:0 0 6px;}
        .gc-log .warn{color:#ffe08a;}
        .gc-log .bad{color:#ff9b93;}

        /* Modal */
        .modal{position:fixed; inset:0; background:rgba(8,12,20,.85); display:none; align-items:center; justify-content:center; padding:24px; z-index:9999}
        .modal.show{display:flex}
        .modal .panel{position:relative; background:var(--surface); border:1px solid var(--line); border-radius:20px; max-width:980px; width:100%; max-height:86vh; overflow:auto; padding:18px 18px 22px; display:flex; flex-direction:column; gap:12px; backdrop-filter:blur(var(--blur))}
        .closeX{position:absolute; top:12px; right:12px; border:1px solid var(--line); background:var(--surface); border-radius:50%; width:36px; height:36px; cursor:pointer; display:grid; place-items:center}

        footer{color:var(--muted); text-align:center; padding:20px 0; border-top:1px solid var(--line)}
    </style>
</head>
<body>
    <!-- AppBar -->
    <header class="appbar">
        <div class="wrap bar">
            <a class="logo" href="/"><span class="logo-badge">GC</span><span>GameCore</span></a>
            
            <form class="search" method="get" action="/Search">
                <input name="q" type="search" placeholder="æœå°‹æ–‡ç«  / åˆ†å€ / æ¨™ç±¤â€¦" aria-label="æœå°‹"/>
                <button type="submit" class="btn">æœå°‹</button>
            </form>
            
            <nav class="main-nav" aria-label="ä¸»å°è¦½">
                <a class="pill" href="/Profile">å€‹äººä¸­å¿ƒ</a>
                <a class="pill" href="/SignIn">æ¯æ—¥ç°½åˆ°</a>
                <a class="pill on" href="/Forum">è«–å£‡</a>
                <a class="pill" href="/Pet">æˆ‘çš„å²èŠå§†</a>
                <a class="pill" href="/Store">å®˜æ–¹å•†åŸ</a>
                <a class="pill" href="/Market">ç©å®¶å¸‚é›†</a>
                <a class="pill" href="/Rankings">æ’è¡Œæ¦œ</a>
            </nav>
            
            <div class="top-actions">
                @if (User.Identity?.IsAuthenticated == true)
                {
                    <span>æ­¡è¿, @User.Identity.Name</span>
                    <a href="/Account/Logout" class="btn">ç™»å‡º</a>
                }
                else
                {
                    <a href="/Account/Login" class="btn primary">ç™»å…¥</a>
                    <a href="/Account/Register" class="btn">è¨»å†Š</a>
                }
                <label class="switch"><input id="t-dark" type="checkbox"/> æ·±è‰²</label>
                <label class="switch"><input id="t-density" type="checkbox"/> ç·Šæ¹Š</label>
                <div class="switch" title="ä¸»è‰²">
                    <span class="dot c1" data-accent="#7557ff"></span>
                    <span class="dot c2" data-accent="#34d2ff"></span>
                    <span class="dot c3" data-accent="#22c55e"></span>
                </div>
                <button class="btn primary" id="btnNew">ï¼‹ ç™¼è¡¨ä¸»é¡Œ</button>
            </div>
        </div>
    </header>

    <!-- çœ‹æ¿ Tiles -->
    <section class="wrap tiles" aria-label="çœ‹æ¿å½©è‰²å°å¡">
        <div class="grid-tiles" id="tileGrid"></div>
    </section>

    <!-- Hot Threads -->
    <section class="wrap">
        <article class="hot">
            <div class="head"><span class="kicker">Hot Threads</span><strong>ç†±é–€ç²¾é¸</strong></div>
            <div class="scroller" id="hotScroller"></div>
        </article>
    </section>

    <!-- Main -->
    <main class="wrap layout">
        <!-- ä¸­æ¬„ï¼šæ–‡ç«  Feed -->
        <section class="panel">
            <div class="hd">
                <div class="title">æœ€æ–°æ–‡ç« </div>
                <span id="feedCount" class="muted" style="margin-left:8px"></span>
                <div class="seg" role="tablist" aria-label="å¿«é€Ÿç¯©é¸">
                    <button id="all" class="on" aria-selected="true">å…¨éƒ¨</button>
                    <button id="lol">LOL</button>
                    <button id="steam">Steam</button>
                    <button id="mobile">æ‰‹éŠ</button>
                    <button id="genshin">åŸç¥</button>
                    <button id="mood">å¿ƒæƒ…æ¿</button>
                </div>
            </div>
            
            <!-- ç½®é ‚å€ -->
            <div id="pinned" class="pinned" aria-label="ç½®é ‚æ–‡ç« "></div>
            <div class="feed" id="feed"></div>
            
            <div style="text-align:center;margin-top:12px">
                <a class="btn primary" href="/Forum" id="btnMoreFeed">æŸ¥çœ‹æ›´å¤š</a>
            </div>
        </section>

        <!-- å³æ¬„ -->
        <aside class="right">
            <div class="stack">
                <!-- æˆ‘çš„å²èŠå§†å¡ç‰‡ -->
                <aside class="gc-right-sticky">
                    <div class="gc-pet-card" id="gc-pet-card">
                        <header class="gc-pet-head">
                            <div>
                                <div class="gc-pet-title">æˆ‘çš„å²èŠå§†</div>
                                <small class="gc-sub">
                                    <span id="gc-pet-name">å°å¯æ„›</span> Â· Lv.<b id="gc-pet-lv">1</b> Â· XP <b id="gc-pet-xp">0</b>/<b id="gc-pet-xpmax">50</b>
                                </small>
                            </div>
                            <div class="gc-coins">ğŸ’° <b id="gc-coins">0</b></div>
                        </header>
                        
                        <div class="gc-pet-canvas-wrap">
                            <canvas id="gc-pet-canvas" width="120" height="120"></canvas>
                        </div>
                        
                        <div class="gc-stats">
                            <div class="gc-stat"><label>é£¢é¤“</label><div class="gc-bar"><i id="bar-hunger"></i></div><span id="txt-hunger">100</span></div>
                            <div class="gc-stat"><label>å¿ƒæƒ…</label><div class="gc-bar"><i id="bar-mood"></i></div><span id="txt-mood">100</span></div>
                            <div class="gc-stat"><label>é«”åŠ›</label><div class="gc-bar"><i id="bar-energy"></i></div><span id="txt-energy">100</span></div>
                            <div class="gc-stat"><label>æ¸…æ½”</label><div class="gc-bar"><i id="bar-clean"></i></div><span id="txt-clean">100</span></div>
                            <div class="gc-stat"><label>å¥åº·</label><div class="gc-bar"><i id="bar-health"></i></div><span id="txt-health">100</span></div>
                        </div>
                        
                        <div class="gc-actions">
                            <button data-act="Feed">é¤µé£Ÿ</button>
                            <button data-act="Bath">æ´—æ¾¡</button>
                            <button data-act="Play">ç©è€</button>
                            <button data-act="Rest">ä¼‘æ¯</button>
                            <button class="gc-accent" id="gc-adv">å‡ºç™¼å†’éšªï¼ˆæ¯æ—¥ 3 æ¬¡ï¼‰</button>
                        </div>
                        
                        <ul class="gc-log" id="gc-log"></ul>
                    </div>
                </aside>

                <!-- å…¬å‘Šè·‘é¦¬ç‡ˆ -->
                <article class="ticker" aria-label="å…¬å‘Šè·‘é¦¬ç‡ˆ">
                    <div class="track" id="ticker"></div>
                </article>

                <!-- æ’è¡Œæ¦œ -->
                <article class="panel">
                    <div class="hd">
                        <div class="title">è·¨å¹³å°ç†±é–€</div>
                        <div class="seg">
                            <button id="mix7b" class="on">è¿‘ 7 å¤©</button>
                            <button id="mix30b">è¿‘ 30 å¤©</button>
                        </div>
                    </div>
                    <div id="mixList" class="list"></div>
                </article>
            </div>
        </aside>
    </main>

    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="panel">
            <button class="closeX" id="closeModal">Ã—</button>
            <div id="modalContent"></div>
        </div>
    </div>

    <footer class="wrap">Â© 2025 GameCore â€” éŠæˆ²ç¤¾ç¾¤å¹³å°</footer>

    <script>
        // GameCore ä¸»è¦ JavaScript é‚è¼¯
        class GameCore {
            constructor() {
                this.pet = null;
                this.userPoints = 0;
                this.init();
            }

            async init() {
                await this.loadPetData();
                await this.loadUserData();
                this.bindEvents();
                this.startPetAnimation();
                this.loadForumData();
                this.setupThemeToggle();
            }

            // è¼‰å…¥å¯µç‰©è³‡æ–™
            async loadPetData() {
                try {
                    const response = await fetch('/api/pet');
                    if (response.ok) {
                        this.pet = await response.json();
                        this.updatePetUI();
                    } else {
                        console.log('æœªç™»å…¥æˆ–ç„¡å¯µç‰©è³‡æ–™ï¼Œä½¿ç”¨é è¨­å€¼');
                        this.pet = this.getDefaultPet();
                        this.updatePetUI();
                    }
                } catch (error) {
                    console.error('è¼‰å…¥å¯µç‰©è³‡æ–™å¤±æ•—:', error);
                    this.pet = this.getDefaultPet();
                    this.updatePetUI();
                }
            }

            // è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
            async loadUserData() {
                try {
                    const response = await fetch('/api/wallet/balance');
                    if (response.ok) {
                        const data = await response.json();
                        this.userPoints = data.balance || 0;
                        document.getElementById('gc-coins').textContent = this.userPoints;
                    }
                } catch (error) {
                    console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™å¤±æ•—:', error);
                }
            }

            // é è¨­å¯µç‰©è³‡æ–™
            getDefaultPet() {
                return {
                    name: 'å°å¯æ„›',
                    level: 1,
                    experience: 0,
                    nextLevelExp: 100,
                    hunger: 100,
                    mood: 100,
                    stamina: 100,
                    cleanliness: 100,
                    health: 100,
                    skinColor: '#f6d84a',
                    backgroundColor: '#79b7ff'
                };
            }

            // æ›´æ–°å¯µç‰© UI
            updatePetUI() {
                if (!this.pet) return;

                document.getElementById('gc-pet-name').textContent = this.pet.name;
                document.getElementById('gc-pet-lv').textContent = this.pet.level;
                document.getElementById('gc-pet-xp').textContent = this.pet.experience;
                document.getElementById('gc-pet-xpmax').textContent = this.pet.nextLevelExp;

                this.updateStatBar('hunger', this.pet.hunger);
                this.updateStatBar('mood', this.pet.mood);
                this.updateStatBar('energy', this.pet.stamina);
                this.updateStatBar('clean', this.pet.cleanliness);
                this.updateStatBar('health', this.pet.health);
            }

            // æ›´æ–°å±¬æ€§æ¢
            updateStatBar(statName, value) {
                const bar = document.getElementById(`bar-${statName}`);
                const text = document.getElementById(`txt-${statName}`);
                
                if (bar && text) {
                    const clampedValue = Math.max(0, Math.min(100, value));
                    text.textContent = clampedValue;
                    bar.style.width = clampedValue + '%';
                    
                    const barContainer = bar.parentElement;
                    barContainer.classList.remove('warn', 'bad');
                    
                    if (clampedValue < 20) {
                        barContainer.classList.add('bad');
                    } else if (clampedValue < 40) {
                        barContainer.classList.add('warn');
                    }
                }
            }

            // ç¶å®šäº‹ä»¶
            bindEvents() {
                // å¯µç‰©äº’å‹•æŒ‰éˆ•
                document.querySelectorAll('.gc-actions button[data-act]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const action = e.target.getAttribute('data-act');
                        this.performPetInteraction(action);
                    });
                });

                // å†’éšªæŒ‰éˆ•
                document.getElementById('gc-adv')?.addEventListener('click', () => {
                    this.startAdventure();
                });

                // ä¸»é¡Œåˆ‡æ›
                document.getElementById('t-dark')?.addEventListener('change', (e) => {
                    document.body.classList.toggle('dark', e.target.checked);
                });

                document.getElementById('t-density')?.addEventListener('change', (e) => {
                    document.body.classList.toggle('compact', e.target.checked);
                });

                // ä¸»è‰²åˆ‡æ›
                document.querySelectorAll('.dot').forEach(dot => {
                    dot.addEventListener('click', () => {
                        const accent = dot.getAttribute('data-accent');
                        document.documentElement.style.setProperty('--accent', accent);
                    });
                });
            }

            // åŸ·è¡Œå¯µç‰©äº’å‹•
            async performPetInteraction(action) {
                try {
                    const response = await fetch('/api/pet/interact', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ action: action })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        
                        // æ›´æ–°å¯µç‰©ç‹€æ…‹
                        if (result.pet) {
                            this.pet.hunger = result.pet.hunger;
                            this.pet.mood = result.pet.mood;
                            this.pet.stamina = result.pet.stamina;
                            this.pet.cleanliness = result.pet.cleanliness;
                            this.pet.health = result.pet.health;
                            this.updatePetUI();
                        }

                        this.addLog(result.message);
                        
                        if (result.healthRestored) {
                            this.addLog('ğŸŒŸ å››ç¶­å±¬æ€§å…¨æ»¿ï¼å¥åº·åº¦å®Œå…¨æ¢å¾©ï¼', 'good');
                        }

                        // æ’­æ”¾äº’å‹•å‹•ç•«
                        this.playInteractionAnimation(action);
                    } else {
                        const error = await response.json();
                        this.addLog(error.message || 'äº’å‹•å¤±æ•—', 'warn');
                    }
                } catch (error) {
                    console.error('å¯µç‰©äº’å‹•å¤±æ•—:', error);
                    this.addLog('äº’å‹•å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'warn');
                }
            }

            // é–‹å§‹å†’éšª
            async startAdventure() {
                try {
                    // å…ˆæª¢æŸ¥æ˜¯å¦å¯ä»¥å†’éšª
                    const checkResponse = await fetch('/api/pet/can-adventure');
                    if (checkResponse.ok) {
                        const checkResult = await checkResponse.json();
                        if (!checkResult.canAdventure) {
                            this.addLog(checkResult.message, 'warn');
                            return;
                        }
                    }

                    // è·³è½‰åˆ°å°éŠæˆ²é é¢
                    window.location.href = '/MiniGame';
                } catch (error) {
                    console.error('æª¢æŸ¥å†’éšªæ¢ä»¶å¤±æ•—:', error);
                    this.addLog('ç„¡æ³•é–‹å§‹å†’éšªï¼Œè«‹ç¨å¾Œå†è©¦', 'warn');
                }
            }

            // æ’­æ”¾äº’å‹•å‹•ç•«
            playInteractionAnimation(action) {
                const canvas = document.getElementById('gc-pet-canvas');
                if (canvas) {
                    canvas.style.transform = 'scale(1.05)';
                    setTimeout(() => {
                        canvas.style.transform = 'scale(1)';
                    }, 200);
                }
            }

            // æ·»åŠ æ—¥èªŒ
            addLog(message, type = 'info') {
                const logContainer = document.getElementById('gc-log');
                if (!logContainer) return;

                const li = document.createElement('li');
                if (type !== 'info') {
                    li.className = type;
                }
                li.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
                
                logContainer.insertBefore(li, logContainer.firstChild);
                
                // é™åˆ¶æ—¥èªŒæ•¸é‡
                while (logContainer.children.length > 10) {
                    logContainer.removeChild(logContainer.lastChild);
                }
            }

            // é–‹å§‹å¯µç‰©å‹•ç•«
            startPetAnimation() {
                const canvas = document.getElementById('gc-pet-canvas');
                const ctx = canvas?.getContext('2d');
                if (!canvas || !ctx) return;

                ctx.imageSmoothingEnabled = false;
                let frame = 0;

                const animate = () => {
                    frame++;
                    this.drawPet(ctx, canvas.width, canvas.height, frame);
                    requestAnimationFrame(animate);
                };

                animate();
            }

            // ç¹ªè£½å¯µç‰© (åƒç´ é¢¨æ ¼å²èŠå§†)
            drawPet(ctx, width, height, frame) {
                if (!this.pet) return;

                // æ¸…ç©ºç•«å¸ƒ
                ctx.fillStyle = this.pet.backgroundColor || '#79b7ff';
                ctx.fillRect(0, 0, width, height);

                // ç¹ªè£½åœ°é¢
                ctx.fillStyle = '#91e27c';
                ctx.fillRect(0, height - 36, width, 36);

                // è¨ˆç®—å²èŠå§†ä½ç½® (æµ®å‹•æ•ˆæœ)
                const baseY = height - 36 - 44;
                const floatY = baseY + Math.sin(frame / 12) * 2;

                // ç¹ªè£½å²èŠå§†èº«é«”
                ctx.fillStyle = this.pet.skinColor || '#f6d84a';
                ctx.fillRect(40, floatY, 40, 34);

                // ç¹ªè£½é™°å½±
                ctx.fillStyle = '#e1c146';
                ctx.fillRect(40, floatY + 4, 40, 3);

                // ç¹ªè£½è¼ªå»“
                ctx.fillStyle = '#000';
                this.drawPixelBorder(ctx, 40, floatY, 40, 34);

                // ç¹ªè£½çœ¼ç› (çœ¨çœ¼æ•ˆæœ)
                const blinkFrame = (frame % 120 < 6) ? 1 : 3;
                this.drawEye(ctx, 52, floatY + 10, blinkFrame);
                this.drawEye(ctx, 66, floatY + 10, blinkFrame);

                // ç¹ªè£½å˜´å·´ (æ ¹æ“šå¿ƒæƒ…)
                this.drawMouth(ctx, floatY + 22);

                // ç¹ªè£½æ±¡å¢ (æ ¹æ“šæ¸…æ½”åº¦)
                if (this.pet.cleanliness < 50) {
                    this.drawDirt(ctx, floatY);
                }

                // ç¹ªè£½ç¡çœ æ•ˆæœ (æ ¹æ“šé«”åŠ›)
                if (this.pet.stamina < 20) {
                    this.drawSleepEffect(ctx, floatY);
                }
            }

            // ç¹ªè£½åƒç´ é‚Šæ¡†
            drawPixelBorder(ctx, x, y, w, h) {
                ctx.fillRect(x - 1, y - 1, w + 2, 1);
                ctx.fillRect(x - 1, y + h, w + 2, 1);
                ctx.fillRect(x - 1, y - 1, 1, h + 2);
                ctx.fillRect(x + w, y - 1, 1, h + 2);
            }

            // ç¹ªè£½çœ¼ç›
            drawEye(ctx, x, y, height) {
                ctx.fillStyle = '#fff';
                ctx.fillRect(x - 1, y - 1, 5, height + 2);
                
                ctx.fillStyle = '#000';
                ctx.fillRect(x - 2, y - 2, 7, 1);
                ctx.fillRect(x - 2, y + height + 1, 7, 1);
                ctx.fillRect(x - 2, y - 2, 1, height + 4);
                ctx.fillRect(x + 4, y - 2, 1, height + 4);
                
                if (height > 1) {
                    ctx.fillRect(x + 1, y, 1, height);
                }
            }

            // ç¹ªè£½å˜´å·´
            drawMouth(ctx, y) {
                ctx.fillStyle = '#000';

                if (this.pet.mood >= 60) {
                    // é–‹å¿ƒï¼šå¾®ç¬‘
                    ctx.fillRect(57, y, 8, 1);
                    ctx.fillRect(59, y + 1, 4, 1);
                } else if (this.pet.mood >= 30) {
                    // æ™®é€šï¼šç›´ç·š
                    ctx.fillRect(57, y, 8, 1);
                } else {
                    // é›£éï¼šå€’ç¬‘
                    ctx.fillRect(57, y + 1, 8, 1);
                    ctx.fillRect(59, y, 4, 1);
                }
            }

            // ç¹ªè£½æ±¡å¢
            drawDirt(ctx, baseY) {
                ctx.fillStyle = '#7f6a2a';
                ctx.fillRect(46, baseY + 18, 2, 2);
                ctx.fillRect(72, baseY + 14, 1, 2);
            }

            // ç¹ªè£½ç¡çœ æ•ˆæœ
            drawSleepEffect(ctx, baseY) {
                ctx.fillStyle = '#fff';
                ctx.font = '10px monospace';
                ctx.fillText('Z', 86, baseY + 6);
                ctx.fillText('z', 92, baseY + 12);
            }

            // è¼‰å…¥è«–å£‡è³‡æ–™ (å‡è³‡æ–™å±•ç¤º)
            loadForumData() {
                this.loadBoards();
                this.loadHotThreads();
                this.loadTicker();
                this.loadFeed();
                this.loadRankings();
            }

            loadBoards() {
                const boards = [
                    {key:'lol', name:'è‹±é›„è¯ç›Ÿ', intro:'ç‰ˆæœ¬æƒ…å ±ã€é›»ç«¶è³½äº‹ã€æ•™å­¸æ”»ç•¥'},
                    {key:'genshin', name:'åŸç¥', intro:'è§’è‰²é…éšŠã€æŠ½å¡å¿ƒå¾—ã€ä¸–ç•Œæ¢ç´¢'},
                    {key:'steam', name:'Steam ç¶œåˆ', intro:'ä¿ƒéŠ·æƒ…å ±ã€éŠæˆ²å¿ƒå¾—ã€å¯¦æ³è¨è«–'},
                    {key:'mobile', name:'æ‰‹æ©ŸéŠæˆ²', intro:'Android / iOS æ‰‹éŠè¨è«–'},
                    {key:'general', name:'ç¶œåˆè¨è«–', intro:'ç¡¬é«”å¤–è¨­ã€é›œè«‡çŒæ°´ã€æ±‚åŠ©å•ç­”'},
                    {key:'mood', name:'å¿ƒæƒ…æ¿', intro:'æ—¥å¸¸ã€å‘Šç™½ã€ç¢ç¢å¿µã€æŠ±æ€¨'}
                ];

                const tileGrid = document.getElementById('tileGrid');
                if (tileGrid) {
                    tileGrid.innerHTML = boards.map((b, i) => `
                                        <a class="tile colorful" href="/Forum/${b.key}" data-board="${b.key}">
                    <div class="name">${b.name}</div>
                    <div class="meta">${b.intro}</div>
                    <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:6px">
                        <span class="mini">ä»Šæ—¥æ–°è²¼ ${Math.floor(Math.random()*40)+6}</span>
                        <span class="mini">æ´»èº ${Math.floor(Math.random()*200)+40}</span>
                    </div>
                </a>
                    `).join('');
                }
            }

            loadHotThreads() {
                const hotThreads = [
                    'ã€æ”»ç•¥ã€‘æ–°æ‰‹å…¥é–€å®Œæ•´æŒ‡å— - å¾é›¶é–‹å§‹çš„éŠæˆ²ä¹‹è·¯',
                    'ã€æƒ…å ±ã€‘ä¸‹é€±ç‰ˆæœ¬æ›´æ–°å…§å®¹æ¶å…ˆçœ‹',
                    'ã€å¿ƒå¾—ã€‘ä¸‰å€‹æœˆéŠæˆ²å¿ƒå¾—åˆ†äº«',
                    'ã€è¨è«–ã€‘å¤§å®¶æœ€å–œæ­¡çš„è§’è‰²æ˜¯èª°ï¼Ÿ',
                    'ã€æ´»å‹•ã€‘ç¤¾ç¾¤æ´»å‹•é–‹è·‘ï¼Œè±å¯Œçå“ç­‰ä½ æ‹¿ï¼'
                ];

                const hotScroller = document.getElementById('hotScroller');
                if (hotScroller) {
                    hotScroller.innerHTML = hotThreads.map(title => `
                        <article class="card">
                            <div style="font-weight:900">${title}</div>
                            <div style="color:var(--muted); font-size:13px">é»æ“ŠæŸ¥çœ‹å®Œæ•´å…§å®¹...</div>
                            <div style="display:flex; gap:8px; margin-top:8px">
                                <span class="chip">ç†±é–€</span>
                                <span class="chip">ç²¾è¯</span>
                            </div>
                        </article>
                    `).join('');
                }
            }

            loadTicker() {
                const bulletins = [
                    'ã€æ´»å‹•ã€‘æŠ•ç¨¿æœ€ä½³æ”»ç•¥è´éµç›¤æ»‘é¼ çµ„',
                    'ã€å…¬å‘Šã€‘ç«™å‹™è¦ç¯„æ›´æ–°ï¼Œè«‹å‹¿å¼µè²¼æ”»æ“Šæ€§è¨€è«–',
                    'ã€ç¤¾ç¾¤ã€‘æœ¬æœˆé”æ¨™ 2,000 å‰‡å„ªè³ªå›è¦†ï¼Œæ„Ÿè¬å¤§å®¶ï¼',
                    'ã€ä¿®å¾©ã€‘è¡Œå‹•ç«¯å¡ç‰‡é‡ç–Šå•é¡Œå·²ä¿®æ­£'
                ];

                const ticker = document.getElementById('ticker');
                if (ticker) {
                    const twice = bulletins.concat(bulletins);
                    ticker.innerHTML = twice.map(t => `<span>ğŸ”” ${t}</span>`).join('<span>Â·</span>');
                }
            }

            loadFeed() {
                // è¼‰å…¥æ–‡ç« å‹•æ…‹ (å‡è³‡æ–™)
                const posts = [
                    { title: 'æ–°ç‰ˆæœ¬è§’è‰²å¼·åº¦åˆ†æ', author: 'æ”»ç•¥å¤§å¸«', time: '2å°æ™‚å‰', likes: 128, replies: 45 },
                    { title: 'é€±æœ«æ´»å‹•å¿ƒå¾—åˆ†äº«', author: 'éŠæˆ²ç©å®¶', time: '4å°æ™‚å‰', likes: 89, replies: 23 },
                    { title: 'è£å‚™æ­é…æ¨è–¦æŒ‡å—', author: 'å°ˆæ¥­ç©å®¶', time: '6å°æ™‚å‰', likes: 156, replies: 67 }
                ];

                const feed = document.getElementById('feed');
                if (feed) {
                    feed.innerHTML = posts.map(post => `
                        <article class="row">
                            <div class="av">${post.author[0]}</div>
                            <div>
                                <div style="font-weight:900">${post.title}</div>
                                <div class="meta">
                                    <span>${post.author}</span>
                                    <span>ï½œ</span>
                                    <span>${post.time}</span>
                                </div>
                            </div>
                            <div style="display:flex; gap:8px">
                                <span class="ghost">â¤ï¸ ${post.likes}</span>
                                <span class="ghost">ğŸ’¬ ${post.replies}</span>
                            </div>
                        </article>
                    `).join('');
                }
            }

            loadRankings() {
                const rankings = [
                    {name:'Elden Ring: Shadow', delta:+3},
                    {name:'Honkai: Star Rail', delta:+1},
                    {name:'Genshin Impact', delta:-1},
                    {name:'League of Legends', delta:+2},
                    {name:'Valorant', delta:0}
                ];

                const mixList = document.getElementById('mixList');
                if (mixList) {
                    mixList.innerHTML = rankings.map((game, i) => {
                        const cls = i < 3 ? `top top${i+1}` : '';
                        const sign = game.delta > 0 ? 'â–²' : game.delta < 0 ? 'â–¼' : 'â€“';
                        const dcls = game.delta > 0 ? 'up' : game.delta < 0 ? 'down' : 'flat';
                        const deltaText = game.delta === 0 ? '0' : Math.abs(game.delta);
                        
                        return `
                            <div class="rrow ${cls}">
                                <div class="rank">${i+1}</div>
                                <div class="title-2">${game.name}</div>
                                <div class="delta ${dcls}">${sign} ${deltaText}</div>
                            </div>
                        `;
                    }).join('');
                }
            }

            setupThemeToggle() {
                // è¨­å®šä¸»é¡Œåˆ‡æ›é‚è¼¯å·²åœ¨ bindEvents ä¸­å¯¦ä½œ
            }
        }

        // åˆå§‹åŒ– GameCore
        document.addEventListener('DOMContentLoaded', () => {
            new GameCore();
        });
    </script>
</body>
</html>
