@model GameCore.Web.Controllers.WalletMvcController.SalesWalletViewModel
@{
    ViewData["Title"] = "éŠ·å”®éŒ¢åŒ…ç®¡ç†";
}

<div class="container-fluid">
    <!-- é é¢æ¨™é¡Œ -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-store text-primary"></i>
                éŠ·å”®éŒ¢åŒ…ç®¡ç†
            </h1>
            <p class="text-muted">ç®¡ç†æ‚¨çš„éŠ·å”®éŒ¢åŒ…å’ŒæŸ¥çœ‹éŠ·å”®çµ±è¨ˆ</p>
        </div>
    </div>

    <!-- éŠ·å”®éŒ¢åŒ…æ¦‚è¦½ -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                éŠ·å”®éŒ¢åŒ…é¤˜é¡
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @Model.SalesWallet.UserSalesWallet.ToString("N0") é»
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-wallet fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                æœ¬æœˆéŠ·å”®é¡
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @Model.SalesStatistics.MonthlySales.ToString("N0") é»
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                æœ¬æœˆè¨‚å–®æ•¸
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @Model.SalesStatistics.MonthlyOrders.ToString("N0")
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-shopping-cart fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                å¹³å‡è¨‚å–®é‡‘é¡
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @Model.SalesStatistics.AverageOrderValue.ToString("N0") é»
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calculator fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¿«é€Ÿæ“ä½œ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">å¿«é€Ÿæ“ä½œ</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <button type="button" class="btn btn-success btn-block" data-toggle="modal" data-target="#transferToSalesModal">
                                <i class="fas fa-arrow-right"></i>
                                è½‰ç§»åˆ°éŠ·å”®éŒ¢åŒ…
                            </button>
                        </div>
                        <div class="col-md-3 mb-3">
                            <button type="button" class="btn btn-warning btn-block" data-toggle="modal" data-target="#withdrawFromSalesModal">
                                <i class="fas fa-arrow-left"></i>
                                å¾éŠ·å”®éŒ¢åŒ…æé ˜
                            </button>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="/market" class="btn btn-primary btn-block">
                                <i class="fas fa-store"></i>
                                å‰å¾€ç©å®¶å¸‚å ´
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="@Url.Action("Index", "WalletMvc")" class="btn btn-secondary btn-block">
                                <i class="fas fa-arrow-left"></i>
                                è¿”å›éŒ¢åŒ…
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- éŠ·å”®çµ±è¨ˆåœ–è¡¨ -->
    <div class="row">
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">éŠ·å”®è¶¨å‹¢åœ–</h6>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="salesTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- éŠ·å”®æ’è¡Œæ¦œ -->
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">æœ¬æœˆéŠ·å”®æ’è¡Œæ¦œ</h6>
                </div>
                <div class="card-body">
                    <div id="salesRanking">
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">è¼‰å…¥ä¸­...</span>
                            </div>
                            <p class="mt-2 text-muted">è¼‰å…¥æ’è¡Œæ¦œä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è©³ç´°çµ±è¨ˆ -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">è©³ç´°çµ±è¨ˆ</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="font-weight-bold text-primary">ç´¯è¨ˆçµ±è¨ˆ</h6>
                            <table class="table table-borderless">
                                <tr>
                                    <td>ç´¯è¨ˆéŠ·å”®é¡ï¼š</td>
                                    <td class="font-weight-bold">@Model.SalesStatistics.TotalSales.ToString("N0") é»</td>
                                </tr>
                                <tr>
                                    <td>ç´¯è¨ˆè¨‚å–®æ•¸ï¼š</td>
                                    <td class="font-weight-bold">@Model.SalesStatistics.TotalOrders.ToString("N0") ç­†</td>
                                </tr>
                                <tr>
                                    <td>å¹³å‡è¨‚å–®é‡‘é¡ï¼š</td>
                                    <td class="font-weight-bold">@Model.SalesStatistics.AverageOrderValue.ToString("N0") é»</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="font-weight-bold text-primary">æœ¬æœˆçµ±è¨ˆ</h6>
                            <table class="table table-borderless">
                                <tr>
                                    <td>æœ¬æœˆéŠ·å”®é¡ï¼š</td>
                                    <td class="font-weight-bold">@Model.SalesStatistics.MonthlySales.ToString("N0") é»</td>
                                </tr>
                                <tr>
                                    <td>æœ¬æœˆè¨‚å–®æ•¸ï¼š</td>
                                    <td class="font-weight-bold">@Model.SalesStatistics.MonthlyOrders.ToString("N0") ç­†</td>
                                </tr>
                                <tr>
                                    <td>éŠ·å”®æ¬Šé™ç‹€æ…‹ï¼š</td>
                                    <td class="font-weight-bold">
                                        <span class="badge badge-@(Model.SalesWallet.HasSalesAuthority ? "success" : "warning")">
                                            @(Model.SalesWallet.HasSalesAuthority ? "å·²å•Ÿç”¨" : "æœªå•Ÿç”¨")
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è½‰ç§»åˆ°éŠ·å”®éŒ¢åŒ… Modal -->
<div class="modal fade" id="transferToSalesModal" tabindex="-1" role="dialog" aria-labelledby="transferToSalesModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transferToSalesModalLabel">è½‰ç§»åˆ°éŠ·å”®éŒ¢åŒ…</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="transferToSalesForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="transferAmount">è½‰ç§»é‡‘é¡</label>
                        <input type="number" class="form-control" id="transferAmount" name="amount" min="1" required>
                        <small class="form-text text-muted">å¯è½‰ç§»é‡‘é¡ï¼š<span id="availableAmount">0</span> é»</small>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>æ³¨æ„ï¼š</strong>è½‰ç§»åˆ°éŠ·å”®éŒ¢åŒ…çš„é»æ•¸å°‡ç”¨æ–¼æ”¯ä»˜å¹³å°æŠ½æˆå’Œæ‰‹çºŒè²»ï¼Œè½‰ç§»å¾Œç„¡æ³•ç›´æ¥è½‰å›ä¸»éŒ¢åŒ…ã€‚
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success">ç¢ºèªè½‰ç§»</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- å¾éŠ·å”®éŒ¢åŒ…æé ˜ Modal -->
<div class="modal fade" id="withdrawFromSalesModal" tabindex="-1" role="dialog" aria-labelledby="withdrawFromSalesModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="withdrawFromSalesModalLabel">å¾éŠ·å”®éŒ¢åŒ…æé ˜</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="withdrawFromSalesForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="withdrawAmount">æé ˜é‡‘é¡</label>
                        <input type="number" class="form-control" id="withdrawAmount" name="amount" min="1" required>
                        <small class="form-text text-muted">å¯æé ˜é‡‘é¡ï¼š<span id="salesWalletAmount">0</span> é»</small>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>æ³¨æ„ï¼š</strong>æé ˜å¾Œé»æ•¸å°‡è½‰å…¥æ‚¨çš„ä¸»éŒ¢åŒ…ï¼Œå¯ç”¨æ–¼ä¸€èˆ¬æ¶ˆè²»ã€‚
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-warning">ç¢ºèªæé ˜</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // éŠ·å”®è¶¨å‹¢åœ–è¡¨
        var ctx = document.getElementById('salesTrendChart').getContext('2d');
        var salesTrendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'],
                datasets: [{
                    label: 'éŠ·å”®é¡',
                    data: [1200, 1900, 3000, 5000, 2000, 3000],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // è¼‰å…¥éŠ·å”®æ’è¡Œæ¦œ
        async function loadSalesRanking() {
            try {
                const response = await fetch('/api/sales/ranking?period=monthly&limit=5');
                if (response.ok) {
                    const ranking = await response.json();
                    displaySalesRanking(ranking);
                } else {
                    document.getElementById('salesRanking').innerHTML = '<p class="text-muted text-center">ç„¡æ³•è¼‰å…¥æ’è¡Œæ¦œ</p>';
                }
            } catch (error) {
                document.getElementById('salesRanking').innerHTML = '<p class="text-muted text-center">è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—</p>';
            }
        }

        // é¡¯ç¤ºéŠ·å”®æ’è¡Œæ¦œ
        function displaySalesRanking(ranking) {
            if (!ranking || ranking.length === 0) {
                document.getElementById('salesRanking').innerHTML = '<p class="text-muted text-center">æš«ç„¡æ’è¡Œæ¦œè³‡æ–™</p>';
                return;
            }

            let html = '';
            ranking.forEach((item, index) => {
                const rankClass = index < 3 ? `text-${index === 0 ? 'warning' : index === 1 ? 'secondary' : 'danger'}` : '';
                const rankIcon = index < 3 ? ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][index] : `${index + 1}.`;
                
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <span class="font-weight-bold ${rankClass}">${rankIcon}</span>
                            <span class="ml-2">${item.userName}</span>
                        </div>
                        <div class="text-right">
                            <div class="font-weight-bold">${item.salesAmount.toLocaleString()} é»</div>
                            <small class="text-muted">${item.orderCount} ç­†è¨‚å–®</small>
                        </div>
                    </div>
                `;
                if (index < ranking.length - 1) html += '<hr>';
            });

            document.getElementById('salesRanking').innerHTML = html;
        }

        // è½‰ç§»åˆ°éŠ·å”®éŒ¢åŒ…
        document.getElementById('transferToSalesForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const amount = parseInt(document.getElementById('transferAmount').value);
            
            try {
                const response = await fetch('/api/wallet/sales/transfer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ amount: amount })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    location.reload();
                } else {
                    const error = await response.json();
                    alert('è½‰ç§»å¤±æ•—ï¼š' + error.error);
                }
            } catch (error) {
                alert('è½‰ç§»å¤±æ•—ï¼š' + error.message);
            }
        });

        // å¾éŠ·å”®éŒ¢åŒ…æé ˜
        document.getElementById('withdrawFromSalesForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const amount = parseInt(document.getElementById('withdrawAmount').value);
            
            try {
                const response = await fetch('/api/wallet/sales/withdraw', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ amount: amount })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    location.reload();
                } else {
                    const error = await response.json();
                    alert('æé ˜å¤±æ•—ï¼š' + error.error);
                }
            } catch (error) {
                alert('æé ˜å¤±æ•—ï¼š' + error.message);
            }
        });

        // Modal é¡¯ç¤ºæ™‚æ›´æ–°é‡‘é¡
        $('#transferToSalesModal').on('show.bs.modal', function () {
            // é€™è£¡éœ€è¦å¾ä¸»éŒ¢åŒ…å–å¾—å¯è½‰ç§»é‡‘é¡ï¼Œæš«æ™‚ä½¿ç”¨å›ºå®šå€¼
            document.getElementById('availableAmount').textContent = '1000';
            document.getElementById('transferAmount').max = 1000;
        });

        $('#withdrawFromSalesModal').on('show.bs.modal', function () {
            document.getElementById('salesWalletAmount').textContent = '@Model.SalesWallet.UserSalesWallet';
            document.getElementById('withdrawAmount').max = @Model.SalesWallet.UserSalesWallet;
        });

        // é é¢è¼‰å…¥å®Œæˆå¾Œè¼‰å…¥æ’è¡Œæ¦œ
        document.addEventListener('DOMContentLoaded', function() {
            loadSalesRanking();
        });
    </script>
} 