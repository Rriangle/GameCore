@{
    ViewData["Title"] = "官方商城 - GameCore";
}

<div class="container-fluid">
    <!-- 商城標題 -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4 text-center">
                <i class="fas fa-store text-primary"></i>
                官方商城
            </h1>
            <p class="lead text-center text-muted">精選遊戲商品，品質保證</p>
        </div>
    </div>

    <!-- 搜尋和篩選 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form id="searchForm" class="row g-3">
                        <div class="col-md-4">
                            <label for="keyword" class="form-label">關鍵字</label>
                            <input type="text" class="form-control" id="keyword" placeholder="搜尋商品...">
                        </div>
                        <div class="col-md-2">
                            <label for="category" class="form-label">分類</label>
                            <select class="form-select" id="category">
                                <option value="">全部</option>
                                <option value="game">遊戲</option>
                                <option value="hardware">硬體</option>
                                <option value="accessory">配件</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="minPrice" class="form-label">最低價格</label>
                            <input type="number" class="form-control" id="minPrice" placeholder="0">
                        </div>
                        <div class="col-md-2">
                            <label for="maxPrice" class="form-label">最高價格</label>
                            <input type="number" class="form-control" id="maxPrice" placeholder="9999">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search"></i> 搜尋
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 商品列表 -->
    <div class="row" id="productsContainer">
        <!-- 商品卡片將在這裡動態載入 -->
    </div>

    <!-- 分頁 -->
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="商品分頁">
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- 分頁將在這裡動態載入 -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- 商品詳情 Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalTitle">商品詳情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="productModalBody">
                <!-- 商品詳情將在這裡載入 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                <button type="button" class="btn btn-primary" id="addToCartBtn">
                    <i class="fas fa-cart-plus"></i> 加入購物車
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentPage = 1;
        let pageSize = 12;

        // 頁面載入時取得商品列表
        $(document).ready(function() {
            loadProducts();
        });

        // 搜尋表單提交
        $('#searchForm').on('submit', function(e) {
            e.preventDefault();
            currentPage = 1;
            loadProducts();
        });

        // 載入商品列表
        function loadProducts() {
            const keyword = $('#keyword').val();
            const category = $('#category').val();
            const minPrice = $('#minPrice').val();
            const maxPrice = $('#maxPrice').val();

            $.ajax({
                url: '/api/store/products',
                method: 'GET',
                data: {
                    keyword: keyword,
                    categoryId: category,
                    minPrice: minPrice,
                    maxPrice: maxPrice,
                    page: currentPage,
                    pageSize: pageSize
                },
                success: function(response) {
                    if (response.success) {
                        renderProducts(response.data);
                        renderPagination(response.data);
                    } else {
                        showAlert('取得商品列表失敗', 'danger');
                    }
                },
                error: function() {
                    showAlert('網路錯誤，請稍後再試', 'danger');
                }
            });
        }

        // 渲染商品列表
        function renderProducts(data) {
            const container = $('#productsContainer');
            container.empty();

            if (data.items.length === 0) {
                container.html(`
                    <div class="col-12 text-center">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            沒有找到符合條件的商品
                        </div>
                    </div>
                `);
                return;
            }

            data.items.forEach(function(product) {
                const card = `
                    <div class="col-md-4 col-lg-3 mb-4">
                        <div class="card h-100 product-card" data-product-id="${product.productId}">
                            <div class="card-img-top bg-light text-center p-3" style="height: 200px;">
                                <i class="fas fa-gamepad fa-3x text-muted"></i>
                            </div>
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${product.productName}</h5>
                                <p class="card-text text-muted">${product.description || '商品描述'}</p>
                                <div class="mt-auto">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="h5 text-primary mb-0">NT$ ${product.price}</span>
                                        <button class="btn btn-outline-primary btn-sm" onclick="viewProduct(${product.productId})">
                                            <i class="fas fa-eye"></i> 查看
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.append(card);
            });
        }

        // 渲染分頁
        function renderPagination(data) {
            const pagination = $('#pagination');
            pagination.empty();

            if (data.totalPages <= 1) return;

            // 上一頁
            const prevDisabled = data.page <= 1 ? 'disabled' : '';
            pagination.append(`
                <li class="page-item ${prevDisabled}">
                    <a class="page-link" href="#" onclick="changePage(${data.page - 1})">上一頁</a>
                </li>
            `);

            // 頁碼
            for (let i = 1; i <= data.totalPages; i++) {
                const active = i === data.page ? 'active' : '';
                pagination.append(`
                    <li class="page-item ${active}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `);
            }

            // 下一頁
            const nextDisabled = data.page >= data.totalPages ? 'disabled' : '';
            pagination.append(`
                <li class="page-item ${nextDisabled}">
                    <a class="page-link" href="#" onclick="changePage(${data.page + 1})">下一頁</a>
                </li>
            `);
        }

        // 切換頁面
        function changePage(page) {
            currentPage = page;
            loadProducts();
            $('html, body').animate({ scrollTop: 0 }, 'slow');
        }

        // 查看商品詳情
        function viewProduct(productId) {
            $.ajax({
                url: `/api/store/products/${productId}`,
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        const product = response.data;
                        $('#productModalTitle').text(product.productName);
                        $('#productModalBody').html(`
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="bg-light text-center p-4" style="height: 300px;">
                                        <i class="fas fa-gamepad fa-5x text-muted"></i>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h4>${product.productName}</h4>
                                    <p class="text-muted">${product.description || '商品描述'}</p>
                                    <div class="mb-3">
                                        <span class="h3 text-primary">NT$ ${product.price}</span>
                                    </div>
                                    <div class="mb-3">
                                        <strong>庫存：</strong> ${product.shipmentQuantity} 件
                                    </div>
                                    <div class="mb-3">
                                        <strong>分類：</strong> ${product.productType}
                                    </div>
                                </div>
                            </div>
                        `);
                        $('#productModal').modal('show');
                    } else {
                        showAlert('取得商品詳情失敗', 'danger');
                    }
                },
                error: function() {
                    showAlert('網路錯誤，請稍後再試', 'danger');
                }
            });
        }

        // 加入購物車
        $('#addToCartBtn').on('click', function() {
            // 這裡實作加入購物車的邏輯
            showAlert('已加入購物車', 'success');
            $('#productModal').modal('hide');
        });

        // 顯示提示訊息
        function showAlert(message, type) {
            const alert = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            $('.container-fluid').prepend(alert);
        }
    </script>
}