@{
    ViewData["Title"] = "玩家市場 - GameCore";
}

<div class="container-fluid">
    <!-- 市場標題 -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4 text-center">
                <i class="fas fa-exchange-alt text-success"></i>
                玩家市場
            </h1>
            <p class="lead text-center text-muted">玩家間的自由交易平台</p>
        </div>
    </div>

    <!-- 操作按鈕 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button class="btn btn-success me-2" onclick="showSellModal()">
                        <i class="fas fa-plus"></i> 上架商品
                    </button>
                    <button class="btn btn-outline-primary" onclick="loadMyProducts()">
                        <i class="fas fa-list"></i> 我的商品
                    </button>
                </div>
                <div>
                    <button class="btn btn-outline-secondary" onclick="loadTransactions()">
                        <i class="fas fa-history"></i> 交易記錄
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 搜尋和篩選 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form id="searchForm" class="row g-3">
                        <div class="col-md-4">
                            <label for="keyword" class="form-label">關鍵字</label>
                            <input type="text" class="form-control" id="keyword" placeholder="搜尋商品...">
                        </div>
                        <div class="col-md-2">
                            <label for="category" class="form-label">分類</label>
                            <select class="form-select" id="category">
                                <option value="">全部</option>
                                <option value="game">遊戲</option>
                                <option value="hardware">硬體</option>
                                <option value="accessory">配件</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="minPrice" class="form-label">最低價格</label>
                            <input type="number" class="form-control" id="minPrice" placeholder="0">
                        </div>
                        <div class="col-md-2">
                            <label for="maxPrice" class="form-label">最高價格</label>
                            <input type="number" class="form-control" id="maxPrice" placeholder="9999">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search"></i> 搜尋
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 商品列表 -->
    <div class="row" id="productsContainer">
        <!-- 商品卡片將在這裡動態載入 -->
    </div>

    <!-- 分頁 -->
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="商品分頁">
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- 分頁將在這裡動態載入 -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- 上架商品 Modal -->
<div class="modal fade" id="sellModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">上架商品</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="sellForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="title" class="form-label">商品標題 *</label>
                                <input type="text" class="form-control" id="title" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">商品名稱 *</label>
                                <input type="text" class="form-control" id="name" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">商品描述</label>
                        <textarea class="form-control" id="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="price" class="form-label">價格 *</label>
                                <div class="input-group">
                                    <span class="input-group-text">NT$</span>
                                    <input type="number" class="form-control" id="price" required min="0">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productType" class="form-label">商品分類 *</label>
                                <select class="form-select" id="productType" required>
                                    <option value="">請選擇分類</option>
                                    <option value="game">遊戲</option>
                                    <option value="hardware">硬體</option>
                                    <option value="accessory">配件</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="submitSell()">
                    <i class="fas fa-upload"></i> 上架商品
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 商品詳情 Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalTitle">商品詳情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="productModalBody">
                <!-- 商品詳情將在這裡載入 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                <button type="button" class="btn btn-primary" id="purchaseBtn">
                    <i class="fas fa-shopping-cart"></i> 購買
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentPage = 1;
        let pageSize = 12;

        // 頁面載入時取得商品列表
        $(document).ready(function() {
            loadProducts();
        });

        // 搜尋表單提交
        $('#searchForm').on('submit', function(e) {
            e.preventDefault();
            currentPage = 1;
            loadProducts();
        });

        // 載入商品列表
        function loadProducts() {
            const keyword = $('#keyword').val();
            const category = $('#category').val();
            const minPrice = $('#minPrice').val();
            const maxPrice = $('#maxPrice').val();

            $.ajax({
                url: '/api/market/products',
                method: 'GET',
                data: {
                    keyword: keyword,
                    categoryId: category,
                    minPrice: minPrice,
                    maxPrice: maxPrice,
                    page: currentPage,
                    pageSize: pageSize
                },
                success: function(response) {
                    if (response.success) {
                        renderProducts(response.data);
                        renderPagination(response.data);
                    } else {
                        showAlert('取得商品列表失敗', 'danger');
                    }
                },
                error: function() {
                    showAlert('網路錯誤，請稍後再試', 'danger');
                }
            });
        }

        // 渲染商品列表
        function renderProducts(data) {
            const container = $('#productsContainer');
            container.empty();

            if (data.items.length === 0) {
                container.html(`
                    <div class="col-12 text-center">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            沒有找到符合條件的商品
                        </div>
                    </div>
                `);
                return;
            }

            data.items.forEach(function(product) {
                const card = `
                    <div class="col-md-4 col-lg-3 mb-4">
                        <div class="card h-100 product-card" data-product-id="${product.pProductId}">
                            <div class="card-img-top bg-light text-center p-3" style="height: 200px;">
                                <i class="fas fa-tag fa-3x text-success"></i>
                            </div>
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${product.pProductTitle}</h5>
                                <p class="card-text text-muted">${product.pProductDescription || '商品描述'}</p>
                                <div class="mt-auto">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="h5 text-success mb-0">NT$ ${product.price}</span>
                                        <button class="btn btn-outline-success btn-sm" onclick="viewProduct(${product.pProductId})">
                                            <i class="fas fa-eye"></i> 查看
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.append(card);
            });
        }

        // 渲染分頁
        function renderPagination(data) {
            const pagination = $('#pagination');
            pagination.empty();

            if (data.totalPages <= 1) return;

            // 上一頁
            const prevDisabled = data.page <= 1 ? 'disabled' : '';
            pagination.append(`
                <li class="page-item ${prevDisabled}">
                    <a class="page-link" href="#" onclick="changePage(${data.page - 1})">上一頁</a>
                </li>
            `);

            // 頁碼
            for (let i = 1; i <= data.totalPages; i++) {
                const active = i === data.page ? 'active' : '';
                pagination.append(`
                    <li class="page-item ${active}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `);
            }

            // 下一頁
            const nextDisabled = data.page >= data.totalPages ? 'disabled' : '';
            pagination.append(`
                <li class="page-item ${nextDisabled}">
                    <a class="page-link" href="#" onclick="changePage(${data.page + 1})">下一頁</a>
                </li>
            `);
        }

        // 切換頁面
        function changePage(page) {
            currentPage = page;
            loadProducts();
            $('html, body').animate({ scrollTop: 0 }, 'slow');
        }

        // 顯示上架商品 Modal
        function showSellModal() {
            $('#sellForm')[0].reset();
            $('#sellModal').modal('show');
        }

        // 提交上架商品
        function submitSell() {
            const formData = {
                title: $('#title').val(),
                name: $('#name').val(),
                description: $('#description').val(),
                price: parseFloat($('#price').val()),
                productType: $('#productType').val()
            };

            if (!formData.title || !formData.name || !formData.price || !formData.productType) {
                showAlert('請填寫所有必填欄位', 'warning');
                return;
            }

            $.ajax({
                url: '/api/market/products',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    if (response.success) {
                        showAlert('商品上架成功', 'success');
                        $('#sellModal').modal('hide');
                        loadProducts();
                    } else {
                        showAlert(response.message || '商品上架失敗', 'danger');
                    }
                },
                error: function() {
                    showAlert('網路錯誤，請稍後再試', 'danger');
                }
            });
        }

        // 查看商品詳情
        function viewProduct(productId) {
            $.ajax({
                url: `/api/market/products/${productId}`,
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        const product = response.data;
                        $('#productModalTitle').text(product.pProductTitle);
                        $('#productModalBody').html(`
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="bg-light text-center p-4" style="height: 300px;">
                                        <i class="fas fa-tag fa-5x text-success"></i>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h4>${product.pProductTitle}</h4>
                                    <p class="text-muted">${product.pProductDescription || '商品描述'}</p>
                                    <div class="mb-3">
                                        <span class="h3 text-success">NT$ ${product.price}</span>
                                    </div>
                                    <div class="mb-3">
                                        <strong>分類：</strong> ${product.pProductType}
                                    </div>
                                    <div class="mb-3">
                                        <strong>狀態：</strong> 
                                        <span class="badge bg-${product.pStatus === 'Active' ? 'success' : 'secondary'}">
                                            ${product.pStatus}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `);
                        $('#productModal').modal('show');
                    } else {
                        showAlert('取得商品詳情失敗', 'danger');
                    }
                },
                error: function() {
                    showAlert('網路錯誤，請稍後再試', 'danger');
                }
            });
        }

        // 購買商品
        $('#purchaseBtn').on('click', function() {
            // 這裡實作購買商品的邏輯
            showAlert('購買功能開發中', 'info');
            $('#productModal').modal('hide');
        });

        // 載入我的商品
        function loadMyProducts() {
            $.ajax({
                url: '/api/market/my-products',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        renderMyProducts(response.data);
                    } else {
                        showAlert('取得我的商品失敗', 'danger');
                    }
                },
                error: function() {
                    showAlert('網路錯誤，請稍後再試', 'danger');
                }
            });
        }

        // 渲染我的商品
        function renderMyProducts(products) {
            const container = $('#productsContainer');
            container.empty();

            if (products.length === 0) {
                container.html(`
                    <div class="col-12 text-center">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            您還沒有上架任何商品
                        </div>
                    </div>
                `);
                return;
            }

            products.forEach(function(product) {
                const card = `
                    <div class="col-md-4 col-lg-3 mb-4">
                        <div class="card h-100">
                            <div class="card-img-top bg-light text-center p-3" style="height: 200px;">
                                <i class="fas fa-tag fa-3x text-success"></i>
                            </div>
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${product.pProductTitle}</h5>
                                <p class="card-text text-muted">${product.pProductDescription || '商品描述'}</p>
                                <div class="mt-auto">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="h5 text-success mb-0">NT$ ${product.price}</span>
                                        <div>
                                            <button class="btn btn-outline-warning btn-sm me-1" onclick="editProduct(${product.pProductId})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" onclick="deleteProduct(${product.pProductId})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.append(card);
            });
        }

        // 載入交易記錄
        function loadTransactions() {
            $.ajax({
                url: '/api/market/transactions',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        renderTransactions(response.data);
                    } else {
                        showAlert('取得交易記錄失敗', 'danger');
                    }
                },
                error: function() {
                    showAlert('網路錯誤，請稍後再試', 'danger');
                }
            });
        }

        // 渲染交易記錄
        function renderTransactions(transactions) {
            const container = $('#productsContainer');
            container.empty();

            if (transactions.length === 0) {
                container.html(`
                    <div class="col-12 text-center">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            您還沒有任何交易記錄
                        </div>
                    </div>
                `);
                return;
            }

            const table = `
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">交易記錄</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>交易ID</th>
                                            <th>商品</th>
                                            <th>價格</th>
                                            <th>數量</th>
                                            <th>狀態</th>
                                            <th>日期</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${transactions.map(t => `
                                            <tr>
                                                <td>${t.pOrderId}</td>
                                                <td>${t.productName || '商品'}</td>
                                                <td>NT$ ${t.pUnitPrice}</td>
                                                <td>${t.pQuantity}</td>
                                                <td>
                                                    <span class="badge bg-${t.pOrderStatus === 'Completed' ? 'success' : 'warning'}">
                                                        ${t.pOrderStatus}
                                                    </span>
                                                </td>
                                                <td>${new Date(t.pOrderDate).toLocaleDateString()}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.html(table);
        }

        // 顯示提示訊息
        function showAlert(message, type) {
            const alert = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            $('.container-fluid').prepend(alert);
        }
    </script>
} 