@model GameCore.Core.ViewModels.CreatePostViewModel
@{
    ViewData["Title"] = "ç™¼è¡¨è²¼æ–‡";
    ViewData["ActivePage"] = "Forum";
}

<div class="container-fluid">
    <!-- é é¢æ¨™é¡Œå’Œå°èˆª -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="/Forum" class="text-decoration-none">
                            <i class="fas fa-comments"></i> è«–å£‡
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="/Forum/Posts/@Model?.ForumId" class="text-decoration-none">
                            @Model?.ForumName ?? "ç‰ˆé¢"
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        ç™¼è¡¨è²¼æ–‡
                    </li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="fas fa-plus text-primary"></i>
                        ç™¼è¡¨è²¼æ–‡
                    </h1>
                    <p class="text-muted mb-0">åœ¨ @(Model?.ForumName ?? "ç‰ˆé¢") ç™¼è¡¨æ–°è²¼æ–‡</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="/Forum/Posts/@Model?.ForumId" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> è¿”å›ç‰ˆé¢
                    </a>
                    <button type="button" class="btn btn-outline-info" onclick="previewPost()">
                        <i class="fas fa-eye"></i> é è¦½
                    </button>
                </div>
            </div>
        </div>
    </div>

    <form id="createPostForm" method="post">
        <div class="row">
            <!-- å·¦å´ï¼šå‰µå»ºè¡¨å–® -->
            <div class="col-lg-8 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-edit"></i>
                            è²¼æ–‡å…§å®¹
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- æ¨™é¡Œ -->
                        <div class="mb-3">
                            <label for="title" class="form-label">æ¨™é¡Œ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="title" name="Title" 
                                   placeholder="è¼¸å…¥è²¼æ–‡æ¨™é¡Œ..." required maxlength="200">
                            <div class="form-text">æ¨™é¡Œé•·åº¦ä¸èƒ½è¶…é 200 å­—å…ƒ</div>
                        </div>

                        <!-- å…§å®¹ -->
                        <div class="mb-3">
                            <label for="content" class="form-label">å…§å®¹ <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="content" name="Content" rows="15" 
                                      placeholder="è¼¸å…¥è²¼æ–‡å…§å®¹..." required></textarea>
                            <div class="form-text">æ”¯æ´ Markdown èªæ³•</div>
                        </div>

                        <!-- æ¨™ç±¤ -->
                        <div class="mb-3">
                            <label for="tags" class="form-label">æ¨™ç±¤</label>
                            <input type="text" class="form-control" id="tags" name="Tags" 
                                   placeholder="ç”¨é€—è™Ÿåˆ†éš”å¤šå€‹æ¨™ç±¤ï¼Œä¾‹å¦‚ï¼šæ”»ç•¥, å¿ƒå¾—, å•é¡Œ">
                            <div class="form-text">æ¨™ç±¤å¯ä»¥å¹«åŠ©å…¶ä»–ç”¨æˆ¶æ›´å®¹æ˜“æ‰¾åˆ°æ‚¨çš„è²¼æ–‡</div>
                        </div>

                        <!-- è²¼æ–‡é¡å‹ -->
                        <div class="mb-3">
                            <label for="type" class="form-label">è²¼æ–‡é¡å‹</label>
                            <select class="form-select" id="type" name="Type">
                                <option value="discussion" selected>è¨è«–</option>
                                <option value="question">å•é¡Œ</option>
                                <option value="guide">æ”»ç•¥</option>
                                <option value="share">åˆ†äº«</option>
                                <option value="announcement">å…¬å‘Š</option>
                            </select>
                        </div>

                        <!-- ç·¨è¼¯å·¥å…· -->
                        <div class="mb-3">
                            <label class="form-label">ç·¨è¼¯å·¥å…·</label>
                            <div class="d-flex flex-wrap gap-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertMarkdown('**ç²—é«”**')">
                                    <strong>B</strong>
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertMarkdown('*æ–œé«”*')">
                                    <em>I</em>
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertMarkdown('[é€£çµ](URL)')">
                                    ğŸ”—
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertMarkdown('![åœ–ç‰‡](URL)')">
                                    ğŸ–¼ï¸
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertMarkdown('`ç¨‹å¼ç¢¼`')">
                                    <code>Code</code>
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertMarkdown('```\nç¨‹å¼ç¢¼å€å¡Š\n```')">
                                    ğŸ“
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertMarkdown('- åˆ—è¡¨é …ç›®')">
                                    ğŸ“‹
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertMarkdown('> å¼•ç”¨æ–‡å­—')">
                                    ğŸ’¬
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertMarkdown('# æ¨™é¡Œ')">
                                    H1
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertMarkdown('## æ¨™é¡Œ')">
                                    H2
                                </button>
                            </div>
                        </div>

                        <!-- æäº¤é¸é … -->
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="notifyFollowers" name="NotifyFollowers" checked>
                                        <label class="form-check-label" for="notifyFollowers">
                                            é€šçŸ¥é—œæ³¨è€…
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="allowReplies" name="AllowReplies" checked>
                                        <label class="form-check-label" for="allowReplies">
                                            å…è¨±å›è¦†
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æäº¤æŒ‰éˆ• -->
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-warning" onclick="saveAsDraft()">
                                    <i class="fas fa-save"></i> å„²å­˜è‰ç¨¿
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="loadDraft()">
                                    <i class="fas fa-folder-open"></i> è¼‰å…¥è‰ç¨¿
                                </button>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                    <i class="fas fa-undo"></i> é‡ç½®
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i> ç™¼è¡¨è²¼æ–‡
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³å´ï¼šé è¦½å’Œè³‡è¨Š -->
            <div class="col-lg-4 mb-4">
                <!-- é è¦½å€åŸŸ -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-eye"></i>
                            é è¦½
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="previewContent" class="preview-content">
                            <p class="text-muted text-center">é»æ“Šé è¦½æŒ‰éˆ•æŸ¥çœ‹æ•ˆæœ</p>
                        </div>
                    </div>
                </div>

                <!-- ç‰ˆé¢è³‡è¨Š -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-folder"></i>
                            ç‰ˆé¢è³‡è¨Š
                        </h5>
                    </div>
                    <div class="card-body">
                        <h6 class="mb-2">@Model?.ForumName</h6>
                        <p class="text-muted small mb-3">@Model?.ForumDescription</p>
                        <div class="forum-stats">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="stat-item">
                                        <h6 class="text-primary mb-1">@(Model?.ForumPostCount ?? 0)</h6>
                                        <small class="text-muted">è²¼æ–‡</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-item">
                                        <h6 class="text-success mb-1">@(Model?.ForumReplyCount ?? 0)</h6>
                                        <small class="text-muted">å›è¦†</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-item">
                                        <h6 class="text-info mb-1">@(Model?.ForumSubscriberCount ?? 0)</h6>
                                        <small class="text-muted">è¨‚é–±</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç™¼æ–‡æŒ‡å— -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-lightbulb"></i>
                            ç™¼æ–‡æŒ‡å—
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="posting-guidelines">
                            <div class="mb-2">
                                <strong>âœ… å»ºè­°ï¼š</strong>
                                <ul class="small text-muted mb-0">
                                    <li>ä½¿ç”¨æ¸…æ™°çš„æ¨™é¡Œ</li>
                                    <li>å…§å®¹è¦æœ‰åƒ¹å€¼</li>
                                    <li>é©ç•¶ä½¿ç”¨æ¨™ç±¤</li>
                                    <li>éµå®ˆç‰ˆé¢è¦å‰‡</li>
                                </ul>
                            </div>
                            <div class="mb-2">
                                <strong>âŒ é¿å…ï¼š</strong>
                                <ul class="small text-muted mb-0">
                                    <li>ç„¡æ„ç¾©çš„å…§å®¹</li>
                                    <li>é‡è¤‡ç™¼æ–‡</li>
                                    <li>æƒ¡æ„çŒæ°´</li>
                                    <li>é•åç‰ˆè¦</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å¿«é€Ÿæ“ä½œ -->
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-tools"></i>
                            å¿«é€Ÿæ“ä½œ
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertTemplate('question')">
                                <i class="fas fa-question-circle"></i> å•é¡Œæ¨¡æ¿
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertTemplate('guide')">
                                <i class="fas fa-book"></i> æ”»ç•¥æ¨¡æ¿
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertTemplate('share')">
                                <i class="fas fa-share-alt"></i> åˆ†äº«æ¨¡æ¿
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- é è¦½ Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">
                    <i class="fas fa-eye"></i> è²¼æ–‡é è¦½
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="modalPreviewContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .preview-content {
            min-height: 200px;
            border: 1px dashed #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            background-color: #f8f9fc;
        }

        .preview-content.preview-loaded {
            border: 1px solid #dee2e6;
            background-color: white;
        }

        .posting-guidelines ul {
            padding-left: 1rem;
            margin-bottom: 0;
        }

        .posting-guidelines li {
            margin-bottom: 0.25rem;
        }

        .stat-item h6 {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .stat-item small {
            font-size: 0.75rem;
        }

        .card-header {
            background-color: #f8f9fc;
            border-bottom: 1px solid #e3e6f0;
        }

        .breadcrumb {
            background-color: transparent;
            padding: 0;
            margin-bottom: 1rem;
        }

        .breadcrumb-item a {
            color: #007bff;
        }

        .breadcrumb-item.active {
            color: #6c757d;
        }

        .btn-sm {
            font-size: 0.8rem;
            padding: 0.375rem 0.5rem;
        }

        /* Markdown é è¦½æ¨£å¼ */
        .markdown-preview h1, .markdown-preview h2, .markdown-preview h3,
        .markdown-preview h4, .markdown-preview h5, .markdown-preview h6 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .markdown-preview p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .markdown-preview code {
            background-color: #f8f9fc;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
        }

        .markdown-preview pre {
            background-color: #f8f9fc;
            padding: 1rem;
            border-radius: 0.375rem;
            overflow-x: auto;
        }

        .markdown-preview blockquote {
            border-left: 4px solid #dee2e6;
            padding-left: 1rem;
            margin-left: 0;
            color: #6c757d;
        }

        .markdown-preview ul, .markdown-preview ol {
            margin-bottom: 1rem;
            padding-left: 2rem;
        }

        .markdown-preview img {
            max-width: 100%;
            height: auto;
            border-radius: 0.375rem;
        }

        .markdown-preview a {
            color: #007bff;
            text-decoration: none;
        }

        .markdown-preview a:hover {
            text-decoration: underline;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 767.98px) {
            .d-flex.flex-wrap {
                flex-direction: column;
            }
            
            .d-flex.flex-wrap .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .d-flex.justify-content-between {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
}

@section Scripts {
    <script>
        let currentForumId = @(Model?.ForumId ?? 0);

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è¡¨å–®æäº¤
            document.getElementById('createPostForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitPost();
            });

            // è‡ªå‹•å„²å­˜è‰ç¨¿
            setInterval(autoSaveDraft, 30000); // æ¯30ç§’è‡ªå‹•å„²å­˜

            // è¼‰å…¥ä¸Šæ¬¡çš„è‰ç¨¿
            loadLastDraft();
        });

        // é è¦½è²¼æ–‡
        function previewPost() {
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const tags = document.getElementById('tags').value;
            const type = document.getElementById('type').value;

            if (!title.trim() || !content.trim()) {
                showToast('è«‹å…ˆå¡«å¯«æ¨™é¡Œå’Œå…§å®¹', 'warning');
                return;
            }

            // æ›´æ–°é è¦½å€åŸŸ
            updatePreview(title, content, tags, type);

            // é¡¯ç¤ºé è¦½ Modal
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            modal.show();
        }

        // æ›´æ–°é è¦½å…§å®¹
        function updatePreview(title, content, tags, type) {
            const previewContent = document.getElementById('previewContent');
            const modalPreviewContent = document.getElementById('modalPreviewContent');

            const previewHtml = generatePreviewHtml(title, content, tags, type);

            previewContent.innerHTML = previewHtml;
            previewContent.classList.add('preview-loaded');
            modalPreviewContent.innerHTML = previewHtml;
        }

        // ç”Ÿæˆé è¦½ HTML
        function generatePreviewHtml(title, content, tags, type) {
            let html = `
                <div class="markdown-preview">
                    <h1>${title}</h1>
                    <div class="mb-3">
                        <span class="badge bg-primary me-2">${type}</span>
                        ${tags ? tags.split(',').map(tag => `<span class="badge bg-light text-dark me-1">${tag.trim()}</span>`).join('') : ''}
                    </div>
                    <div class="content-preview">
                        ${content.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `;
            return html;
        }

        // æ’å…¥ Markdown
        function insertMarkdown(markdown) {
            const textarea = document.getElementById('content');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const selectedText = text.substring(start, end);
            
            let newText;
            if (markdown.includes('**') && selectedText) {
                newText = `**${selectedText}**`;
            } else if (markdown.includes('*') && selectedText) {
                newText = `*${selectedText}*`;
            } else if (markdown.includes('[') && selectedText) {
                newText = `[${selectedText}](URL)`;
            } else if (markdown.includes('![') && selectedText) {
                newText = `![${selectedText}](URL)`;
            } else if (markdown.includes('`') && selectedText) {
                newText = `\`${selectedText}\``;
            } else if (markdown.includes('```')) {
                newText = '```\nç¨‹å¼ç¢¼å€å¡Š\n```';
            } else if (markdown.includes('- ')) {
                newText = '- åˆ—è¡¨é …ç›®';
            } else if (markdown.includes('> ')) {
                newText = '> å¼•ç”¨æ–‡å­—';
            } else if (markdown.includes('# ')) {
                newText = '# æ¨™é¡Œ';
            } else if (markdown.includes('## ')) {
                newText = '## æ¨™é¡Œ';
            } else {
                newText = markdown;
            }
            
            textarea.value = text.substring(0, start) + newText + text.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + newText.length, start + newText.length);
        }

        // æ’å…¥æ¨¡æ¿
        function insertTemplate(templateType) {
            const textarea = document.getElementById('content');
            let template = '';

            switch (templateType) {
                case 'question':
                    template = `## å•é¡Œæè¿°

è«‹è©³ç´°æè¿°æ‚¨é‡åˆ°çš„å•é¡Œï¼š

## ç’°å¢ƒè³‡è¨Š

- éŠæˆ²ç‰ˆæœ¬ï¼š
- ä½œæ¥­ç³»çµ±ï¼š
- å…¶ä»–ç›¸é—œè³‡è¨Šï¼š

## å·²å˜—è©¦çš„è§£æ±ºæ–¹æ¡ˆ

è«‹åˆ—å‡ºæ‚¨å·²ç¶“å˜—è©¦éçš„è§£æ±ºæ–¹æ³•ï¼š

## æœŸæœ›çµæœ

è«‹æè¿°æ‚¨æœŸæœ›é”åˆ°çš„æ•ˆæœï¼š`;
                    break;
                case 'guide':
                    template = `## æ”»ç•¥æ¦‚è¿°

ç°¡è¦èªªæ˜æ­¤æ”»ç•¥çš„å…§å®¹å’Œé©ç”¨å°è±¡ï¼š

## å‰ç½®æ¢ä»¶

å®Œæˆæ­¤æ”»ç•¥éœ€è¦çš„å‰ç½®æ¢ä»¶ï¼š

## è©³ç´°æ­¥é©Ÿ

### æ­¥é©Ÿ 1
è©³ç´°èªªæ˜ç¬¬ä¸€å€‹æ­¥é©Ÿ

### æ­¥é©Ÿ 2
è©³ç´°èªªæ˜ç¬¬äºŒå€‹æ­¥é©Ÿ

## æ³¨æ„äº‹é …

è«‹æ³¨æ„ä»¥ä¸‹å¹¾é»ï¼š

## ç¸½çµ

æ”»ç•¥çš„ç¸½çµå’Œå¿ƒå¾—ï¼š`;
                    break;
                case 'share':
                    template = `## åˆ†äº«å…§å®¹

ç°¡è¦èªªæ˜æ‚¨è¦åˆ†äº«çš„å…§å®¹ï¼š

## è©³ç´°ä»‹ç´¹

è©³ç´°ä»‹ç´¹æ‚¨è¦åˆ†äº«çš„å…§å®¹ï¼š

## å€‹äººå¿ƒå¾—

åˆ†äº«æ‚¨çš„å€‹äººå¿ƒå¾—å’Œé«”æœƒï¼š

## ç›¸é—œé€£çµ

å¦‚æœæœ‰ç›¸é—œçš„é€£çµæˆ–è³‡æºï¼Œå¯ä»¥åœ¨é€™è£¡åˆ†äº«ï¼š

## çµèª

ç¸½çµæ‚¨çš„åˆ†äº«ï¼š`;
                    break;
            }

            if (template) {
                textarea.value = template;
                textarea.focus();
                showToast('æ¨¡æ¿å·²æ’å…¥', 'success');
            }
        }

        // é‡ç½®è¡¨å–®
        function resetForm() {
            if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰å…§å®¹å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                document.getElementById('title').value = '';
                document.getElementById('content').value = '';
                document.getElementById('tags').value = '';
                document.getElementById('type').value = 'discussion';
                document.getElementById('notifyFollowers').checked = true;
                document.getElementById('allowReplies').checked = true;
                
                // é‡ç½®é è¦½
                const previewContent = document.getElementById('previewContent');
                previewContent.innerHTML = '<p class="text-muted text-center">é»æ“Šé è¦½æŒ‰éˆ•æŸ¥çœ‹æ•ˆæœ</p>';
                previewContent.classList.remove('preview-loaded');
                
                showToast('è¡¨å–®å·²é‡ç½®', 'info');
            }
        }

        // è‡ªå‹•å„²å­˜è‰ç¨¿
        function autoSaveDraft() {
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const tags = document.getElementById('tags').value;
            const type = document.getElementById('type').value;

            if (title.trim() || content.trim()) {
                const draft = {
                    forumId: currentForumId,
                    title: title,
                    content: content,
                    tags: tags,
                    type: type,
                    timestamp: new Date().toISOString()
                };

                localStorage.setItem('forumPostDraft', JSON.stringify(draft));
            }
        }

        // å„²å­˜è‰ç¨¿
        function saveAsDraft() {
            autoSaveDraft();
            showToast('è‰ç¨¿å·²å„²å­˜', 'success');
        }

        // è¼‰å…¥è‰ç¨¿
        function loadDraft() {
            const draft = localStorage.getItem('forumPostDraft');
            if (draft) {
                try {
                    const draftData = JSON.parse(draft);
                    
                    // æª¢æŸ¥æ˜¯å¦ç‚ºç•¶å‰ç‰ˆé¢çš„è‰ç¨¿
                    if (draftData.forumId === currentForumId) {
                        document.getElementById('title').value = draftData.title || '';
                        document.getElementById('content').value = draftData.content || '';
                        document.getElementById('tags').value = draftData.tags || '';
                        document.getElementById('type').value = draftData.type || 'discussion';
                        
                        showToast('è‰ç¨¿å·²è¼‰å…¥', 'success');
                    } else {
                        showToast('æ²’æœ‰æ‰¾åˆ°ç•¶å‰ç‰ˆé¢çš„è‰ç¨¿', 'info');
                    }
                } catch (error) {
                    showToast('è¼‰å…¥è‰ç¨¿å¤±æ•—', 'error');
                }
            } else {
                showToast('æ²’æœ‰æ‰¾åˆ°è‰ç¨¿', 'info');
            }
        }

        // è¼‰å…¥ä¸Šæ¬¡çš„è‰ç¨¿
        function loadLastDraft() {
            const draft = localStorage.getItem('forumPostDraft');
            if (draft) {
                try {
                    const draftData = JSON.parse(draft);
                    if (draftData.forumId === currentForumId && (draftData.title.trim() || draftData.content.trim())) {
                        if (confirm('ç™¼ç¾æœªå®Œæˆçš„è‰ç¨¿ï¼Œæ˜¯å¦è¦è¼‰å…¥ï¼Ÿ')) {
                            loadDraft();
                        }
                    }
                } catch (error) {
                    console.error('Error loading last draft:', error);
                }
            }
        }

        // æäº¤è²¼æ–‡
        function submitPost() {
            const title = document.getElementById('title').value.trim();
            const content = document.getElementById('content').value.trim();
            const tags = document.getElementById('tags').value.trim();
            const type = document.getElementById('type').value;
            const notifyFollowers = document.getElementById('notifyFollowers').checked;
            const allowReplies = document.getElementById('allowReplies').checked;

            if (!title) {
                showToast('è«‹è¼¸å…¥æ¨™é¡Œ', 'warning');
                document.getElementById('title').focus();
                return;
            }

            if (!content) {
                showToast('è«‹è¼¸å…¥å…§å®¹', 'warning');
                document.getElementById('content').focus();
                return;
            }

            // æäº¤è¡¨å–®
            fetch('/api/forum/post/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    forumId: currentForumId,
                    title: title,
                    content: content,
                    tags: tags ? tags.split(',').map(t => t.trim()).filter(t => t) : [],
                    type: type,
                    notifyFollowers: notifyFollowers,
                    allowReplies: allowReplies
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('è²¼æ–‡ç™¼è¡¨æˆåŠŸ', 'success');
                    // æ¸…é™¤è‰ç¨¿
                    localStorage.removeItem('forumPostDraft');
                    // è·³è½‰åˆ°è²¼æ–‡é é¢
                    setTimeout(() => {
                        window.location.href = `/Forum/Post/${data.data.postId}`;
                    }, 1500);
                } else {
                    showToast(`ç™¼è¡¨å¤±æ•—ï¼š${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('ç™¼è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
            });
        }

        // é¡¯ç¤ºæç¤ºè¨Šæ¯
        function showToast(message, type = 'info') {
            if (type === 'success') {
                alert('âœ… ' + message);
            } else if (type === 'error') {
                alert('âŒ ' + message);
            } else if (type === 'warning') {
                alert('âš ï¸ ' + message);
            } else {
                alert(message);
            }
        }

        // é é¢é›¢é–‹å‰æé†’å„²å­˜
        window.addEventListener('beforeunload', function(e) {
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            
            if (title.trim() || content.trim()) {
                e.preventDefault();
                e.returnValue = 'æ‚¨æœ‰æœªå„²å­˜çš„å…§å®¹ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ';
                return 'æ‚¨æœ‰æœªå„²å­˜çš„å…§å®¹ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ';
            }
        });
    </script>
}